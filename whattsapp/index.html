<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>واٹس ایپ کلون</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        wa: {
                            primary: '#008069', 
                            dark: '#111b21',    
                            header: '#202c33',  
                            chat_bg: '#0b141a', 
                            chat_me: '#d9fdd3', 
                            chat_other: '#ffffff', 
                            chat_dark_me: '#005c4b',
                            chat_dark_other: '#202c33',
                            accent: '#25d366',
                            select_overlay: 'rgba(0, 168, 132, 0.2)'
                        }
                    },
                    fontFamily: {
                        urdu: ['Noto Nastaliq Urdu', 'serif'],
                        sans: ['Noto Sans Arabic', 'sans-serif']
                    },
                    backgroundImage: {
                        'chat-pattern-light': "url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png')",
                        'chat-pattern-dark': "url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png')"
                    }
                }
            }
        }
    </script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Noto Sans Arabic', sans-serif; -webkit-tap-highlight-color: transparent; }
        .urdu-text { font-family: 'Noto Nastaliq Urdu', serif; line-height: 2.2; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .btn-press:active { transform: scale(0.96); }

        /* Custom Scrollbar for Desktop */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); }

        /* Animations */
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes slideOutRight { from { transform: translateX(0); } to { transform: translateX(100%); } }
        @keyframes pulse-ring { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(1.2); opacity: 0; } }
        
        .slide-in { animation: slideInRight 0.2s ease-out forwards; }
        .slide-out { animation: slideOutRight 0.2s ease-in forwards; }
        
        .call-pulse { animation: pulse-ring 2s infinite; }
        .msg-selected { background-color: rgba(0, 168, 132, 0.15) !important; }

        /* Ticks */
        .tick-read { color: #53bdeb; }
        .tick-sent { color: #8696a0; }
        
        /* Chat BG */
        .bg-chat-light { background-color: #efeae2; }
        .bg-chat-dark { background-color: #0b141a; }
        .dark .bg-chat-pattern { opacity: 0.06; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-[#090e11] h-[100dvh] w-full overflow-hidden text-gray-800 dark:text-gray-100">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 z-[100] bg-white/90 dark:bg-black/90 flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-wa-primary border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="font-bold text-wa-primary urdu-text" id="loadingText">براہ کرم انتظار کریں...</p>
    </div>

    <!-- ================= AUTH SCREENS ================= -->
    <div id="authScreen" class="absolute inset-0 z-50 bg-white dark:bg-wa-dark flex flex-col items-center justify-center p-6">
        <div class="w-full max-w-md bg-white dark:bg-wa-header md:shadow-2xl md:rounded-xl p-8 flex flex-col items-center border border-transparent dark:border-gray-800">
            <div class="mb-8 flex flex-col items-center">
                <div class="w-20 h-20 bg-wa-primary rounded-2xl flex items-center justify-center text-white text-4xl mb-4 shadow-lg">
                    <i class="fab fa-whatsapp"></i>
                </div>
                <h1 class="text-2xl font-bold text-wa-primary mb-1 urdu-text">واٹس ایپ</h1>
            </div>
            
            <div class="flex w-full mb-6 bg-gray-100 dark:bg-gray-900 p-1 rounded-lg">
                <button onclick="toggleAuthMode('login')" id="tabLogin" class="flex-1 py-2 text-sm font-bold rounded-md bg-white dark:bg-gray-700 shadow text-wa-primary transition-all">لاگ ان</button>
                <button onclick="toggleAuthMode('signup')" id="tabSignup" class="flex-1 py-2 text-sm font-bold rounded-md text-gray-500 transition-all">اکاؤنٹ بنائیں</button>
            </div>

            <div id="loginForm" class="w-full space-y-4 animate-fade-in">
                <input type="email" id="loginEmail" placeholder="ای میل" class="w-full bg-gray-50 dark:bg-gray-800 px-4 py-3 rounded-lg border border-gray-200 dark:border-gray-700 outline-none text-sm" dir="ltr">
                <input type="password" id="loginPass" placeholder="پاسورڈ" class="w-full bg-gray-50 dark:bg-gray-800 px-4 py-3 rounded-lg border border-gray-200 dark:border-gray-700 outline-none text-sm" dir="ltr">
                <button onclick="authAction('login')" class="w-full bg-wa-primary text-white py-3 rounded-lg font-bold shadow-lg btn-press mt-2">لاگ ان کریں</button>
            </div>

            <div id="signupForm" class="hidden w-full space-y-4 animate-fade-in">
                <input type="text" id="signupName" placeholder="آپ کا نام" class="w-full bg-gray-50 dark:bg-gray-800 px-4 py-3 rounded-lg border border-gray-200 dark:border-gray-700 outline-none text-sm urdu-text">
                <input type="email" id="signupEmail" placeholder="ای میل" class="w-full bg-gray-50 dark:bg-gray-800 px-4 py-3 rounded-lg border border-gray-200 dark:border-gray-700 outline-none text-sm" dir="ltr">
                <input type="password" id="signupPass" placeholder="پاسورڈ" class="w-full bg-gray-50 dark:bg-gray-800 px-4 py-3 rounded-lg border border-gray-200 dark:border-gray-700 outline-none text-sm" dir="ltr">
                <button onclick="authAction('signup')" class="w-full bg-wa-primary text-white py-3 rounded-lg font-bold shadow-lg btn-press mt-2">اکاؤنٹ بنائیں</button>
            </div>
        </div>
    </div>

    <!-- ================= MAIN APP LAYOUT ================= -->
    <div id="mainApp" class="hidden w-full h-full flex overflow-hidden bg-white dark:bg-wa-dark xl:max-w-[1600px] mx-auto xl:shadow-2xl xl:my-0 xl:h-full">
        
        <!-- LEFT SIDEBAR (Chat List) -->
        <div id="leftSidebar" class="w-full md:w-[400px] flex flex-col border-r dark:border-gray-700 bg-white dark:bg-wa-dark z-20 transition-all duration-300">
            
            <!-- Header -->
            <header class="bg-wa-primary dark:bg-wa-header text-white flex-shrink-0 px-4 py-3 flex justify-between items-center shadow-md z-30">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gray-300 overflow-hidden cursor-pointer" onclick="openProfileModal()">
                         <div id="sidebarAvatar" class="w-full h-full flex items-center justify-center text-gray-600 font-bold bg-gray-200 text-lg">U</div>
                    </div>
                    <h1 class="text-lg font-bold hidden md:block">WhatsApp</h1>
                </div>
                
                <div class="flex gap-5 text-lg items-center relative">
                    <button onclick="toggleTheme()" class="opacity-80 hover:opacity-100" title="Theme"><i class="far fa-moon"></i></button>
                    <button onclick="openNewChatModal()" class="opacity-80 hover:opacity-100" title="New Chat"><i class="fas fa-plus"></i></button>
                    
                    <div class="relative">
                        <button onclick="toggleMenu()" class="opacity-80 hover:opacity-100"><i class="fas fa-ellipsis-v"></i></button>
                        <div id="mainMenu" class="fixed top-14 left-4 (ltr:right-4 rtl:left-4) w-48 bg-white dark:bg-wa-header shadow-xl rounded-lg hidden py-2 text-gray-800 dark:text-gray-200 text-sm z-[100] border dark:border-gray-700">
                            <div onclick="openCreateGroupModal()" class="px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer">نیا گروپ</div>
                            <div onclick="openProfileModal()" class="px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer">سیٹنگز</div>
                            <div onclick="signOutApp()" class="px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer text-red-500">لاگ آؤٹ</div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Tabs -->
            <div class="flex text-center uppercase text-xs font-bold bg-wa-primary dark:bg-wa-header text-gray-200 shadow-sm z-20">
                <div onclick="switchTab('chats')" id="tab-chats" class="flex-1 py-3 border-b-[3px] border-white text-white cursor-pointer transition-colors hover:bg-white/10">چیٹس</div>
                <div onclick="switchTab('calls')" id="tab-calls" class="flex-1 py-3 border-b-[3px] border-transparent text-gray-300 hover:text-white cursor-pointer transition-colors hover:bg-white/10">کالز</div>
            </div>

            <!-- Content Area -->
            <div class="flex-1 overflow-y-auto relative bg-white dark:bg-wa-dark custom-scrollbar">
                <div id="viewChats"><div id="chatList" class="pb-20"></div></div>
                <div id="viewCalls" class="hidden p-4">
                    <div class="flex items-center gap-4 mb-6 cursor-pointer hover:bg-gray-50 dark:hover:bg-white/5 p-2 rounded-lg transition">
                        <div class="w-12 h-12 rounded-full bg-wa-primary flex items-center justify-center text-white transform -rotate-45 shadow-sm">
                            <i class="fas fa-link"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-sm">کال لنک بنائیں</h3>
                            <p class="text-xs text-gray-500">واٹس ایپ کال کا لنک شیئر کریں</p>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 font-bold mb-3 px-2">حالیہ کالز</p>
                    <div id="callsList" class="space-y-2">
                        <div class="text-center text-xs text-gray-400 mt-10 opacity-60">کوئی حالیہ کال نہیں</div>
                    </div>
                </div>
            </div>
            
            <button onclick="openNewChatModal()" class="md:hidden absolute bottom-6 left-6 w-14 h-14 bg-wa-primary text-white rounded-2xl shadow-lg flex items-center justify-center text-xl btn-press z-30">
                <i class="fas fa-comment-alt"></i>
            </button>
        </div>

        <!-- RIGHT SIDE (Chat Room) -->
        <div class="hidden md:flex flex-1 flex-col relative bg-chat-light dark:bg-chat-bg bg-chat-pattern-light dark:bg-chat-pattern-dark">
            
            <!-- Default Placeholder -->
            <div id="desktopPlaceholder" class="flex flex-col items-center justify-center h-full w-full text-center p-10 border-b-[6px] border-wa-accent">
                <div class="mb-8 opacity-80"><i class="fab fa-whatsapp text-[100px] text-gray-300 dark:text-gray-600"></i></div>
                <h1 class="text-3xl font-light text-gray-600 dark:text-gray-200 mb-4">WhatsApp Web</h1>
                <div class="mt-10 text-xs text-gray-400 flex items-center gap-2"><i class="fas fa-lock"></i> End-to-end encrypted</div>
            </div>

            <!-- ACTIVE CHAT ROOM -->
            <div id="chatRoom" class="hidden fixed inset-0 z-[80] md:static md:z-0 md:flex flex-col h-full bg-chat-light dark:bg-chat-bg justify-start">
                <div class="absolute inset-0 z-0 opacity-40 dark:opacity-5 bg-chat-pattern-light dark:bg-chat-pattern-dark pointer-events-none"></div>

                <!-- Normal Header -->
                <div id="chatHeaderNormal" class="bg-wa-primary dark:bg-wa-header text-white px-4 py-2 flex items-center justify-between shadow z-10 relative flex-shrink-0 w-full">
                    <div class="flex items-center gap-3">
                        <button onclick="closeChatRoom()" class="md:hidden p-1 mr-1"><i class="fas fa-arrow-right"></i></button>
                        <div class="w-10 h-10 rounded-full bg-gray-300 overflow-hidden cursor-pointer">
                            <div id="chatHeaderAvatar" class="w-full h-full flex items-center justify-center text-gray-600 font-bold bg-gray-200">U</div>
                        </div>
                        <div class="flex flex-col cursor-pointer">
                            <h2 id="chatHeaderTitle" class="font-bold text-base leading-tight truncate max-w-[150px] md:max-w-xs">User</h2>
                            <p class="text-[11px] opacity-80 truncate" id="chatHeaderStatus">tap for info</p>
                        </div>
                    </div>
                    <div class="flex gap-5 text-lg items-center">
                        <button onclick="startAudioCall()" class="hover:opacity-80 p-1"><i class="fas fa-phone-alt"></i></button>
                        <button class="hover:opacity-80 hidden md:block"><i class="fas fa-search"></i></button>
                        <button class="hover:opacity-80"><i class="fas fa-ellipsis-v"></i></button>
                    </div>
                </div>

                <!-- Selection Header (Hidden by default) -->
                <div id="chatHeaderSelection" class="hidden bg-wa-primary dark:bg-wa-header text-white px-4 py-2 flex items-center justify-between shadow z-10 relative flex-shrink-0 w-full animate-fade-in">
                    <div class="flex items-center gap-6">
                        <button onclick="clearSelection()" class="p-1"><i class="fas fa-arrow-right"></i></button>
                        <h2 class="font-bold text-xl" id="selectionCount">1</h2>
                    </div>
                    <div class="flex gap-6 text-lg items-center">
                        <button onclick="editSelectedMessage()" id="btnEditMsg" class="hover:opacity-80 p-1 hidden"><i class="fas fa-pen"></i></button>
                        <button onclick="deleteSelectedMessages()" class="hover:opacity-80 p-1"><i class="fas fa-trash"></i></button>
                        <button class="hover:opacity-80 p-1"><i class="fas fa-copy"></i></button>
                    </div>
                </div>

                <!-- Messages -->
                <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-1 relative z-10 custom-scrollbar w-full"></div>

                <!-- Input -->
                <div class="bg-gray-100 dark:bg-wa-header p-2 md:px-4 flex items-end gap-2 z-20 shadow-inner relative flex-shrink-0 w-full">
                    <button class="p-3 text-gray-500 hover:text-gray-700 dark:text-gray-400"><i class="far fa-smile text-xl"></i></button>
                    
                    <div class="flex-1 bg-white dark:bg-[#2a3942] rounded-lg flex items-center border border-white dark:border-none shadow-sm px-2 py-1 min-h-[45px]">
                        <textarea id="msgInput" rows="1" placeholder="پیغام لکھیں..." class="flex-1 bg-transparent p-2 outline-none max-h-32 resize-none urdu-text dark:text-white" oninput="autoResize(this)"></textarea>
                    </div>
                    
                    <!-- Mobile Send Fix: Added ontouchstart and type='button' -->
                    <button type="button" onmousedown="handleSendPress(event)" ontouchstart="handleSendPress(event)" class="p-3 rounded-full text-gray-500 hover:text-wa-primary dark:text-gray-400 transition-colors z-50 select-none">
                        <i class="fas fa-microphone text-xl" id="sendIcon"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (New Chat, Create Group, Profile, Call) -->
    <!-- (Using existing structure for modals) -->
    <div id="newChatModal" class="hidden fixed inset-0 z-[90] bg-black/50 flex justify-center items-center p-4">
        <div class="bg-white dark:bg-wa-header w-full max-w-md rounded-xl shadow-2xl flex flex-col max-h-[80vh] overflow-hidden">
            <div class="bg-wa-primary dark:bg-wa-header text-white p-4 flex items-center gap-4 shadow z-10">
                <button onclick="closeModal('newChatModal')"><i class="fas fa-arrow-right"></i></button>
                <div class="flex-1">
                    <h2 class="font-bold text-lg">نیا رابطہ</h2>
                    <p class="text-xs opacity-80" id="contactsCount">...</p>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-2 bg-white dark:bg-wa-dark custom-scrollbar">
                <div onclick="openCreateGroupModal()" class="flex items-center gap-4 p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded-lg">
                    <div class="w-10 h-10 rounded-full bg-wa-primary text-white flex items-center justify-center"><i class="fas fa-users"></i></div>
                    <p class="font-bold dark:text-gray-200">نیا گروپ بنائیں</p>
                </div>
                <div id="contactsList" class="space-y-1 mt-2"></div>
            </div>
        </div>
    </div>

    <div id="createGroupModal" class="hidden fixed inset-0 z-[95] bg-black/50 flex justify-center items-center p-4">
        <div class="bg-white dark:bg-wa-header w-full max-w-md rounded-xl shadow-2xl flex flex-col max-h-[80vh] overflow-hidden">
            <div class="bg-wa-primary dark:bg-wa-header text-white p-4 flex items-center gap-4 shadow">
                <button onclick="closeModal('createGroupModal')"><i class="fas fa-arrow-right"></i></button>
                <h2 class="font-bold text-lg">نیا گروپ</h2>
            </div>
            <div class="p-6 flex-1 flex flex-col bg-white dark:bg-wa-dark">
                <div class="flex items-center gap-3 mb-6 border-b-2 border-wa-primary pb-2">
                    <input type="text" id="newGroupName" placeholder="گروپ کا نام" class="flex-1 bg-transparent outline-none urdu-text text-lg dark:text-white">
                </div>
                <div id="groupSelectionList" class="flex-1 overflow-y-auto space-y-2 custom-scrollbar"></div>
                <div class="mt-4 flex justify-end">
                    <button onclick="createGroup()" class="w-12 h-12 bg-wa-primary text-white rounded-full shadow-lg flex items-center justify-center btn-press"><i class="fas fa-check"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="profileModal" class="hidden fixed inset-0 z-[95] bg-black/50 flex justify-center items-center p-4">
        <div class="bg-white dark:bg-wa-dark w-full max-w-sm rounded-xl shadow-2xl overflow-hidden">
            <div class="bg-wa-primary dark:bg-wa-header text-white p-4 flex items-center gap-4">
                <button onclick="closeModal('profileModal')"><i class="fas fa-arrow-right"></i></button>
                <h2 class="font-bold text-lg">پروفائل</h2>
            </div>
            <div class="p-8 flex flex-col items-center">
                <div class="w-36 h-36 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-6xl text-gray-400 mb-8"><span id="profileAvatarText">U</span></div>
                <div class="w-full mb-6">
                    <div class="flex justify-between items-center text-wa-primary text-xs font-bold mb-1 px-2"><span>نام</span><i class="fas fa-pen cursor-pointer" onclick="enableEditName()"></i></div>
                    <input type="text" id="editProfileName" class="w-full bg-transparent border-b-2 border-gray-200 dark:border-gray-700 outline-none font-bold text-lg urdu-text dark:text-white py-2" disabled>
                </div>
                <p id="profileEmail" class="text-sm text-gray-500"></p>
                <button id="saveProfileBtn" onclick="saveProfile()" class="mt-8 w-full bg-wa-primary text-white py-3 rounded-lg font-bold shadow-lg hidden">محفوظ کریں</button>
            </div>
        </div>
    </div>

    <div id="callScreen" class="hidden fixed inset-0 z-[200] bg-[#0b141a] text-white flex flex-col items-center pt-20">
        <div class="flex flex-col items-center animate-pulse">
            <div class="w-24 h-24 rounded-full bg-gray-700 flex items-center justify-center text-4xl mb-4 shadow-2xl relative"><span id="callAvatar">U</span><div class="absolute inset-0 rounded-full border-2 border-wa-primary call-pulse"></div></div>
            <h2 id="callName" class="text-2xl font-bold mb-2">User</h2>
            <p id="callStatus" class="text-gray-400 text-sm">کال کی جا رہی ہے...</p>
        </div>
        <div class="mt-auto mb-16 w-full flex justify-center">
            <button onclick="endCall()" class="w-16 h-16 rounded-full bg-red-600 text-white text-2xl shadow-lg flex items-center justify-center"><i class="fas fa-phone-slash"></i></button>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-6 py-3 rounded-full opacity-0 pointer-events-none transition-opacity z-[200] shadow-xl"></div>

    <!-- Firebase & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, query, where, onSnapshot, doc, setDoc, getDoc, serverTimestamp, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCwrfDXG8pRpkqDYht0EpRZ8h_ElRu0N_w",
            authDomain: "mysmartdiarypk.firebaseapp.com",
            projectId: "mysmartdiarypk",
            storageBucket: "mysmartdiarypk.firebasestorage.app",
            messagingSenderId: "989892082432",
            appId: "1:989892082432:web:684da193fde4a5915b51e5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let activeChatId = null;
        let activeChatName = "";
        
        // Selection & Edit State
        let selectedMsgs = new Set();
        let isSelectionMode = false;
        let editingMessageId = null;
        let pressTimer = null;

        // --- AUTH & INIT ---
        window.toggleAuthMode = (mode) => {
            document.getElementById('loginForm').classList.toggle('hidden', mode !== 'login');
            document.getElementById('signupForm').classList.toggle('hidden', mode !== 'signup');
            // Style tabs... (simplified for brevity, assume working from previous)
        };

        window.authAction = async (type) => {
            const email = document.getElementById(type === 'login' ? 'loginEmail' : 'signupEmail').value;
            const pass = document.getElementById(type === 'login' ? 'loginPass' : 'signupPass').value;
            if(!email || !pass) return showToast("خالی خانے پُر کریں");
            
            showLoading(true);
            try {
                if(type === 'signup') {
                    const name = document.getElementById('signupName').value;
                    const cred = await createUserWithEmailAndPassword(auth, email, pass);
                    await updateProfile(cred.user, { displayName: name });
                    await setDoc(doc(db, "users", cred.user.uid), { displayName: name, email: email, uid: cred.user.uid, createdAt: serverTimestamp(), about: "Hey there!" });
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch(e) { showToast(e.message); showLoading(false); }
        };

        onAuthStateChanged(auth, async (user) => {
            if(user) {
                currentUser = user;
                if(!user.displayName) {
                    const d = await getDoc(doc(db, "users", user.uid));
                    if(d.exists() && d.data().displayName) initApp();
                } else initApp();
            } else {
                showLoading(false);
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        });

        function initApp() {
            showLoading(false);
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            const name = currentUser.displayName || "User";
            document.getElementById('sidebarAvatar').innerText = name[0].toUpperCase();
            document.getElementById('profileAvatarText').innerText = name[0].toUpperCase();
            document.getElementById('editProfileName').value = name;
            document.getElementById('profileEmail').innerText = currentUser.email;
            loadChats();
        }

        // --- SELECTION & EDIT LOGIC ---
        
        // Triggered by long press
        window.startSelection = (msgId) => {
            if(isSelectionMode) return;
            isSelectionMode = true;
            toggleSelection(msgId);
            updateHeaderState();
        };

        // Triggered by click in selection mode
        window.toggleSelection = (msgId) => {
            const el = document.getElementById(`msg-${msgId}`);
            if(selectedMsgs.has(msgId)) {
                selectedMsgs.delete(msgId);
                el.classList.remove('msg-selected');
            } else {
                selectedMsgs.add(msgId);
                el.classList.add('msg-selected');
            }
            
            if(selectedMsgs.size === 0) clearSelection();
            else updateHeaderState();
        };

        window.clearSelection = () => {
            selectedMsgs.forEach(id => {
                const el = document.getElementById(`msg-${id}`);
                if(el) el.classList.remove('msg-selected');
            });
            selectedMsgs.clear();
            isSelectionMode = false;
            editingMessageId = null;
            updateHeaderState();
            
            // Reset input if was editing
            const input = document.getElementById('msgInput');
            if(input.dataset.editing) {
                input.value = "";
                delete input.dataset.editing;
                document.getElementById('sendIcon').className = "fas fa-microphone text-xl";
            }
        };

        function updateHeaderState() {
            const normal = document.getElementById('chatHeaderNormal');
            const select = document.getElementById('chatHeaderSelection');
            const btnEdit = document.getElementById('btnEditMsg');
            
            if(isSelectionMode) {
                normal.classList.add('hidden');
                select.classList.remove('hidden');
                document.getElementById('selectionCount').innerText = selectedMsgs.size;
                
                // Check edit capability (single selection + own message)
                if(selectedMsgs.size === 1) {
                    const msgId = Array.from(selectedMsgs)[0];
                    // Verify ownership via DOM or data attr (simpler here to assume check later or utilize stored data map)
                    // For now, I'll allow button show, validation happens on click
                    btnEdit.classList.remove('hidden');
                } else {
                    btnEdit.classList.add('hidden');
                }
            } else {
                normal.classList.remove('hidden');
                select.classList.add('hidden');
            }
        }

        window.deleteSelectedMessages = async () => {
            if(!confirm("کیا آپ واقعی ڈیلیٹ کرنا چاہتے ہیں؟")) return;
            showLoading(true);
            const batch = writeBatch(db);
            selectedMsgs.forEach(id => {
                const ref = doc(db, `chats/${activeChatId}/messages`, id);
                batch.delete(ref);
            });
            try {
                await batch.commit();
                showToast("پیغامات ڈیلیٹ ہو گئے");
            } catch(e) { showToast("Error deleting"); }
            showLoading(false);
            clearSelection();
        };

        window.editSelectedMessage = async () => {
            const msgId = Array.from(selectedMsgs)[0];
            const ref = doc(db, `chats/${activeChatId}/messages`, msgId);
            const snap = await getDoc(ref);
            
            if(snap.exists()) {
                const data = snap.data();
                if(data.senderId !== currentUser.uid) {
                    showToast("صرف اپنے میسج ایڈٹ کر سکتے ہیں");
                    return;
                }
                
                // Enter Edit Mode
                const input = document.getElementById('msgInput');
                input.value = data.text;
                input.focus();
                input.dataset.editing = msgId; // Store ID in DOM
                editingMessageId = msgId;
                
                // Change Icon
                document.getElementById('sendIcon').className = "fas fa-check text-xl text-wa-primary";
                
                // Exit selection UI visually but keep state logical
                isSelectionMode = false; 
                updateHeaderState(); // Switch header back
                selectedMsgs.clear(); // Clear highlights
            }
        };

        // --- MESSAGE SENDING (MOBILE FIX + EDIT) ---

        window.handleSendPress = (e) => {
            // Mobile Fix: Prevent ghost clicks and ensure firing
            if(e.type === 'touchstart') e.preventDefault(); 
            sendMessage();
        };

        window.sendMessage = async () => {
            if(!activeChatId) return;
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            if(!text) return;
            
            const isEdit = !!input.dataset.editing;
            const editId = input.dataset.editing;

            input.value = "";
            delete input.dataset.editing;
            document.getElementById('sendIcon').className = "fas fa-microphone text-xl"; // Reset icon
            
            try {
                if(isEdit) {
                    await updateDoc(doc(db, `chats/${activeChatId}/messages`, editId), {
                        text: text,
                        edited: true
                    });
                    showToast("میسج اپ ڈیٹ ہو گیا");
                } else {
                    const senderName = currentUser.displayName || "User";
                    await addDoc(collection(db, `chats/${activeChatId}/messages`), {
                        text: text, senderId: currentUser.uid, senderName: senderName, createdAt: serverTimestamp()
                    });
                    await updateDoc(doc(db, "chats", activeChatId), {
                        lastMessage: text, lastUpdated: serverTimestamp(), [`names.${currentUser.uid}`]: senderName
                    });
                }
            } catch(e) { showToast("ایرر"); console.error(e); }
        };

        // --- TOUCH/LONG PRESS HANDLERS ---
        window.handleMsgTouchStart = (id) => {
            pressTimer = setTimeout(() => startSelection(id), 600); // 600ms for long press
        };
        window.handleMsgTouchEnd = () => {
            clearTimeout(pressTimer);
        };
        window.handleMsgClick = (id) => {
            if(isSelectionMode) toggleSelection(id);
        };

        // --- CHAT SYSTEM ---
        window.openChat = (chatId, title, isGroup) => {
            activeChatId = chatId;
            activeChatName = title;
            clearSelection(); // Reset any old state
            
            // UI Toggle
            document.getElementById('chatRoom').classList.remove('hidden', 'flex'); 
            document.getElementById('chatRoom').classList.add('flex');
            document.getElementById('desktopPlaceholder').classList.add('hidden');
            
            document.getElementById('chatHeaderTitle').innerText = title;
            document.getElementById('chatHeaderAvatar').innerText = title ? title[0].toUpperCase() : "?";

            const q = query(collection(db, `chats/${chatId}/messages`), orderBy('createdAt', 'asc'));
            onSnapshot(q, (snap) => {
                const container = document.getElementById('messagesContainer');
                container.innerHTML = "";
                snap.forEach(d => {
                    const msg = d.data();
                    const isMe = msg.senderId === currentUser.uid;
                    const time = msg.createdAt ? new Date(msg.createdAt.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "";
                    const editedLabel = msg.edited ? '<span class="text-[9px] mx-1 opacity-50">(edited)</span>' : '';
                    
                    const div = document.createElement('div');
                    div.id = `msg-${d.id}`; // ID for selection
                    div.className = `flex w-full mb-1 ${isMe ? 'justify-end' : 'justify-start'} select-none`; // select-none for better app feel
                    
                    // Touch events for selection
                    div.onmousedown = () => handleMsgTouchStart(d.id);
                    div.onmouseup = () => handleMsgTouchEnd();
                    div.ontouchstart = () => handleMsgTouchStart(d.id);
                    div.ontouchend = () => handleMsgTouchEnd();
                    div.onclick = () => handleMsgClick(d.id);

                    const senderHtml = (isGroup && !isMe) ? `<p class="text-[11px] font-bold text-orange-500 mb-0.5">${msg.senderName}</p>` : '';
                    
                    div.innerHTML = `
                        <div class="max-w-[80%] md:max-w-[65%] p-2 px-3 rounded-lg shadow-sm ${isMe ? 'bg-wa-chat_me dark:bg-wa-chat_dark_me rounded-tr-none' : 'bg-white dark:bg-wa-chat_dark_other rounded-tl-none'} text-sm cursor-pointer transition-colors duration-200">
                            ${senderHtml}
                            <p class="urdu-text leading-relaxed whitespace-pre-wrap dark:text-gray-100">${msg.text}</p>
                            <span class="text-[10px] text-gray-500 dark:text-gray-400 block text-right mt-1 flex items-center justify-end">
                                ${editedLabel} ${time} ${isMe ? '<i class="fas fa-check-double text-blue-400 ml-1"></i>' : ''}
                            </span>
                        </div>
                    `;
                    container.appendChild(div);
                });
                container.scrollTop = container.scrollHeight;
            });
        };

        // --- BOILERPLATE & UTILS ---
        window.closeChatRoom = () => {
            activeChatId = null;
            clearSelection();
            document.getElementById('chatRoom').classList.add('hidden');
            document.getElementById('desktopPlaceholder').classList.remove('hidden');
            document.getElementById('desktopPlaceholder').classList.add('flex');
        };
        
        window.loadChats = () => {
             const q = query(collection(db, "chats"), where("participants", "array-contains", currentUser.uid));
             onSnapshot(q, (snapshot) => {
                const list = document.getElementById('chatList'); list.innerHTML = "";
                if(snapshot.empty) { list.innerHTML = `<div class="text-center mt-20 opacity-50"><p>کوئی چیٹ نہیں</p></div>`; return; }
                let chats = [];
                snapshot.forEach(d => chats.push({id: d.id, ...d.data()}));
                chats.sort((a,b)=>(b.lastUpdated?.seconds||0)-(a.lastUpdated?.seconds||0));
                chats.forEach(chat => {
                    let name="User", initial="U"; const isGroup=chat.type==='group';
                    if(isGroup) { name=chat.groupName; initial=name[0]; }
                    else {
                        let oid = chat.participants.find(id=>id!==currentUser.uid) || currentUser.uid;
                        if(oid===currentUser.uid) { name = (currentUser.displayName||"Me")+" (آپ)"; initial=name[0]; }
                        else { name = (chat.names && chat.names[oid]) ? chat.names[oid] : "Unknown"; initial=name[0]; }
                    }
                    const div = document.createElement('div');
                    div.className = `flex items-center gap-3 p-3 px-4 hover:bg-gray-100 dark:hover:bg-gray-800 cursor-pointer ${activeChatId===chat.id?'bg-gray-100 dark:bg-gray-800':''}`;
                    div.onclick = () => openChat(chat.id, name, isGroup);
                    div.innerHTML = `<div class="w-12 h-12 rounded-full bg-gray-200 dark:bg-gray-700 flex-shrink-0 flex items-center justify-center font-bold text-gray-500 text-lg relative">${!isGroup?initial.toUpperCase():'<i class="fas fa-users"></i>'}</div><div class="flex-1 border-b border-gray-100 dark:border-gray-800 pb-3 min-w-0"><div class="flex justify-between items-center mb-1"><h3 class="font-bold text-gray-900 dark:text-white truncate">${name}</h3></div><p class="text-sm text-gray-500 dark:text-gray-400 truncate urdu-text">${chat.lastMessage||""}</p></div>`;
                    list.appendChild(div);
                });
             });
        };
        
        // Modal & Other functions
        window.openNewChatModal = () => { document.getElementById('newChatModal').classList.remove('hidden'); loadAllUsers(); };
        window.openCreateGroupModal = () => { document.getElementById('newChatModal').classList.add('hidden'); document.getElementById('createGroupModal').classList.remove('hidden'); loadUsersForGroup(); };
        window.openProfileModal = () => { document.getElementById('profileModal').classList.remove('hidden'); };
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.toggleMenu = () => document.getElementById('mainMenu').classList.toggle('hidden');
        window.toggleTheme = () => document.documentElement.classList.toggle('dark');
        window.switchTab = (tab) => {
             ['chats','calls'].forEach(t => { document.getElementById(`view${t.charAt(0).toUpperCase()+t.slice(1)}`).classList.add('hidden'); document.getElementById(`tab-${t}`).classList.remove('border-white','text-white'); });
             document.getElementById(`view${tab.charAt(0).toUpperCase()+tab.slice(1)}`).classList.remove('hidden'); document.getElementById(`tab-${tab}`).classList.add('border-white','text-white');
        };
        window.startAudioCall = () => { document.getElementById('callScreen').classList.remove('hidden'); document.getElementById('callName').innerText=activeChatName; };
        window.endCall = () => document.getElementById('callScreen').classList.add('hidden');
        window.signOutApp = () => { signOut(auth); location.reload(); };
        window.autoResize = (el) => { 
             el.style.height='auto'; el.style.height=el.scrollHeight+'px'; 
             const btn = document.getElementById('sendIcon');
             // Update icon based on edit mode or empty state
             if(document.getElementById('msgInput').dataset.editing) btn.className = "fas fa-check text-xl text-wa-primary";
             else btn.className = el.value.trim().length > 0 ? "fas fa-paper-plane text-xl" : "fas fa-microphone text-xl";
        };
        window.showToast = (msg) => { const t = document.getElementById('toast'); t.innerText=msg; t.style.opacity='1'; setTimeout(()=>t.style.opacity='0',3000); };
        window.showLoading = (s) => document.getElementById('loadingOverlay').classList.toggle('hidden',!s);
        
        // Helpers for users loading (abbreviated)
        function loadAllUsers() { const list = document.getElementById('contactsList'); list.innerHTML='...'; const q=query(collection(db,"users"),orderBy('displayName')); onSnapshot(q,(s)=>{ list.innerHTML=""; s.forEach(d=>{ if(d.id!==currentUser.uid) { const u=d.data(); const div=document.createElement('div'); div.className="flex items-center gap-3 p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded-lg"; div.onclick=()=>startDirectChat(d.id,u.displayName); div.innerHTML=`<div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-500">${u.displayName[0]}</div><div class="flex-1"><p class="font-bold text-sm dark:text-white">${u.displayName}</p></div>`; list.appendChild(div); }}); }); }
        function loadUsersForGroup() { const list = document.getElementById('groupSelectionList'); list.innerHTML='...'; onSnapshot(collection(db,"users"),(s)=>{ list.innerHTML=""; s.forEach(d=>{ if(d.id!==currentUser.uid){ const u=d.data(); const div=document.createElement('div'); div.className="flex items-center gap-3 p-2 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer rounded-lg"; div.onclick=(e)=>{if(e.target.type!=='checkbox') div.querySelector('input').click();}; div.innerHTML=`<div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-500">${u.displayName[0]}</div><div class="flex-1"><p class="font-bold text-sm dark:text-white">${u.displayName}</p></div><input type="checkbox" value="${d.id}" class="w-5 h-5 accent-wa-primary">`; list.appendChild(div); }}); }); }
        
        window.createGroup = async () => { const name = document.getElementById('newGroupName').value; const cbs = document.querySelectorAll('#groupSelectionList input:checked'); if(!name || cbs.length===0) return; const uids = Array.from(cbs).map(c=>c.value); uids.push(currentUser.uid); await addDoc(collection(db, "chats"), { type: 'group', groupName: name, participants: uids, createdBy: currentUser.uid, lastUpdated: serverTimestamp(), lastMessage: 'Group created' }); closeModal('createGroupModal'); };
        async function startDirectChat(oid, oname) { closeModal('newChatModal'); const ids = [currentUser.uid, oid].sort(); const chatId = ids.join("_"); const ref = doc(db, "chats", chatId); const snap = await getDoc(ref); if(!snap.exists()) await setDoc(ref, { participants: ids, type: 'private', lastUpdated: serverTimestamp(), lastMessage: '', names: { [currentUser.uid]: currentUser.displayName, [oid]: oname } }); openChat(chatId, oname, false); }
        window.saveProfile = async () => { const n = document.getElementById('editProfileName').value; await updateProfile(currentUser, {displayName: n}); await updateDoc(doc(db,"users",currentUser.uid),{displayName:n}); closeModal('profileModal'); initApp(); };
        window.enableEditName = () => { document.getElementById('editProfileName').disabled=false; document.getElementById('saveProfileBtn').classList.remove('hidden'); };

    </script>
</body>
</html>
