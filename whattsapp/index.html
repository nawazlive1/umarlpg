<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>واٹس ایپ کلون</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        wa: {
                            primary: '#008069', // Original WA Teal
                            dark: '#1f2c34',    // Dark BG
                            header: '#202c33',  // Dark Header
                            chat_me: '#e2f7cb', // Green Bubble (Light Mode)
                            chat_other: '#ffffff', // White Bubble
                            chat_dark_me: '#005c4b',
                            chat_dark_other: '#202c33',
                            bg_default: '#f0f2f5',
                            accent: '#25d366',
                            tab_active: '#ffffff',
                            tab_inactive: '#b4d9d2'
                        }
                    },
                    fontFamily: {
                        urdu: ['Noto Nastaliq Urdu', 'serif'],
                        sans: ['Noto Sans Arabic', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Noto Sans Arabic', sans-serif; -webkit-tap-highlight-color: transparent; }
        .urdu-text { font-family: 'Noto Nastaliq Urdu', serif; line-height: 2.2; }
        
        /* WhatsApp Background */
        .chat-bg {
            background-color: #efeae2;
            background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png");
            background-repeat: repeat;
        }
        .dark .chat-bg {
            background-color: #0b141a;
            background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png");
            opacity: 0.06;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .btn-press:active { transform: scale(0.96); }

        /* Animations */
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes slideOutRight { from { transform: translateX(0); } to { transform: translateX(100%); } }
        .slide-in { animation: slideInRight 0.2s ease-out forwards; }
        .slide-out { animation: slideOutRight 0.2s ease-in forwards; }

        /* Ticks */
        .tick-read { color: #53bdeb; }
        .tick-sent { color: #8696a0; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-black h-[100dvh] w-full overflow-hidden flex justify-center text-gray-800 dark:text-gray-100 selection:bg-wa-primary selection:text-white">

    <div class="w-full max-w-md h-full flex flex-col bg-white dark:bg-wa-dark shadow-2xl relative overflow-hidden">
        
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="hidden absolute inset-0 z-[100] bg-white/90 dark:bg-black/90 flex flex-col items-center justify-center">
            <div class="w-12 h-12 border-4 border-wa-primary border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="font-bold text-wa-primary urdu-text" id="loadingText">براہ کرم انتظار کریں...</p>
        </div>

        <!-- ================= AUTH SCREENS (Email/Pass) ================= -->
        
        <div id="authScreen" class="absolute inset-0 z-50 bg-white dark:bg-wa-dark flex flex-col items-center justify-center p-6">
            <div class="mb-8 flex flex-col items-center">
                <div class="w-20 h-20 bg-wa-primary rounded-2xl flex items-center justify-center text-white text-4xl mb-4 shadow-lg">
                    <i class="fab fa-whatsapp"></i>
                </div>
                <h1 class="text-2xl font-bold text-wa-primary mb-1 urdu-text">واٹس ایپ میں خوش آمدید</h1>
                <p class="text-xs text-gray-500">اپنے اکاؤنٹ میں لاگ ان کریں</p>
            </div>
            
            <!-- Tabs for Login/Signup -->
            <div class="flex w-full mb-6 bg-gray-100 dark:bg-gray-800 p-1 rounded-lg">
                <button onclick="toggleAuthMode('login')" id="tabLogin" class="flex-1 py-2 text-sm font-bold rounded-md bg-white dark:bg-gray-700 shadow text-wa-primary transition-all">لاگ ان</button>
                <button onclick="toggleAuthMode('signup')" id="tabSignup" class="flex-1 py-2 text-sm font-bold rounded-md text-gray-500 transition-all">اکاؤنٹ بنائیں</button>
            </div>

            <!-- LOGIN FORM -->
            <div id="loginForm" class="w-full space-y-4 animate-fade-in">
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg px-4 py-2 border border-gray-200 dark:border-gray-700">
                    <label class="text-[10px] text-wa-primary font-bold">ای میل</label>
                    <input type="email" id="loginEmail" class="w-full bg-transparent outline-none text-sm dark:text-white" dir="ltr">
                </div>
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg px-4 py-2 border border-gray-200 dark:border-gray-700">
                    <label class="text-[10px] text-wa-primary font-bold">پاسورڈ</label>
                    <input type="password" id="loginPass" class="w-full bg-transparent outline-none text-sm dark:text-white" dir="ltr">
                </div>
                <button onclick="authAction('login')" class="w-full bg-wa-primary text-white py-3 rounded-full font-bold shadow-lg btn-press mt-4">لاگ ان کریں</button>
            </div>

            <!-- SIGNUP FORM -->
            <div id="signupForm" class="hidden w-full space-y-4 animate-fade-in">
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg px-4 py-2 border border-gray-200 dark:border-gray-700">
                    <label class="text-[10px] text-wa-primary font-bold">آپ کا نام</label>
                    <input type="text" id="signupName" class="w-full bg-transparent outline-none text-sm dark:text-white urdu-text">
                </div>
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg px-4 py-2 border border-gray-200 dark:border-gray-700">
                    <label class="text-[10px] text-wa-primary font-bold">ای میل</label>
                    <input type="email" id="signupEmail" class="w-full bg-transparent outline-none text-sm dark:text-white" dir="ltr">
                </div>
                <div class="bg-gray-50 dark:bg-gray-800 rounded-lg px-4 py-2 border border-gray-200 dark:border-gray-700">
                    <label class="text-[10px] text-wa-primary font-bold">پاسورڈ</label>
                    <input type="password" id="signupPass" class="w-full bg-transparent outline-none text-sm dark:text-white" dir="ltr">
                </div>
                <button onclick="authAction('signup')" class="w-full bg-wa-primary text-white py-3 rounded-full font-bold shadow-lg btn-press mt-4">اکاؤنٹ بنائیں</button>
            </div>

            <p class="mt-auto text-[10px] text-gray-400">from Meta</p>
        </div>

        <!-- ================= MAIN APP UI ================= -->
        
        <div id="mainApp" class="hidden flex-1 flex flex-col h-full overflow-hidden">
            
            <!-- Main Header -->
            <header class="bg-wa-primary dark:bg-wa-header text-white shadow-md z-20 flex-shrink-0">
                <div class="flex justify-between items-center p-4 pb-2">
                    <h1 class="text-xl font-bold tracking-wide">WhatsApp</h1>
                    <div class="flex gap-5 text-lg">
                        <button onclick="toggleTheme()" class="opacity-80 hover:opacity-100"><i class="far fa-moon"></i></button>
                        <button class="opacity-80 hover:opacity-100"><i class="fas fa-camera"></i></button>
                        <button class="opacity-80 hover:opacity-100"><i class="fas fa-search"></i></button>
                        <div class="relative group">
                            <button class="opacity-80 hover:opacity-100"><i class="fas fa-ellipsis-v"></i></button>
                            <!-- Dropdown -->
                            <div class="absolute right-0 top-6 w-40 bg-white dark:bg-wa-header shadow-xl rounded-lg hidden group-hover:block py-2 text-gray-800 dark:text-gray-200 text-sm animate-fade-in z-50">
                                <div onclick="openCreateGroupModal()" class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer">نیا گروپ</div>
                                <div onclick="openProfileModal()" class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer">سیٹنگز</div>
                                <div onclick="signOutApp()" class="px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer text-red-500">لاگ آؤٹ</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Navigation Tabs -->
                <div class="flex justify-between text-center uppercase text-xs font-bold pt-2">
                    <div class="w-10 pb-3 opacity-60"><i class="fas fa-users"></i></div>
                    <div onclick="switchTab('chats')" id="tab-chats" class="flex-1 pb-3 border-b-[3px] border-white text-white cursor-pointer transition-colors">چیٹس</div>
                    <div onclick="switchTab('updates')" id="tab-updates" class="flex-1 pb-3 border-b-[3px] border-transparent text-wa-tab_inactive hover:text-white cursor-pointer transition-colors">اپڈیٹس</div>
                    <div onclick="switchTab('calls')" id="tab-calls" class="flex-1 pb-3 border-b-[3px] border-transparent text-wa-tab_inactive hover:text-white cursor-pointer transition-colors">کالز</div>
                </div>
            </header>

            <!-- CHATS TAB -->
            <div id="viewChats" class="flex-1 overflow-y-auto relative bg-white dark:bg-wa-dark custom-scrollbar">
                <!-- Chat List -->
                <div id="chatList" class="pb-24"></div>

                <!-- FAB -->
                <button onclick="openNewChatModal()" class="absolute bottom-5 right-5 w-14 h-14 bg-wa-primary text-white rounded-2xl shadow-lg flex items-center justify-center text-xl btn-press z-30 transition-transform hover:scale-105">
                    <i class="fas fa-comment-alt"></i>
                </button>
            </div>

            <!-- UPDATES TAB (Mock) -->
            <div id="viewUpdates" class="hidden flex-1 overflow-y-auto bg-white dark:bg-wa-dark p-4">
                <h2 class="font-bold text-lg mb-4">اسٹیٹس</h2>
                <div class="flex items-center gap-3 mb-6">
                    <div class="relative">
                        <div class="w-12 h-12 rounded-full bg-gray-300 flex items-center justify-center overflow-hidden">
                            <span id="myStatusAvatar" class="text-xl font-bold text-gray-500">U</span>
                        </div>
                        <div class="absolute bottom-0 right-0 bg-wa-accent text-white rounded-full w-5 h-5 flex items-center justify-center border-2 border-white dark:border-wa-dark text-xs font-bold">+</div>
                    </div>
                    <div>
                        <h3 class="font-bold text-sm">میرا اسٹیٹس</h3>
                        <p class="text-xs text-gray-500">اسٹیٹس لگانے کے لیے ٹیپ کریں</p>
                    </div>
                </div>
                <p class="text-xs text-gray-500 font-bold mb-2">حالیہ اپڈیٹس</p>
                <div class="opacity-50 text-center py-10 text-sm">کوئی حالیہ اپڈیٹ نہیں</div>
            </div>

            <!-- CALLS TAB (Mock) -->
            <div id="viewCalls" class="hidden flex-1 overflow-y-auto bg-white dark:bg-wa-dark p-4">
                <h2 class="font-bold text-lg mb-4">کالز</h2>
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-12 h-12 rounded-full bg-wa-primary flex items-center justify-center text-white transform -rotate-45">
                        <i class="fas fa-link"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-sm">کال لنک بنائیں</h3>
                        <p class="text-xs text-gray-500">اپنی واٹس ایپ کال کا لنک شیئر کریں</p>
                    </div>
                </div>
                <p class="text-xs text-gray-500 font-bold mb-2">حالیہ</p>
                <div class="opacity-50 text-center py-10 text-sm">کوئی کال ہسٹری نہیں</div>
            </div>

        </div>
    </div>

    <!-- ================= MODALS ================= -->

    <!-- New Chat / Contacts Modal -->
    <div id="newChatModal" class="hidden fixed inset-0 z-[60] bg-white dark:bg-wa-dark flex flex-col slide-in">
        <div class="bg-wa-primary dark:bg-wa-header text-white p-3 flex items-center gap-3 shadow pt-4">
            <button onclick="closeModal('newChatModal')"><i class="fas fa-arrow-right"></i></button>
            <div class="flex-1">
                <h2 class="font-bold text-lg">رابطہ منتخب کریں</h2>
                <p class="text-xs opacity-80" id="contactsCount">0 رابطے</p>
            </div>
            <button><i class="fas fa-search"></i></button>
        </div>
        
        <div class="flex-1 overflow-y-auto p-2">
            <!-- Options -->
            <div onclick="openCreateGroupModal()" class="flex items-center gap-4 p-3 hover:bg-gray-100 dark:hover:bg-gray-800 cursor-pointer rounded-lg">
                <div class="w-10 h-10 rounded-full bg-wa-primary text-white flex items-center justify-center"><i class="fas fa-users"></i></div>
                <p class="font-bold">نیا گروپ بنائیں</p>
            </div>
            <div class="flex items-center gap-4 p-3 hover:bg-gray-100 dark:hover:bg-gray-800 cursor-pointer rounded-lg mb-2">
                <div class="w-10 h-10 rounded-full bg-wa-primary text-white flex items-center justify-center"><i class="fas fa-user-plus"></i></div>
                <p class="font-bold">نیا رابطہ</p>
            </div>
            
            <p class="px-3 text-xs font-bold text-gray-500 mb-2">واٹس ایپ پر رابطے</p>
            <div id="contactsList" class="space-y-1"></div>
        </div>
    </div>

    <!-- Create Group Modal -->
    <div id="createGroupModal" class="hidden fixed inset-0 z-[70] bg-white dark:bg-wa-dark flex flex-col slide-in">
        <div class="bg-wa-primary dark:bg-wa-header text-white p-3 flex items-center gap-3 shadow pt-4">
            <button onclick="closeModal('createGroupModal')"><i class="fas fa-arrow-right"></i></button>
            <div>
                <h2 class="font-bold text-lg">نیا گروپ</h2>
                <p class="text-xs opacity-80">ممبرز شامل کریں</p>
            </div>
        </div>
        <div class="p-4 flex-1 flex flex-col">
            <div class="flex items-center gap-3 mb-6 border-b border-wa-primary pb-2">
                <div class="w-12 h-12 bg-gray-300 rounded-full flex items-center justify-center text-gray-500">
                    <i class="fas fa-camera"></i>
                </div>
                <input type="text" id="newGroupName" placeholder="گروپ کا نام لکھیں" class="flex-1 bg-transparent outline-none urdu-text text-lg">
                <i class="far fa-smile text-gray-400"></i>
            </div>
            
            <p class="text-sm font-bold mb-3 text-gray-500">ممبرز منتخب کریں:</p>
            <div id="groupSelectionList" class="flex-1 overflow-y-auto space-y-2"></div>
            
            <button onclick="createGroup()" class="w-12 h-12 bg-wa-primary text-white rounded-full shadow-lg flex items-center justify-center self-end mt-4 btn-press">
                <i class="fas fa-check"></i>
            </button>
        </div>
    </div>

    <!-- Profile/Settings Modal -->
    <div id="profileModal" class="hidden fixed inset-0 z-[70] bg-white dark:bg-wa-dark flex flex-col slide-in">
        <div class="bg-wa-primary dark:bg-wa-header text-white p-3 flex items-center gap-3 shadow pt-4">
            <button onclick="closeModal('profileModal')"><i class="fas fa-arrow-right"></i></button>
            <h2 class="font-bold text-lg">پروفائل</h2>
        </div>
        <div class="p-6 flex flex-col items-center">
            <div class="relative mb-6">
                <div class="w-32 h-32 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-5xl text-gray-400 overflow-hidden">
                    <span id="profileAvatarText">U</span>
                </div>
                <div class="absolute bottom-0 right-0 bg-wa-primary p-3 rounded-full text-white shadow-lg cursor-pointer">
                    <i class="fas fa-camera"></i>
                </div>
            </div>

            <div class="w-full mb-4">
                <div class="flex justify-between items-center text-gray-500 text-xs mb-1 px-2">
                    <span>نام</span>
                    <i class="fas fa-pen cursor-pointer" onclick="enableEditName()"></i>
                </div>
                <div class="flex items-center gap-2 border-b-2 border-transparent focus-within:border-wa-primary bg-gray-50 dark:bg-gray-800 p-3 rounded-t-lg transition-colors">
                    <input type="text" id="editProfileName" class="w-full bg-transparent outline-none font-bold text-lg urdu-text" disabled>
                    <i class="far fa-smile text-gray-400"></i>
                </div>
                <p class="text-[10px] text-gray-400 mt-1 px-2">یہ نام آپ کے واٹس ایپ رابطوں کو نظر آئے گا۔</p>
            </div>
            
            <div class="w-full">
                <p class="text-gray-500 text-xs mb-1 px-2">ای میل</p>
                <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg text-gray-400 text-sm" id="profileEmail">user@example.com</div>
            </div>

            <button id="saveProfileBtn" onclick="saveProfile()" class="mt-8 bg-wa-primary text-white px-8 py-2 rounded-full font-bold hidden">محفوظ کریں</button>
        </div>
    </div>

    <!-- Chat Room -->
    <div id="chatRoom" class="hidden fixed inset-0 z-[80] bg-gray-200 dark:bg-black flex flex-col h-full w-full max-w-md mx-auto slide-in">
        <!-- Chat Header -->
        <div class="bg-wa-primary dark:bg-wa-header text-white px-2 py-1.5 flex items-center justify-between shadow z-10">
            <div class="flex items-center gap-1">
                <button onclick="closeChatRoom()" class="p-1 rounded-full hover:bg-white/10 flex items-center gap-1">
                    <i class="fas fa-arrow-right"></i>
                    <div class="w-9 h-9 rounded-full bg-gray-300 overflow-hidden relative">
                        <div id="chatHeaderAvatar" class="w-full h-full flex items-center justify-center text-gray-600 font-bold bg-gray-200">U</div>
                    </div>
                </button>
                <div class="flex flex-col ml-1 cursor-pointer">
                    <h2 id="chatHeaderTitle" class="font-bold text-base leading-tight truncate w-32">User</h2>
                    <p class="text-[10px] opacity-80 truncate" id="chatHeaderStatus">tap for info</p>
                </div>
            </div>
            <div class="flex gap-4 text-lg pr-2 items-center">
                <button class="hover:opacity-80"><i class="fas fa-video"></i></button>
                <button class="hover:opacity-80"><i class="fas fa-phone"></i></button>
                <button class="hover:opacity-80"><i class="fas fa-ellipsis-v"></i></button>
            </div>
        </div>

        <!-- Messages Area -->
        <div id="messagesContainer" class="flex-1 overflow-y-auto p-4 chat-bg space-y-1 relative">
            <!-- Messages injected here -->
        </div>

        <!-- Input Area -->
        <div class="bg-transparent p-1 px-2 flex items-end gap-1 z-20 mb-1" style="padding-bottom: max(6px, env(safe-area-inset-bottom));">
            <div class="flex-1 bg-white dark:bg-wa-header rounded-[24px] flex items-end border border-gray-100 dark:border-none shadow-sm px-1 py-1 min-h-[45px]">
                <button class="p-2.5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 mb-[2px]"><i class="far fa-smile text-xl"></i></button>
                <textarea id="msgInput" rows="1" placeholder="پیغام..." class="flex-1 bg-transparent p-2.5 outline-none max-h-32 resize-none urdu-text dark:text-white mb-[1px]" oninput="autoResize(this)"></textarea>
                <button class="p-2.5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 mb-[2px]"><i class="fas fa-paperclip text-lg"></i></button>
                <button class="p-2.5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 mb-[2px] mr-[-5px]"><i class="fas fa-camera text-lg"></i></button>
            </div>
            <button onclick="sendMessage()" class="w-11 h-11 rounded-full bg-wa-primary text-white shadow-lg flex items-center justify-center btn-press mb-[2px] transition-all hover:bg-wa-dark">
                <i class="fas fa-microphone" id="sendIcon"></i>
            </button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-4 py-2 rounded-full opacity-0 pointer-events-none transition-opacity z-[150] shadow-lg"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, query, where, onSnapshot, doc, setDoc, getDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCwrfDXG8pRpkqDYht0EpRZ8h_ElRu0N_w",
            authDomain: "mysmartdiarypk.firebaseapp.com",
            projectId: "mysmartdiarypk",
            storageBucket: "mysmartdiarypk.firebasestorage.app",
            messagingSenderId: "989892082432",
            appId: "1:989892082432:web:684da193fde4a5915b51e5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let activeChatId = null;

        // --- AUTH LOGIC ---
        window.toggleAuthMode = (mode) => {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const tabLogin = document.getElementById('tabLogin');
            const tabSignup = document.getElementById('tabSignup');

            if(mode === 'login') {
                loginForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
                tabLogin.classList.add('bg-white', 'shadow', 'text-wa-primary');
                tabLogin.classList.remove('text-gray-500');
                tabSignup.classList.remove('bg-white', 'shadow', 'text-wa-primary');
                tabSignup.classList.add('text-gray-500');
            } else {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                tabSignup.classList.add('bg-white', 'shadow', 'text-wa-primary');
                tabSignup.classList.remove('text-gray-500');
                tabLogin.classList.remove('bg-white', 'shadow', 'text-wa-primary');
                tabLogin.classList.add('text-gray-500');
            }
        };

        window.authAction = async (type) => {
            const email = document.getElementById(type === 'login' ? 'loginEmail' : 'signupEmail').value;
            const pass = document.getElementById(type === 'login' ? 'loginPass' : 'signupPass').value;
            
            if(!email || !pass) return showToast("براہ کرم تمام خانے پُر کریں");
            
            showLoading(true);
            try {
                if(type === 'signup') {
                    const name = document.getElementById('signupName').value;
                    if(!name) throw new Error("نام لکھنا ضروری ہے");
                    
                    const cred = await createUserWithEmailAndPassword(auth, email, pass);
                    await updateProfile(cred.user, { displayName: name });
                    
                    // Create User Doc
                    await setDoc(doc(db, "users", cred.user.uid), {
                        displayName: name,
                        email: email,
                        uid: cred.user.uid,
                        createdAt: serverTimestamp(),
                        about: "Hey there! I am using WhatsApp."
                    });
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch(e) {
                showToast("ایرر: " + e.message);
                showLoading(false);
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if(user) {
                currentUser = user;
                // Update Name in UI if ready
                if(user.displayName) {
                    initApp();
                } else {
                    // Fallback for missing name
                    const docSnap = await getDoc(doc(db, "users", user.uid));
                    if(docSnap.exists() && docSnap.data().displayName) {
                        initApp();
                    } else {
                        // Edge case: logged in but no name set
                        initApp(); // Proceed anyway, can set in settings
                    }
                }
            } else {
                showLoading(false);
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        });

        function initApp() {
            showLoading(false);
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Setup Profile Data
            const name = currentUser.displayName || "User";
            document.getElementById('profileAvatarText').innerText = name[0].toUpperCase();
            document.getElementById('myStatusAvatar').innerText = name[0].toUpperCase();
            document.getElementById('editProfileName').value = name;
            document.getElementById('profileEmail').innerText = currentUser.email;

            loadChats();
        }

        // --- TABS ---
        window.switchTab = (tab) => {
            const tabs = ['chats', 'updates', 'calls'];
            tabs.forEach(t => {
                document.getElementById(`view${t.charAt(0).toUpperCase() + t.slice(1)}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('border-white', 'text-white');
                document.getElementById(`tab-${t}`).classList.add('border-transparent', 'text-wa-tab_inactive');
            });

            document.getElementById(`view${tab.charAt(0).toUpperCase() + tab.slice(1)}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('border-white', 'text-white');
            document.getElementById(`tab-${tab}`).classList.remove('border-transparent', 'text-wa-tab_inactive');
            
            // Adjust scroll container flex
            if(tab === 'chats') document.getElementById('viewChats').classList.add('flex-1');
        };

        // --- CHAT SYSTEM ---
        function loadChats() {
            // Remove orderBy from the query to avoid index requirement
            const q = query(collection(db, "chats"), where("participants", "array-contains", currentUser.uid));
            
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('chatList');
                list.innerHTML = "";
                
                if(snapshot.empty) {
                    list.innerHTML = `
                        <div class="flex flex-col items-center justify-center mt-20 opacity-50 px-10 text-center">
                            <i class="fas fa-comments text-6xl text-gray-300 mb-4"></i>
                            <p class="text-sm">ابھی تک کوئی چیٹ نہیں ہے۔ نیچے دیے گئے بٹن سے نئی چیٹ شروع کریں۔</p>
                        </div>`;
                    return;
                }

                let chats = [];
                snapshot.forEach(docSnap => {
                    chats.push({id: docSnap.id, ...docSnap.data()});
                });

                // Sort client-side
                chats.sort((a, b) => {
                    const dateA = a.lastUpdated ? a.lastUpdated.seconds : 0;
                    const dateB = b.lastUpdated ? b.lastUpdated.seconds : 0;
                    return dateB - dateA; // Descending
                });

                chats.forEach(chat => {
                    const chatId = chat.id;
                    
                    let chatName = "User";
                    let avatarInitial = "U";
                    const isGroup = chat.type === 'group';

                    if(isGroup) {
                        chatName = chat.groupName;
                        avatarInitial = chatName ? chatName[0] : "G";
                    } else {
                        // Extract other user's name
                        const otherId = chat.participants.find(id => id !== currentUser.uid);
                        chatName = (chat.names && chat.names[otherId]) ? chat.names[otherId] : "Unknown";
                        avatarInitial = chatName[0];
                    }

                    const date = chat.lastUpdated ? new Date(chat.lastUpdated.seconds * 1000) : new Date();
                    const timeStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                    const div = document.createElement('div');
                    div.className = "flex items-center gap-3 p-3 px-4 bg-white dark:bg-wa-dark hover:bg-gray-50 dark:hover:bg-wa-header/50 cursor-pointer active:bg-gray-100";
                    div.onclick = () => openChat(chatId, chatName, isGroup);
                    
                    div.innerHTML = `
                        <div class="w-12 h-12 rounded-full ${isGroup ? 'bg-gray-300' : 'bg-gray-200'} flex items-center justify-center text-lg font-bold text-white overflow-hidden flex-shrink-0 relative">
                             ${!isGroup && chatName ? `<div class="absolute inset-0 bg-gray-400 flex items-center justify-center text-white">${avatarInitial.toUpperCase()}</div>` : `<i class="fas fa-users text-gray-500"></i>`}
                        </div>
                        <div class="flex-1 min-w-0 border-b border-gray-100 dark:border-gray-800 pb-3">
                            <div class="flex justify-between items-baseline mb-0.5">
                                <h3 class="font-bold text-[16px] text-gray-900 dark:text-gray-100 truncate">${chatName}</h3>
                                <span class="text-[11px] text-gray-400 font-sans">${timeStr}</span>
                            </div>
                            <p class="text-[13px] text-gray-500 dark:text-gray-400 truncate urdu-text flex items-center gap-1">
                                <i class="fas fa-check-double text-[10px] text-gray-400"></i>
                                ${chat.lastMessage || "تصویر"}
                            </p>
                        </div>
                    `;
                    list.appendChild(div);
                });
            });
        }

        // --- NEW CHAT & GROUP ---
        window.openNewChatModal = () => {
            document.getElementById('newChatModal').classList.remove('hidden');
            loadAllUsers();
        };

        window.closeModal = (id) => {
            const modal = document.getElementById(id);
            modal.classList.remove('slide-in');
            modal.classList.add('slide-out');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('slide-out');
                modal.classList.add('slide-in'); // Reset for next open
            }, 200);
        };

        function loadAllUsers() {
            const list = document.getElementById('contactsList');
            list.innerHTML = '<div class="flex justify-center p-4"><div class="w-6 h-6 border-2 border-wa-primary border-t-transparent rounded-full animate-spin"></div></div>';
            
            // Fetch All Users (Demo: In prod, query contacts)
            const q = query(collection(db, "users"), orderBy('displayName'));
            onSnapshot(q, (snap) => {
                list.innerHTML = "";
                let count = 0;
                snap.forEach(d => {
                    if(d.id === currentUser.uid) return;
                    const u = d.data();
                    const div = document.createElement('div');
                    div.className = "flex items-center gap-3 p-3 hover:bg-gray-100 dark:hover:bg-gray-800 cursor-pointer rounded-lg";
                    div.onclick = () => startDirectChat(d.id, u.displayName);
                    div.innerHTML = `
                        <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-500">${u.displayName ? u.displayName[0].toUpperCase() : "?"}</div>
                        <div class="flex-1 border-b border-gray-100 dark:border-gray-700 pb-2">
                            <p class="font-bold text-sm text-gray-900 dark:text-gray-100">${u.displayName}</p>
                            <p class="text-xs text-gray-500 truncate">${u.about || "Available"}</p>
                        </div>
                    `;
                    list.appendChild(div);
                    count++;
                });
                document.getElementById('contactsCount').innerText = `${count} رابطے`;
            });
        }

        async function startDirectChat(otherUid, otherName) {
            closeModal('newChatModal');
            showLoading(true);
            
            const ids = [currentUser.uid, otherUid].sort();
            const chatId = ids.join("_");

            const chatRef = doc(db, "chats", chatId);
            const chatSnap = await getDoc(chatRef);

            if(!chatSnap.exists()) {
                await setDoc(chatRef, {
                    participants: ids,
                    type: 'private',
                    lastUpdated: serverTimestamp(),
                    lastMessage: '',
                    names: {
                        [currentUser.uid]: currentUser.displayName,
                        [otherUid]: otherName
                    }
                });
            }

            showLoading(false);
            openChat(chatId, otherName, false);
        }

        window.openCreateGroupModal = () => {
            closeModal('newChatModal');
            document.getElementById('createGroupModal').classList.remove('hidden');
            const list = document.getElementById('groupSelectionList');
            // Reuse logic but with checkboxes
            onSnapshot(collection(db, "users"), (snap) => {
                list.innerHTML = "";
                snap.forEach(d => {
                    if(d.id === currentUser.uid) return;
                    const u = d.data();
                    const div = document.createElement('div');
                    div.className = "flex items-center gap-3 p-2 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer rounded-lg";
                    div.onclick = (e) => {
                         // Toggle checkbox on row click
                         if(e.target.type !== 'checkbox') {
                             const cb = div.querySelector('input');
                             cb.checked = !cb.checked;
                         }
                    };
                    div.innerHTML = `
                        <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-500">${u.displayName ? u.displayName[0] : "?"}</div>
                        <div class="flex-1">
                            <p class="font-bold text-sm dark:text-white">${u.displayName}</p>
                        </div>
                        <input type="checkbox" value="${d.id}" class="w-5 h-5 accent-wa-primary group-checkbox">
                    `;
                    list.appendChild(div);
                });
            });
        };

        window.createGroup = async () => {
            const name = document.getElementById('newGroupName').value.trim();
            if(!name) return showToast("گروپ کا نام لکھیں");
            
            const checkboxes = document.querySelectorAll('.group-checkbox:checked');
            if(checkboxes.length === 0) return showToast("کم از کم ایک ممبر منتخب کریں");
            
            const selectedUids = Array.from(checkboxes).map(cb => cb.value);
            selectedUids.push(currentUser.uid);

            showLoading(true);
            try {
                const groupRef = await addDoc(collection(db, "chats"), {
                    type: 'group',
                    groupName: name,
                    participants: selectedUids,
                    createdBy: currentUser.uid,
                    lastUpdated: serverTimestamp(),
                    lastMessage: 'گروپ بن گیا'
                });
                
                showLoading(false);
                closeModal('createGroupModal');
                openChat(groupRef.id, name, true);
            } catch(e) {
                showToast(e.message);
                showLoading(false);
            }
        };

        // --- MESSAGING ---
        window.openChat = (chatId, title, isGroup) => {
            activeChatId = chatId;
            document.getElementById('chatRoom').classList.remove('hidden');
            
            document.getElementById('chatHeaderTitle').innerText = title;
            document.getElementById('chatHeaderAvatar').innerText = title ? title[0].toUpperCase() : "?";
            document.getElementById('chatHeaderStatus').innerText = isGroup ? "ممبرز کے لیے ٹیپ کریں" : "آن لائن";
            
            const q = query(collection(db, `chats/${chatId}/messages`), orderBy('createdAt', 'asc'));
            
            onSnapshot(q, (snap) => {
                const container = document.getElementById('messagesContainer');
                container.innerHTML = "";
                
                let lastDate = "";

                snap.forEach(d => {
                    const msg = d.data();
                    const isMe = msg.senderId === currentUser.uid;
                    const time = msg.createdAt ? new Date(msg.createdAt.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "";
                    
                    const div = document.createElement('div');
                    div.className = `flex w-full mb-1 ${isMe ? 'justify-end' : 'justify-start'}`;
                    
                    const senderHtml = (isGroup && !isMe) ? `<p class="text-[10px] font-bold text-orange-600 mb-0.5">${msg.senderName}</p>` : '';
                    const tailClass = isMe ? 'rounded-tr-none' : 'rounded-tl-none';
                    const bgClass = isMe ? 'bg-wa-chat_me dark:bg-wa-chat_dark_me' : 'bg-white dark:bg-wa-chat_dark_other';

                    div.innerHTML = `
                        <div class="max-w-[75%] p-1.5 px-2.5 shadow-sm rounded-lg ${tailClass} ${bgClass} relative text-sm group">
                            ${senderHtml}
                            <p class="urdu-text leading-relaxed whitespace-pre-wrap dark:text-gray-100 pb-1">${msg.text}</p>
                            <div class="flex justify-end items-end gap-1 select-none float-right ml-2 mt-[-5px]">
                                <span class="text-[10px] text-gray-500 dark:text-gray-400 font-sans">${time}</span>
                                ${isMe ? `<i class="fas fa-check-double text-[10px] tick-read"></i>` : ''}
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
                container.scrollTop = container.scrollHeight;
            });
        };

        window.closeChatRoom = () => {
            activeChatId = null;
            document.getElementById('chatRoom').classList.add('hidden');
        };

        window.sendMessage = async () => {
            if(!activeChatId) return;
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            const btnIcon = document.getElementById('sendIcon');

            if(!text) return; // In real WA this switches to mic
            
            input.value = "";
            autoResize(input);
            btnIcon.className = "fas fa-microphone"; // Reset icon
            
            try {
                await addDoc(collection(db, `chats/${activeChatId}/messages`), {
                    text: text,
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName,
                    createdAt: serverTimestamp()
                });
                
                await updateDoc(doc(db, "chats", activeChatId), {
                    lastMessage: text,
                    lastUpdated: serverTimestamp()
                });
            } catch(e) {
                showToast("پیغام فیل ہو گیا");
            }
        };

        // --- PROFILE ---
        window.openProfileModal = () => {
            document.getElementById('profileModal').classList.remove('hidden');
        };
        
        window.enableEditName = () => {
            const input = document.getElementById('editProfileName');
            const btn = document.getElementById('saveProfileBtn');
            input.disabled = false;
            input.focus();
            input.classList.remove('bg-transparent');
            input.classList.add('bg-white', 'dark:bg-gray-600', 'border-b-2', 'border-wa-primary');
            btn.classList.remove('hidden');
        };

        window.saveProfile = async () => {
            const newName = document.getElementById('editProfileName').value.trim();
            if(!newName) return;
            
            showLoading(true);
            try {
                await updateProfile(currentUser, { displayName: newName });
                await updateDoc(doc(db, "users", currentUser.uid), { displayName: newName });
                showLoading(false);
                closeModal('profileModal');
                initApp(); // Refresh UI
                showToast("پروفائل اپ ڈیٹ ہو گئی");
            } catch(e) {
                showToast(e.message);
                showLoading(false);
            }
        };

        // --- UTILS ---
        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 3000);
        };
        
        window.showLoading = (show) => document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
        
        window.toggleTheme = () => document.documentElement.classList.toggle('dark');
        
        window.autoResize = (el) => {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
            const btnIcon = document.getElementById('sendIcon');
            if(el.value.trim().length > 0) {
                 btnIcon.className = "fas fa-paper-plane";
            } else {
                 btnIcon.className = "fas fa-microphone";
            }
        };
        
        window.signOutApp = () => {
            signOut(auth);
            location.reload();
        };

    </script>
</body>
</html>
