<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…ÛŒØ±ÛŒ Ø§Ø³Ù…Ø§Ø±Ù¹ ÚˆØ§Ø¦Ø±ÛŒ Ù¾Ø±Ùˆ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkbg: '#0f172a',
                        darkcard: '#1e293b',
                        darkinput: '#334155',
                        brand: {
                            light: '#10b981',
                            dark: '#064e3b',
                        }
                    },
                    fontFamily: {
                        urdu: ['Noto Nastaliq Urdu', 'serif'],
                        sans: ['Noto Sans Arabic', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <!-- Urdu Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans Arabic', sans-serif; -webkit-tap-highlight-color: transparent; }
        h1, h2, h3, .urdu-text, button, input, select, option, textarea { font-family: 'Noto Nastaliq Urdu', serif; line-height: 2.0; }
        .mobile-container { max-width: 480px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; position: relative; }
        .btn-press:active { transform: scale(0.97); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .floating-input {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            max-width: 460px;
            border-radius: 24px;
            z-index: 40;
        }

        .calendar-dot { width: 6px; height: 6px; background-color: #10b981; border-radius: 50%; margin-top: 2px; }
        
        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-down { animation: slideDown 0.3s ease-out forwards; }
        
        /* Modern Date Style */
        .date-badge {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
        }
        .dark .date-badge {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }
    </style>
</head>
<body class="text-gray-800 bg-slate-100 dark:bg-black transition-colors duration-300">

    <div class="mobile-container bg-white dark:bg-darkbg shadow-2xl relative overflow-hidden">
        
        <!-- Auth Section -->
        <div id="authSection" class="flex-1 flex flex-col justify-center p-6 bg-emerald-50 dark:bg-slate-900 z-50 absolute inset-0 h-full">
            <div class="text-center mb-10">
                <div class="bg-white dark:bg-slate-800 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 shadow-md text-4xl">ğŸ“–</div>
                <h1 class="text-3xl font-bold text-emerald-800 dark:text-emerald-400">Ù…ÛŒØ±ÛŒ ÚˆØ§Ø¦Ø±ÛŒ Ù¾Ø±Ùˆ</h1>
                <p class="text-sm text-emerald-600 dark:text-emerald-300 font-sans mt-1">Ø­Ø³Ø§Ø¨ Ú©ØªØ§Ø¨ Ø§ÙˆØ± ÚˆØ§Ø¦Ø±ÛŒ Ø§ÛŒÚ© Ø³Ø§ØªÚ¾</p>
            </div>

            <div id="loginForm" class="bg-white dark:bg-darkcard p-6 rounded-3xl shadow-xl border border-emerald-100 dark:border-slate-700">
                <h2 class="text-xl font-bold text-center mb-6 text-slate-700 dark:text-slate-200">Ù„Ø§Ú¯ Ø§Ù† Ú©Ø±ÛŒÚº</h2>
                <div class="space-y-4">
                    <input type="email" id="loginEmail" placeholder="Ø§ÛŒ Ù…ÛŒÙ„" class="w-full p-3 bg-slate-50 dark:bg-darkinput dark:text-white border border-slate-200 dark:border-slate-600 rounded-xl outline-none font-sans" dir="ltr">
                    <input type="password" id="loginPass" placeholder="Ù¾Ø§Ø³ÙˆØ±Úˆ" class="w-full p-3 bg-slate-50 dark:bg-darkinput dark:text-white border border-slate-200 dark:border-slate-600 rounded-xl outline-none font-sans" dir="ltr">
                </div>
                <button onclick="window.loginUser()" class="w-full mt-6 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl btn-press shadow-lg">Ø¯Ø§Ø®Ù„ ÛÙˆÚº</button>
                <div class="mt-8 pt-6 border-t border-slate-100 dark:border-slate-700 text-center">
                    <button onclick="window.showScreen('signupForm')" class="text-emerald-600 dark:text-emerald-400 font-bold hover:underline">Ù†ÛŒØ§ Ø§Ú©Ø§Ø¤Ù†Ù¹ Ø¨Ù†Ø§Ø¦ÛŒÚº</button>
                </div>
            </div>

            <div id="signupForm" class="hidden bg-white dark:bg-darkcard p-6 rounded-3xl shadow-xl border border-emerald-100 dark:border-slate-700">
                <h2 class="text-xl font-bold text-center mb-6 text-slate-700 dark:text-slate-200">Ø±Ø¬Ø³Ù¹Ø±ÛŒØ´Ù†</h2>
                <div class="space-y-4">
                    <input type="email" id="signupEmail" placeholder="Ø§ÛŒ Ù…ÛŒÙ„ Ù„Ú©Ú¾ÛŒÚº" class="w-full p-3 bg-slate-50 dark:bg-darkinput dark:text-white border border-slate-200 dark:border-slate-600 rounded-xl font-sans" dir="ltr">
                    <input type="password" id="signupPass" placeholder="Ù¾Ø§Ø³ÙˆØ±Úˆ" class="w-full p-3 bg-slate-50 dark:bg-darkinput dark:text-white border border-slate-200 dark:border-slate-600 rounded-xl font-sans" dir="ltr">
                </div>
                <button onclick="window.signupUser()" class="w-full mt-6 bg-emerald-600 text-white font-bold py-3 rounded-xl btn-press">Ø§Ú©Ø§Ø¤Ù†Ù¹ Ø¨Ù†Ø§Ø¦ÛŒÚº</button>
                <button onclick="window.showScreen('loginForm')" class="w-full mt-3 text-slate-400 py-2 text-sm font-sans">ÙˆØ§Ù¾Ø³ Ø¬Ø§Ø¦ÛŒÚº</button>
            </div>
        </div>

        <!-- App Section -->
        <div id="appSection" class="hidden flex flex-col h-screen bg-slate-50 dark:bg-darkbg relative">
            
            <!-- Dynamic Header -->
            <header class="bg-emerald-600 dark:bg-emerald-900 pt-4 pb-2 text-white shadow-lg z-30 sticky top-0 transition-all duration-500">
                <div class="px-5 flex justify-between items-center h-12">
                    <div class="flex flex-col">
                        <h2 class="text-xl font-bold leading-tight">Ù…ÛŒØ±ÛŒ ÚˆØ§Ø¦Ø±ÛŒ Ù¾Ø±Ùˆ</h2>
                        <span id="headerSub" class="text-[10px] text-emerald-100 font-sans opacity-80">Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!</span>
                    </div>
                    
                    <div class="flex items-center gap-3">
                        <button onclick="window.toggleCalendar()" id="calBtn" class="bg-emerald-500/30 p-2 rounded-xl hover:bg-emerald-500/50 transition">ğŸ“…</button>
                        <button onclick="window.toggleDarkMode()" class="bg-emerald-500/30 p-2 rounded-xl hover:bg-emerald-500/50 transition"><span id="darkModeIcon">ğŸŒ™</span></button>
                        <div onclick="window.logoutUser()" id="userAvatar" class="w-9 h-9 rounded-full bg-white text-emerald-700 flex items-center justify-center font-bold text-sm cursor-pointer border-2 border-emerald-400">U</div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="px-5 mt-4">
                    <div class="flex p-1 bg-emerald-700/50 dark:bg-slate-900/50 rounded-2xl relative">
                        <div id="tabIndicator" class="absolute top-1 bottom-1 w-[48%] bg-white dark:bg-slate-700 shadow-md rounded-xl transition-all duration-300 left-1"></div>
                        <button onclick="window.switchTab('diary')" id="btnDiary" class="flex-1 py-2 text-sm font-bold relative z-10 text-emerald-900 dark:text-emerald-100 transition-colors">ÚˆØ§Ø¦Ø±ÛŒ ğŸ“–</button>
                        <button onclick="window.switchTab('finance')" id="btnFinance" class="flex-1 py-2 text-sm font-bold relative z-10 text-white opacity-70 transition-colors">Ú©ÛŒØ´ Ø¨Ú© ğŸ’°</button>
                    </div>
                </div>
            </header>

            <!-- Interactive Calendar -->
            <div id="calendarView" class="hidden absolute top-[135px] left-0 right-0 bg-white dark:bg-darkcard shadow-2xl z-40 p-5 rounded-3xl border border-slate-200 dark:border-slate-700 mx-5 animate-slide-down">
                <div class="flex justify-between items-center mb-5">
                    <button onclick="window.changeMonth(-1)" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-full hover:bg-emerald-50 dark:text-white">â—€</button>
                    <h3 id="currentMonthYear" class="text-lg font-bold text-slate-800 dark:text-emerald-400 urdu-text"></h3>
                    <button onclick="window.changeMonth(1)" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-full hover:bg-emerald-50 dark:text-white">â–¶</button>
                </div>
                <div class="grid grid-cols-7 gap-2 text-center font-sans text-[10px] text-slate-400 font-bold mb-2">
                    <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 gap-2 text-center font-sans"></div>
                <div class="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700 flex justify-between items-center">
                    <span class="text-[10px] text-slate-400 font-sans italic">* ØªØ§Ø±ÛŒØ® Ù¾Ø± Ú©Ù„Ú© Ú©Ø±ÛŒÚº</span>
                    <button onclick="window.toggleCalendar()" class="text-xs text-red-500 font-bold urdu-text">Ø¨Ù†Ø¯ Ú©Ø±ÛŒÚº</button>
                </div>
            </div>

            <!-- Content Area -->
            <div id="mainContent" class="flex-1 overflow-hidden flex flex-col">
                
                <!-- DIARY VIEW -->
                <div id="diaryView" class="flex-1 flex flex-col overflow-hidden">
                    <div class="px-5 py-3 bg-emerald-50 dark:bg-slate-900 shadow-inner">
                        <div class="relative">
                            <input type="text" id="searchInput" placeholder="Ù†ÙˆÙ¹Ø³ Ù…ÛŒÚº ØªÙ„Ø§Ø´ Ú©Ø±ÛŒÚº..." class="w-full p-3 pr-10 bg-white dark:bg-darkinput dark:text-white rounded-2xl text-sm outline-none shadow-sm urdu-text" oninput="window.filterData()">
                            <span class="absolute right-3 top-3 opacity-40">ğŸ”</span>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto p-5 no-scrollbar" id="diaryScroll">
                        <div id="filterHeader" class="hidden bg-emerald-100 dark:bg-emerald-900/40 p-2 rounded-xl mb-4 text-center">
                            <span id="filterText" class="text-xs font-bold text-emerald-700 dark:text-emerald-300 urdu-text">ØªØ§Ø±ÛŒØ® ÙÙ„Ù¹Ø±</span>
                            <button onclick="window.clearFilter()" class="mr-2 text-red-500 text-xs font-bold">ØµØ§Ù Ú©Ø±ÛŒÚº âœ–</button>
                        </div>
                        <ul id="taskList" class="space-y-4 pb-48"></ul>
                    </div>

                    <!-- Floating Entry for Diary -->
                    <div class="floating-input bg-white dark:bg-darkcard border border-slate-100 dark:border-slate-700 p-4 shadow-2xl">
                        <div class="flex flex-col gap-3">
                            <div class="flex gap-2">
                                <input type="datetime-local" id="taskDate" class="flex-[1.5] p-2 bg-slate-50 dark:bg-darkinput dark:text-white rounded-xl text-[10px] outline-none font-sans border border-slate-100 dark:border-slate-600">
                                <select id="taskCategory" class="flex-1 bg-slate-50 dark:bg-darkinput dark:text-white text-[10px] rounded-xl outline-none p-2 border border-slate-100 dark:border-slate-600">
                                    <option value="Ø¹Ø§Ù…">ğŸ“Œ Ø¹Ø§Ù…</option><option value="Ø°Ø§ØªÛŒ">ğŸ‘¤ Ø°Ø§ØªÛŒ</option><option value="Ú©Ø§Ù…">ğŸ’¼ Ú©Ø§Ù…</option><option value="Ø¶Ø±ÙˆØ±ÛŒ">ğŸ”¥ Ø¶Ø±ÙˆØ±ÛŒ</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="text" id="taskInput" placeholder="Ø¢Ø¬ Ú©ÛŒØ§ Ù„Ú©Ú¾Ù†Ø§ ÛÛ’ØŸ" class="flex-1 p-3 bg-slate-50 dark:bg-darkinput dark:text-white rounded-2xl outline-none urdu-text shadow-inner border border-slate-100 dark:border-slate-600">
                                <input type="hidden" id="editTaskId" value="">
                                <button onclick="window.addTask()" id="saveBtn" class="bg-emerald-600 text-white p-3.5 rounded-2xl shadow-lg btn-press">
                                    <svg id="saveIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FINANCE VIEW -->
                <div id="financeView" class="hidden flex-1 flex flex-col overflow-y-auto no-scrollbar pb-32">
                    <div class="p-5">
                        <div class="bg-gradient-to-br from-emerald-600 to-teal-700 rounded-3xl p-6 text-white shadow-xl mb-5">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <p class="text-emerald-100 text-xs font-sans">Ú©Ù„ Ø¨ÛŒÙ„Ù†Ø³</p>
                                    <h2 class="text-4xl font-bold font-sans mt-1" id="finBalance">0</h2>
                                </div>
                                <div class="bg-white/20 p-3 rounded-2xl text-2xl">ğŸ’°</div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-white/10 p-3 rounded-2xl backdrop-blur-sm">
                                    <p class="text-[10px] opacity-80 mb-1">Ø¢Ù…Ø¯Ù† (In)</p>
                                    <h3 class="text-xl font-bold font-sans" id="finTotalIn">0</h3>
                                </div>
                                <div class="bg-black/10 p-3 rounded-2xl backdrop-blur-sm">
                                    <p class="text-[10px] opacity-80 mb-1">Ø®Ø±Ú† (Out)</p>
                                    <h3 class="text-xl font-bold font-sans" id="finTotalOut">0</h3>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-darkcard p-5 rounded-3xl shadow-md border dark:border-slate-700 mb-6">
                            <div class="flex gap-2 p-1 bg-slate-100 dark:bg-darkinput rounded-2xl mb-4">
                                <button onclick="window.setTransType('in')" id="btnTypeIn" class="flex-1 py-2 text-xs font-bold rounded-xl transition bg-white text-emerald-600 shadow-sm">Ø¢Ù…Ø¯Ù† (In)</button>
                                <button onclick="window.setTransType('out')" id="btnTypeOut" class="flex-1 py-2 text-xs font-bold rounded-xl transition text-slate-500">Ø®Ø±Ú† (Out)</button>
                            </div>
                            <div class="flex gap-3 mb-4">
                                <input type="number" id="transAmount" placeholder="Ø±Ù‚Ù…" class="w-1/3 p-3 bg-slate-50 dark:bg-darkinput dark:text-white rounded-xl outline-none font-sans font-bold text-center">
                                <input type="text" id="transDesc" placeholder="ØªÙØµÛŒÙ„..." class="flex-1 p-3 bg-slate-50 dark:bg-darkinput dark:text-white rounded-xl outline-none urdu-text text-right">
                            </div>
                            <button onclick="window.addTransaction()" class="w-full bg-slate-800 dark:bg-emerald-700 text-white font-bold py-3 rounded-2xl shadow-lg btn-press">Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚº</button>
                        </div>

                        <div id="financeFilterHeader" class="hidden bg-emerald-100 dark:bg-emerald-900/40 p-2 rounded-xl mb-4 text-center">
                            <span id="finFilterText" class="text-xs font-bold text-emerald-700 dark:text-emerald-300 urdu-text">ØªØ§Ø±ÛŒØ® ÙÙ„Ù¹Ø±</span>
                            <button onclick="window.clearFilter()" class="mr-2 text-red-500 text-xs font-bold">ØµØ§Ù Ú©Ø±ÛŒÚº âœ–</button>
                        </div>
                        <h3 class="text-xs font-bold text-slate-400 mb-4 px-2">Ø­Ø§Ù„ÛŒÛ Ù„ÛŒÙ† Ø¯ÛŒÙ†</h3>
                        <ul id="transList" class="space-y-3"></ul>
                    </div>
                </div>
            </div>

            <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-emerald-800 text-white text-[11px] px-6 py-2.5 rounded-full shadow-2xl opacity-0 transition-all duration-300 pointer-events-none z-50 font-sans">Ù¾ÛŒØºØ§Ù…</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, query, where, onSnapshot, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCwrfDXG8pRpkqDYht0EpRZ8h_ElRu0N_w",
            authDomain: "mysmartdiarypk.firebaseapp.com",
            projectId: "mysmartdiarypk",
            storageBucket: "mysmartdiarypk.firebasestorage.app",
            messagingSenderId: "989892082432",
            appId: "1:989892082432:web:684da193fde4a5915b51e5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let allTasks = [];
        let allTrans = [];
        let filterDate = null;
        let currentMonth = new Date();
        let currentTransType = 'in';

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('authSection').classList.add('hidden');
                document.getElementById('appSection').classList.remove('hidden');
                document.getElementById('userAvatar').innerText = user.email.charAt(0).toUpperCase();
                loadAllData();
                setDefaultDateTime();
                loadTheme();
            } else {
                currentUser = null;
                document.getElementById('authSection').classList.remove('hidden');
                document.getElementById('appSection').classList.add('hidden');
            }
        });

        function loadAllData() {
            const qTasks = query(collection(db, "tasks"), where("uid", "==", currentUser.uid));
            onSnapshot(qTasks, (snap) => {
                allTasks = []; snap.forEach(d => allTasks.push({id: d.id, ...d.data()}));
                applyDisplay();
                renderCalendar();
            });

            const qTrans = query(collection(db, "transactions"), where("uid", "==", currentUser.uid));
            onSnapshot(qTrans, (snap) => {
                allTrans = []; snap.forEach(d => allTrans.push({id: d.id, ...d.data()}));
                applyDisplay();
                renderCalendar();
            });
        }

        function applyDisplay() {
            const searchInput = document.getElementById('searchInput');
            const search = searchInput ? searchInput.value.toLowerCase() : '';
            
            let filteredTasks = [...allTasks];
            if (filterDate) filteredTasks = filteredTasks.filter(t => t.dateDue && t.dateDue.startsWith(filterDate));
            if (search) filteredTasks = filteredTasks.filter(t => t.text.toLowerCase().includes(search));
            filteredTasks.sort((a,b) => new Date(b.dateDue || 0) - new Date(a.dateDue || 0));
            renderTasks(filteredTasks);

            let filteredTrans = [...allTrans];
            if (filterDate) filteredTrans = filteredTrans.filter(t => t.date && t.date.startsWith(filterDate));
            filteredTrans.sort((a,b) => new Date(b.date || 0) - new Date(a.date || 0));
            renderTransactions(filteredTrans);

            const sub = document.getElementById('headerSub');
            if(sub) sub.innerText = filterDate ? `ÚˆÛŒÙ¹Ø§ Ø¨Ø±Ø§Ø¦Û’: ${filterDate}` : "Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!";
        }

        function renderTasks(tasks) {
            const ul = document.getElementById('taskList');
            if(!ul) return;
            ul.innerHTML = tasks.length === 0 ? '<p class="text-center text-xs opacity-50 mt-10">Ú©ÙˆØ¦ÛŒ Ù†ÙˆÙ¹Ø³ Ù†ÛÛŒÚº</p>' : '';
            tasks.forEach(task => {
                const li = document.createElement('li');
                li.className = "bg-white dark:bg-darkcard p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 transition-all active:scale-[0.98]";
                
                const formattedDate = task.dateDue ? task.dateDue.replace('T', ' ') : 'Ø¨ØºÛŒØ± ØªØ§Ø±ÛŒØ®';
                
                li.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="date-badge font-sans">${formattedDate}</span>
                        <span class="text-[9px] bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 px-2 py-0.5 rounded-full font-bold">${task.category}</span>
                    </div>
                    <p class="urdu-text text-lg dark:text-slate-200 text-right leading-relaxed mb-3">${task.text}</p>
                    <div class="flex justify-end gap-4 border-t border-slate-50 dark:border-slate-700 pt-3">
                        <button onclick="window.editTask('${task.id}')" class="text-[11px] text-emerald-500 font-bold urdu-text">ØªØ¨Ø¯ÛŒÙ„ Ú©Ø±ÛŒÚº âœï¸</button>
                        <button onclick="window.deleteDocById('tasks', '${task.id}')" class="text-[11px] text-red-400 font-bold urdu-text">Ø­Ø°Ù Ú©Ø±ÛŒÚº ğŸ—‘ï¸</button>
                    </div>
                `;
                ul.appendChild(li);
            });
        }

        function renderTransactions(trans) {
            const ul = document.getElementById('transList');
            if(!ul) return;
            let tin = 0, tout = 0;
            ul.innerHTML = "";
            
            allTrans.forEach(t => { if(t.type === 'in') tin += t.amount; else tout += t.amount; });
            document.getElementById('finTotalIn').innerText = tin.toLocaleString();
            document.getElementById('finTotalOut').innerText = tout.toLocaleString();
            document.getElementById('finBalance').innerText = (tin - tout).toLocaleString();

            trans.forEach(t => {
                const isIn = t.type === 'in';
                const li = document.createElement('li');
                li.className = "flex justify-between items-center p-4 bg-white dark:bg-darkcard rounded-2xl border dark:border-slate-700 shadow-sm";
                li.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full ${isIn?'bg-emerald-100 text-emerald-600':'bg-red-100 text-red-600'} flex items-center justify-center font-bold">${isIn?'â†“':'â†‘'}</div>
                        <div class="text-right">
                            <p class="urdu-text text-sm dark:text-white font-bold">${t.description}</p>
                            <p class="date-badge inline-block mt-1 font-sans">${t.date}</p>
                        </div>
                    </div>
                    <div class="text-left">
                        <p class="${isIn?'text-emerald-600':'text-red-500'} font-bold font-sans text-lg">${t.amount.toLocaleString()}</p>
                        <button onclick="window.deleteDocById('transactions', '${t.id}')" class="text-[9px] text-slate-300">Ù…Ù¹Ø§Ø¦ÛŒÚº</button>
                    </div>
                `;
                ul.appendChild(li);
            });
        }

        // Window exposed functions
        window.loginUser = async () => {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            try { await signInWithEmailAndPassword(auth, email, pass); }
            catch(e) { showToast("Ù„Ø§Ú¯ Ø§Ù† Ù†Ø§Ú©Ø§Ù… Ø±ÛØ§"); }
        };

        window.signupUser = async () => {
            const email = document.getElementById('signupEmail').value;
            const pass = document.getElementById('signupPass').value;
            try { await createUserWithEmailAndPassword(auth, email, pass); }
            catch(e) { showToast("Ø±Ø¬Ø³Ù¹Ø±ÛŒØ´Ù† Ù†ÛÛŒÚº ÛÙˆ Ø³Ú©ÛŒ"); }
        };

        window.logoutUser = () => signOut(auth);

        window.showScreen = (id) => {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById(id).classList.remove('hidden');
        };

        window.editTask = (id) => {
            const task = allTasks.find(t => t.id === id);
            if(task) {
                document.getElementById('taskInput').value = task.text;
                document.getElementById('taskDate').value = task.dateDue || "";
                document.getElementById('taskCategory').value = task.category || "Ø¹Ø§Ù…";
                document.getElementById('editTaskId').value = id;
                document.getElementById('saveIcon').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />';
                document.getElementById('taskInput').focus();
                showToast("Ø§ÛŒÚˆÙ¹ Ù…ÙˆÚˆ Ø¢Ù† ÛÛ’");
            }
        };

        window.addTask = async () => {
            const text = document.getElementById('taskInput').value.trim();
            const editId = document.getElementById('editTaskId').value;
            if(!text) return showToast("Ú©Ú†Ú¾ Ù„Ú©Ú¾ÛŒÚº!");
            
            try {
                if(editId) {
                    await updateDoc(doc(db, "tasks", editId), {
                        text,
                        dateDue: document.getElementById('taskDate').value,
                        category: document.getElementById('taskCategory').value
                    });
                    document.getElementById('editTaskId').value = "";
                    document.getElementById('saveIcon').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />';
                    showToast("ØªØ¨Ø¯ÛŒÙ„ÛŒ Ù…Ø­ÙÙˆØ¸ ÛÙˆ Ú¯Ø¦ÛŒ âœ¨");
                } else {
                    await addDoc(collection(db, "tasks"), {
                        text, uid: currentUser.uid, 
                        dateDue: document.getElementById('taskDate').value,
                        category: document.getElementById('taskCategory').value,
                        createdAt: serverTimestamp()
                    });
                    showToast("Ù…Ø­ÙÙˆØ¸ ÛÙˆ Ú¯ÛŒØ§ âœ…");
                }
                document.getElementById('taskInput').value = "";
                setDefaultDateTime();
            } catch(e) { showToast("Ø§ÛŒØ±Ø± Ù¾ÛŒØ´ Ø¢ÛŒØ§"); }
        };

        window.addTransaction = async () => {
            const amount = parseFloat(document.getElementById('transAmount').value);
            const desc = document.getElementById('transDesc').value.trim();
            if(!amount || !desc) return showToast("ØªÙØµÛŒÙ„ Ù…Ú©Ù…Ù„ Ú©Ø±ÛŒÚº");
            try {
                await addDoc(collection(db, "transactions"), {
                    amount, description: desc, uid: currentUser.uid,
                    type: currentTransType, date: new Date().toISOString().split('T')[0],
                    createdAt: serverTimestamp()
                });
                document.getElementById('transAmount').value = "";
                document.getElementById('transDesc').value = "";
                showToast("Ø­Ø³Ø§Ø¨ Ù…Ø­ÙÙˆØ¸ ÛÙˆ Ú¯ÛŒØ§ ğŸ’°");
            } catch(e) { showToast("Ø§ÛŒØ±Ø± Ù¾ÛŒØ´ Ø¢ÛŒØ§"); }
        };

        window.deleteDocById = async (coll, id) => {
            if(confirm("ÚˆÛŒÙ„ÛŒÙ¹ Ú©Ø± Ø¯ÛŒÚºØŸ")) {
                await deleteDoc(doc(db, coll, id));
                showToast("Ø­Ø°Ù Ú©Ø± Ø¯ÛŒØ§ Ú¯ÛŒØ§");
            }
        };

        window.switchTab = (tab) => {
            const isDiary = tab === 'diary';
            document.getElementById('diaryView').classList.toggle('hidden', !isDiary);
            document.getElementById('financeView').classList.toggle('hidden', isDiary);
            document.getElementById('tabIndicator').style.left = isDiary ? '1%' : '51%';
            
            const btnD = document.getElementById('btnDiary');
            const btnF = document.getElementById('btnFinance');
            if(isDiary) {
                btnD.classList.add('text-emerald-900', 'dark:text-emerald-100'); btnD.classList.remove('opacity-70', 'text-white');
                btnF.classList.add('opacity-70', 'text-white'); btnF.classList.remove('text-emerald-900', 'dark:text-emerald-100');
            } else {
                btnF.classList.add('text-emerald-900', 'dark:text-emerald-100'); btnF.classList.remove('opacity-70', 'text-white');
                btnD.classList.add('opacity-70', 'text-white'); btnD.classList.remove('text-emerald-900', 'dark:text-emerald-100');
            }
        };

        window.setTransType = (type) => {
            currentTransType = type;
            document.getElementById('btnTypeIn').classList.toggle('bg-white', type === 'in');
            document.getElementById('btnTypeIn').classList.toggle('text-emerald-600', type === 'in');
            document.getElementById('btnTypeOut').classList.toggle('bg-white', type === 'out');
            document.getElementById('btnTypeOut').classList.toggle('text-red-600', type === 'out');
        };

        window.toggleCalendar = () => document.getElementById('calendarView').classList.toggle('hidden');

        window.changeMonth = (val) => {
            currentMonth.setMonth(currentMonth.getMonth() + val);
            renderCalendar();
        };

        window.clearFilter = () => {
            filterDate = null;
            applyDisplay();
            document.getElementById('filterHeader').classList.add('hidden');
            document.getElementById('financeFilterHeader').classList.add('hidden');
            showToast("ÙÙ„Ù¹Ø± Ø®ØªÙ… Ú©Ø± Ø¯ÛŒØ§ Ú¯ÛŒØ§");
        };

        window.filterData = () => applyDisplay();

        window.toggleDarkMode = () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            document.getElementById('darkModeIcon').innerText = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            renderCalendar(); // Re-render to apply color updates
        };

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthHeader = document.getElementById('currentMonthYear');
            if(!grid || !monthHeader) return;
            grid.innerHTML = "";
            
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            monthHeader.innerText = currentMonth.toLocaleString('default', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for(let i=0; i<firstDay; i++) grid.innerHTML += '<div></div>';

            for(let d=1; d<=daysInMonth; d++) {
                const dStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const hasTask = allTasks.some(t => t.dateDue && t.dateDue.startsWith(dStr));
                const hasTrans = allTrans.some(t => t.date === dStr);
                const isToday = new Date().toISOString().split('T')[0] === dStr;

                const dayBtn = document.createElement('button');
                dayBtn.className = `h-10 w-10 flex flex-col items-center justify-center rounded-xl relative transition-all duration-200 border border-transparent 
                                    ${isToday?'bg-emerald-600 text-white shadow-lg z-10 scale-110':'text-slate-700 dark:text-slate-100 hover:bg-emerald-50 dark:hover:bg-slate-700 hover:border-emerald-200'}`;
                dayBtn.innerHTML = `<span class="${(hasTask||hasTrans)?'font-bold':''}">${d}</span>`;
                if(hasTask || hasTrans) dayBtn.innerHTML += `<div class="calendar-dot ${isToday?'bg-white':'bg-emerald-500'}"></div>`;
                
                dayBtn.onclick = () => {
                    filterDate = dStr;
                    applyDisplay();
                    toggleCalendar();
                    document.getElementById('filterHeader').classList.remove('hidden');
                    document.getElementById('financeFilterHeader').classList.remove('hidden');
                    document.getElementById('filterText').innerText = `ÙÙ„Ù¹Ø±: ${dStr}`;
                    document.getElementById('finFilterText').innerText = `ÙÙ„Ù¹Ø±: ${dStr}`;
                };
                grid.appendChild(dayBtn);
            }
        }

        function setDefaultDateTime() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            const dateInput = document.getElementById('taskDate');
            if(dateInput) dateInput.value = now.toISOString().slice(0, 16);
        }

        function loadTheme() {
            if(localStorage.getItem('theme') === 'dark') {
                document.documentElement.classList.add('dark');
                const icon = document.getElementById('darkModeIcon');
                if(icon) icon.innerText = 'â˜€ï¸';
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            if(!t) return;
            t.innerText = msg; t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 3000);
        }

    </script>
</body>
</html>
