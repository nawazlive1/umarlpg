<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- App Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#202123">
    <meta name="application-name" content="Ø´Ø§Û Ù†ÙˆØ§Ø² AI">
    
    <title>Ø´Ø§Û Ù†ÙˆØ§Ø² Ø§Û’ Ø¢Ø¦ÛŒ - Ú†ÛŒÙ¹ ÛØ³Ù¹Ø±ÛŒ Ú©Û’ Ø³Ø§ØªÚ¾</title>
    
    <!-- Nastaliq Font Import -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400..700&display=swap" rel="stylesheet">
    <!-- Icon for Sidebar -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- App Icon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ•Œ</text></svg>">

    <style>
        :root {
            --bg-color: #343541;
            --sidebar-bg: #202123;
            --chat-bg: #343541;
            --user-msg-bg: #10a37f;
            --ai-msg-bg: #444654;
            --text-color: #ececf1;
            --input-bg: #40414f;
            --border-color: #565869;
            --hover-color: #2A2B32;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Noto Nastaliq Urdu', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            height: 100dvh;
            margin: 0;
            overflow: hidden;
        }

        /* Sidebar Styling */
        .sidebar {
            width: 260px;
            background-color: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            padding: 10px;
            border-left: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.3s ease;
            position: absolute;
            height: 100%;
            z-index: 20;
            right: 0; /* RTL Sidebar */
        }

        .sidebar.closed {
            transform: translateX(100%);
        }

        /* Mobile Overlay for Sidebar */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 15;
        }
        .sidebar-overlay.active {
            display: block;
        }

        .new-chat-btn {
            background-color: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            text-align: right; /* RTL */
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-family: 'Noto Nastaliq Urdu', sans-serif;
            transition: background 0.2s;
        }

        .new-chat-btn:hover {
            background-color: var(--hover-color);
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .history-item {
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.9em;
            color: #ececf1;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }

        .history-item:hover {
            background-color: var(--hover-color);
        }
        
        .history-item.active {
            background-color: #343541;
            border: 1px solid #444654;
        }

        /* Main Chat Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background-color: var(--chat-bg);
            width: 100%;
            transition: margin-right 0.3s ease;
        }

        /* Desktop Adjustment */
        @media (min-width: 768px) {
            .sidebar {
                position: relative;
                transform: none;
            }
            .sidebar.closed {
                width: 0;
                padding: 0;
                overflow: hidden;
            }
        }

        .header {
            background-color: var(--chat-bg);
            padding: 10px 20px;
            text-align: center;
            font-weight: 700;
            font-size: 1.2em;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
        }

        .menu-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
        }

        .header span {
            background: linear-gradient(90deg, #10a37f, #2ac39b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .chat-box {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            scroll-behavior: smooth;
        }
        
        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #10a37f;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
            margin: auto;
            display: none;
        }
        
        .loader.active {
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Existing Message Styles */
        .message {
            padding: 12px 18px;
            border-radius: 12px;
            max-width: 85%;
            line-height: 2.4;
            font-size: 1.15em;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .user-msg { background-color: var(--user-msg-bg); align-self: flex-start; border-bottom-right-radius: 2px; }
        .ai-msg { background-color: var(--ai-msg-bg); align-self: flex-end; color: #d1d5db; border-bottom-left-radius: 2px; }

        .input-area {
            display: flex;
            padding: 15px;
            background: var(--chat-bg);
            border-top: 1px solid rgba(255,255,255,0.1);
            gap: 10px;
            padding-bottom: env(safe-area-inset-bottom, 15px);
        }

        input {
            flex: 1;
            padding: 14px 16px;
            background: var(--input-bg);
            border: 1px solid transparent;
            color: white;
            border-radius: 12px;
            outline: none;
            font-family: 'Noto Nastaliq Urdu', inherit;
            font-size: 1em;
        }
        input:focus { border-color: #10a37f; }

        button {
            padding: 0 24px;
            background-color: var(--user-msg-bg);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Noto Nastaliq Urdu', sans-serif;
        }
        button:disabled { background-color: #565869; cursor: not-allowed; }

        /* Login Modal */
        #loginModal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .login-box {
            background: #202123;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #444654;
            width: 90%;
            max-width: 400px;
        }
        .login-box h2 { margin-top: 0; }
        .login-btn {
            background: #10a37f;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            width: 100%;
            margin-top: 20px;
            font-size: 1.1em;
            cursor: pointer;
        }
    </style>
</head>
<body>

<!-- Login Modal -->
<div id="loginModal">
    <div class="login-box">
        <h2>Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!</h2>
        <p>Ø§Ù¾Ù†ÛŒ Ù¾Ø±Ø§Ù†ÛŒ Ú†ÛŒÙ¹Ø³ Ú©Ùˆ Ù…Ø­ÙÙˆØ¸ Ø±Ú©Ú¾Ù†Û’ Ú©Û’ Ù„ÛŒÛ’ Ù„Ø§Ú¯ Ø§Ù† Ú©Ø±ÛŒÚºÛ”</p>
        <div class="loader" id="loginLoader"></div>
        <button class="login-btn" id="loginBtn" onclick="handleLogin()">Ø§Ú©Ø§Ø¤Ù†Ù¹ Ø¨Ù†Ø§Ø¦ÛŒÚº / Ù„Ø§Ú¯ Ø§Ù† Ú©Ø±ÛŒÚº</button>
        <p style="font-size: 0.8em; color: #888; margin-top: 10px;">(ÛŒÛ Ø®ÙˆØ¯Ú©Ø§Ø± Ø·ÙˆØ± Ù¾Ø± Ø¢Ù¾ Ú©Ø§ Ù…Ø­ÙÙˆØ¸ Ø³ÛŒØ´Ù† Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ú©Ø±Û’ Ú¯Ø§)</p>
    </div>
</div>

<div class="sidebar-overlay" onclick="toggleSidebar()"></div>

<!-- Sidebar -->
<div class="sidebar closed" id="sidebar">
    <button class="new-chat-btn" onclick="startNewChat()">
        <i class="fas fa-plus"></i> Ù†Ø¦ÛŒ Ú†ÛŒÙ¹
    </button>
    <div class="history-list" id="historyList">
        <!-- History items will appear here -->
        <div style="text-align: center; color: #888; margin-top: 20px; font-size: 0.9em;">
            <i class="fas fa-spinner fa-spin"></i> ÛØ³Ù¹Ø±ÛŒ Ù„ÙˆÚˆ ÛÙˆ Ø±ÛÛŒ ÛÛ’...
        </div>
    </div>
    
    <!-- User Profile Strip -->
    <div style="margin-top: auto; padding-top: 10px; border-top: 1px solid #444; font-size: 0.9em; display: flex; align-items: center; gap: 10px;">
        <i class="fas fa-user-circle" style="font-size: 1.5em;"></i>
        <span id="userDisplay">ØµØ§Ø±Ù</span>
    </div>
</div>

<!-- Main Content -->
<div class="main-content">
    <div class="header">
        <button class="menu-btn" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>
        <span>Ø´Ø§Û Ù†ÙˆØ§Ø² Ø§Û’ Ø¢Ø¦ÛŒ</span>
        <div style="width: 30px;"></div> <!-- Spacer for centering -->
    </div>

    <div class="chat-box" id="chatBox">
        <div class="message ai-msg">Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÛŒÚ©Ù…! Ù…ÛŒÚº Ø´Ø§Û Ù†ÙˆØ§Ø² Ø§Û’ Ø¢Ø¦ÛŒ ÛÙˆÚºÛ” Ø¢Ù¾ Ù…Ø¬Ú¾ Ø³Û’ Ú©Ú†Ú¾ Ø¨Ú¾ÛŒ Ù¾ÙˆÚ†Ú¾ Ø³Ú©ØªÛ’ ÛÛŒÚºÛ”</div>
    </div>

    <div class="input-area">
        <input type="text" id="userInput" placeholder="ÛŒÛØ§Úº Ø§Ù¾Ù†Ø§ Ø³ÙˆØ§Ù„ Ù„Ú©Ú¾ÛŒÚº..." autocomplete="off">
        <button onclick="sendToGemini()" id="sendBtn">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
</div>

<!-- Firebase SDKs (COMPAT Version - Guaranteed to work in simple HTML) -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
    // ******************************************************
    const API_KEY = "AIzaSyBnfB_WjmfCXY8-t4tZsACuK7ZpiD1PCbY"; 
    // ******************************************************

    // --- Firebase Initialization (Compat Style) ---
    // This style attaches 'firebase' to the window, fixing the "not defined" error.
    
    // Fallback for environment variables
    const firebaseConfig = typeof __firebase_config !== 'undefined' 
        ? JSON.parse(__firebase_config) 
        : { apiKey: "dummy", authDomain: "dummy", projectId: "dummy" }; // Prevent crash if config missing
        
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Initialize
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;
    let currentChatId = null;
    let chatMessages = []; // Local store for current chat messages

    // --- Auth Logic ---
    async function handleLogin() {
        const btn = document.getElementById('loginBtn');
        const loader = document.getElementById('loginLoader');
        
        if(btn) btn.style.display = 'none';
        if(loader) loader.classList.add('active');

        try {
            if (initialAuthToken) {
                await auth.signInWithCustomToken(initialAuthToken);
            } else {
                await auth.signInAnonymously();
            }
        } catch (error) {
            console.error("Auth Error:", error);
            alert("Ù„Ø§Ú¯ Ø§Ù† Ù…ÛŒÚº Ù…Ø³Ø¦Ù„Û ÛÙˆØ§: " + error.message);
            if(btn) btn.style.display = 'block';
            if(loader) loader.classList.remove('active');
        }
    }

    // Listen to Auth State
    auth.onAuthStateChanged((user) => {
        if (user) {
            currentUser = user;
            const modal = document.getElementById('loginModal');
            if(modal) modal.style.display = 'none';
            
            const userDisplay = document.getElementById('userDisplay');
            if(userDisplay) userDisplay.innerText = "Ø¢Ù† Ù„Ø§Ø¦Ù† ØµØ§Ø±Ù";
            
            loadHistory();
        } else {
            const modal = document.getElementById('loginModal');
            if(modal) modal.style.display = 'flex';
        }
    });

    // --- Chat Logic ---

    // 1. Start New Chat
    function startNewChat() {
        currentChatId = null;
        chatMessages = [];
        
        // Reset UI
        const chatBox = document.getElementById("chatBox");
        chatBox.innerHTML = '<div class="message ai-msg">Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÛŒÚ©Ù…! Ù…ÛŒÚº Ø´Ø§Û Ù†ÙˆØ§Ø² Ø§Û’ Ø¢Ø¦ÛŒ ÛÙˆÚºÛ” Ø¢Ù¾ Ù…Ø¬Ú¾ Ø³Û’ Ú©Ú†Ú¾ Ø¨Ú¾ÛŒ Ù¾ÙˆÚ†Ú¾ Ø³Ú©ØªÛ’ ÛÛŒÚºÛ”</div>';
        
        // Close sidebar on mobile
        if(window.innerWidth < 768) toggleSidebar();
        
        // Remove active class from history items
        document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
    }

    // 2. Save Message to Firestore
    async function saveMessageToFirestore(role, text) {
        if (!currentUser) return;

        const messageData = {
            role: role,
            text: text,
            timestamp: new Date().toISOString()
        };
        
        chatMessages.push(messageData);

        if (!currentChatId) {
            // Create new chat document
            try {
                // First message determines title (first 5 words)
                let title = chatMessages[0].text.split(' ').slice(0, 5).join(' ') + '...';
                
                const docRef = await db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('chats').add({
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    title: title,
                    messages: chatMessages
                });
                currentChatId = docRef.id;
            } catch (e) {
                console.error("Error creating chat:", e);
            }
        } else {
            // Update existing chat document
            try {
                await db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('chats').doc(currentChatId).update({
                    messages: chatMessages
                });
            } catch (e) {
                console.error("Error updating chat:", e);
            }
        }
    }

    // 3. Load History
    function loadHistory() {
        if (!currentUser) return;

        const historyList = document.getElementById('historyList');
        
        db.collection('artifacts').doc(appId).collection('users').doc(currentUser.uid).collection('chats')
            .onSnapshot((snapshot) => {
                historyList.innerHTML = '';
                
                let chats = [];
                snapshot.forEach(doc => {
                    chats.push({ id: doc.id, ...doc.data() });
                });

                // Sort locally
                chats.sort((a, b) => {
                    // Handle timestamps that might not be fully synced yet
                    const tA = a.createdAt ? a.createdAt.toMillis() : Date.now();
                    const tB = b.createdAt ? b.createdAt.toMillis() : Date.now();
                    return tB - tA; // Descending
                });

                if (chats.length === 0) {
                    historyList.innerHTML = '<div style="text-align:center; color:#666; font-size:0.8em; margin-top:20px;">Ú©ÙˆØ¦ÛŒ Ù¾Ø±Ø§Ù†ÛŒ Ú†ÛŒÙ¹ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛÛŒÚº</div>';
                }

                chats.forEach(chat => {
                    const div = document.createElement('div');
                    div.className = `history-item ${currentChatId === chat.id ? 'active' : ''}`;
                    div.innerHTML = `<i class="far fa-comment-alt"></i> <span>${chat.title || 'Ù†Ø¦ÛŒ Ø¨Ø§Øª Ú†ÛŒØª'}</span>`;
                    
                    // Closure to capture chat data
                    div.onclick = function() { loadChatSession(chat); };
                    
                    historyList.appendChild(div);
                });
            }, (error) => {
                console.error("History Error:", error);
                historyList.innerHTML = '<div style="color:red; font-size:0.8em;">Ù„ÙˆÚˆÙ†Ú¯ Ù…ÛŒÚº Ø®Ø±Ø§Ø¨ÛŒ</div>';
            });
    }

    // 4. Load a specific session
    function loadChatSession(chatData) {
        currentChatId = chatData.id;
        chatMessages = chatData.messages || [];
        
        const chatBox = document.getElementById("chatBox");
        chatBox.innerHTML = ''; // Clear current view

        // Render messages
        chatMessages.forEach(msg => {
            const className = msg.role === 'user' ? 'user-msg' : 'ai-msg';
            appendMessageToUI(msg.text, className);
        });

        // Close sidebar on mobile
        if(window.innerWidth < 768) toggleSidebar();
        
        // Highlight active
        // (UI update happens via snapshot listener mostly, but we can force it for instant feel)
        document.querySelectorAll('.history-item').forEach(el => el.classList.remove('active'));
    }

    // --- UI Helpers ---
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.querySelector('.sidebar-overlay');
        sidebar.classList.toggle('closed');
        overlay.classList.toggle('active');
    }

    function appendMessageToUI(text, className) {
        const chatBox = document.getElementById("chatBox");
        const msgDiv = document.createElement("div");
        msgDiv.classList.add("message", className);
        msgDiv.innerHTML = text.replace(/\n/g, "<br>"); // Simple render
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // --- Main Gemini Logic ---
    async function sendToGemini() {
        const inputField = document.getElementById("userInput");
        const sendBtn = document.getElementById("sendBtn");
        const userText = inputField.value.trim();

        if (!userText) return;
        if (!API_KEY) { alert("API Key Missing"); return; }

        // UI Update
        appendMessageToUI(userText, "user-msg");
        inputField.value = "";
        sendBtn.disabled = true;
        
        // Save User Message
        await saveMessageToFirestore('user', userText);

        // System Prompt
        const systemPrompt = `
        ÛØ¯Ø§ÛŒØ§Øª Ø¨Ø±Ø§Ø¦Û’ AI:
        1. Ø¢Ù¾ Ú©Ø§ Ù†Ø§Ù… "Ø´Ø§Û Ù†ÙˆØ§Ø² Ø§Û’ Ø¢Ø¦ÛŒ" ÛÛ’Û”
        2. Ø§Ú¯Ø± Ú©ÙˆØ¦ÛŒ Ù¾ÙˆÚ†Ú¾Û’ Ú©Û "Ø´Ø§Û Ù†ÙˆØ§Ø² Ú©ÙˆÙ† ÛÛŒÚºØŸ" ÛŒØ§ Ø§Ù† Ú©Ø§ ØªØ¹Ø§Ø±Ù Ù¾ÙˆÚ†Ú¾Û’ØŒ ØªÙˆ ÛŒÛ Ø¨ØªØ§Ø¦ÛŒÚº:
           "Ø´Ø§Û Ù†ÙˆØ§Ø² Ø§ÛŒÚ© Ø¹Ø§Ù„Ù… Ø¯ÛŒÙ†ØŒ Ù…ÙØªÛŒ Ø§ÙˆØ± Ø­Ø§ÙØ¸ Ù‚Ø±Ø¢Ù† ÛÛŒÚºÛ” Ø§Ù†ÛÙˆÚº Ù†Û’ Ø¯Ø§Ø±Ø§Ù„Ø¹Ù„ÙˆÙ… Ú©Ø±Ø§Ú†ÛŒ Ø³Û’ Ø¯Ø±Ø³ Ù†Ø¸Ø§Ù…ÛŒ (ÙØ§Ø¶Ù„) Ù…Ú©Ù…Ù„ Ú©ÛŒØ§ Ø§ÙˆØ± Ø§Ø³ Ú©Û’ Ø¨Ø¹Ø¯ Ø¬Ø§Ù…Ø¹ Ø§Ù„Ø±Ø´ÛŒØ¯ Ø³Û’ Ù…ÙØªÛŒ Ø§Ø¨Ùˆ Ù„Ø¨Ø§Ø¨Û ØµØ§Ø­Ø¨ Ú©ÛŒ Ø²ÛŒØ± Ù†Ú¯Ø±Ø§Ù†ÛŒ ØªØ®ØµØµ ÙÛŒ Ø§Ù„ÙÙ‚Û (Ù…ÙØªÛŒ Ú©ÙˆØ±Ø³) Ú©ÛŒØ§Û” 
           ÙˆÛ Ø§Ø³ ÙˆÙ‚Øª 'Ø³Ù†ÛØ§ Ø­Ù„Ø§Ù„' (SANHA Halal) Ù…ÛŒÚº Ø³Ø±Ù¹ÛŒÙÚ©ÛŒØ´Ù† Ù…ÛŒÙ†ÛŒØ¬Ø± ÛÛŒÚº Ø§ÙˆØ± Ú¯Ø²Ø´ØªÛ ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ ÚˆÚ¾Ø§Ø¦ÛŒ Ø³Ø§Ù„ Ø³Û’ Ù…Ø®ØªÙ„Ù Ø§Ù†ÚˆØ³Ù¹Ø±ÛŒØ² Ú©Û’ Ø­Ù„Ø§Ù„ Ø¢ÚˆÙ¹ Ú©Ø± Ø±ÛÛ’ ÛÛŒÚºÛ”"
        3. Ø¬ÙˆØ§Ø¨ ÛÙ…ÛŒØ´Û Ø´Ø§Ø¦Ø³ØªÛØŒ Ø¨Ø§Ù…Ø­Ø§ÙˆØ±Û Ø§ÙˆØ± Ø®ÙˆØ¨ØµÙˆØ±Øª Ø§Ø±Ø¯Ùˆ (Ù†Ø³ØªØ¹Ù„ÛŒÙ‚ Ø§Ù†Ø¯Ø§Ø²) Ù…ÛŒÚº Ø¯ÛŒÚºÛ”
        `;

        // Context Construction (Last 5 messages for memory)
        let historyContext = chatMessages.slice(-5).map(m => 
            `${m.role === 'user' ? 'ØµØ§Ø±Ù' : 'AI'}: ${m.text}`
        ).join('\n');

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: systemPrompt + "\n\nØ³Ø§Ø¨Ù‚Û Ú¯ÙØªÚ¯Ùˆ:\n" + historyContext + "\n\nØµØ§Ø±Ù Ú©Ø§ Ù†ÛŒØ§ Ø³ÙˆØ§Ù„: " + userText }]
                    }]
                })
            });

            const data = await response.json();

            if (data.candidates && data.candidates.length > 0) {
                const aiText = data.candidates[0].content.parts[0].text;
                appendMessageToUI(aiText, "ai-msg");
                // Save AI Message
                await saveMessageToFirestore('model', aiText);
            } else {
                appendMessageToUI("Ù…Ø¹Ø°Ø±ØªØŒ Ú©ÙˆØ¦ÛŒ Ù…Ø³Ø¦Ù„Û Ø¯Ø±Ù¾ÛŒØ´ ÛÛ’Û”", "ai-msg");
            }
        } catch (error) {
            console.error(error);
            appendMessageToUI("Ø§Ù†Ù¹Ø±Ù†ÛŒÙ¹ Ú©Ù†Ú©Ø´Ù† Ú©Ø§ Ù…Ø³Ø¦Ù„Û ÛÛ’Û”", "ai-msg");
        }

        sendBtn.disabled = false;
        if(window.innerWidth > 768) inputField.focus();
    }

    // Enter Key
    document.getElementById("userInput").addEventListener("keypress", function(e) {
        if (e.key === "Enter") sendToGemini();
    });

</script>

</body>
</html>
