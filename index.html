<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Umar LPG Manager (Mobile)</title>
  
  <style>
    :root { 
        /* --- GLOBAL THEME --- */
        --bg-color: #F8FAFC;        
        --card-bg: #FFFFFF;      
        --border: #E2E8F0;    
        --ink: #0F172A;      
        --muted: #64748B;    
        --brand: #2563EB;    /* Professional Blue */
        --brand-dark: #1E40AF;
        --header-bg: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
        --rashid-bg: linear-gradient(135deg, #10B981 0%, #059669 100%);
        --danger: #EF4444;    
        --success: #10B981;
        
        --radius: 10px;        
        --shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        margin: 0;
        background-color: var(--bg-color);
        /* Background Pattern Restored */
        background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
        background-size: 20px 20px;
        color: var(--ink);
        padding-bottom: 120px;
        font-size: 15px; 
        line-height: 1.5;
        overflow-x: hidden;
    }
    
    /* --- HEADER --- */
    header { 
        background: var(--header-bg);
        padding: 12px 16px;
        width: 100%;
        color: white;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        position: relative;
        z-index: 50;
    }

    /* Top Bar for Switch Button */
    .top-bar {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 8px;
    }
    
    /* Switch App Button */
    #btnSwitchApp {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.4);
        font-weight: 600;
        font-size: 12px;
        padding: 6px 12px;
        border-radius: 20px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        transition: background 0.2s;
    }
    #btnSwitchApp:active { background: rgba(255,255,255,0.4); }

    .header-content { max-width: 1000px; margin: 0 auto; }
    
    header h1 { 
        margin: 0 0 12px 0; 
        font-size: 22px; 
        font-weight: 700; 
        color: white;
        text-align: center;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    /* Toolbar Default (Desktop) */
    .toolbar { 
        display: flex; 
        gap: 8px; 
        align-items: center; 
        justify-content: center; 
        flex-wrap: wrap; 
    }
    
    .toolbar select {
        background: rgba(255,255,255,0.9);
        color: var(--ink);
        border: none;
        padding: 8px;
        border-radius: 6px;
        font-weight: 600;
        min-width: 100px;
    }
    .toolbar button {
        background: rgba(255,255,255,0.2);
        color: white;
        border: 1px solid rgba(255,255,255,0.3);
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 13px;
    }

    /* --- TABS (CENTERED) --- */
    nav.tabs {
        display: flex; 
        gap: 8px; 
        padding: 12px; 
        background: white;
        flex-wrap: wrap; 
        justify-content: center; 
        border-bottom: 1px solid var(--border);
        box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        position: relative;
        z-index: 40;
    }
    
    nav.tabs button {
        background: #F1F5F9; 
        color: var(--muted); 
        border: none; 
        border-radius: 20px; 
        font-weight: 600; 
        padding: 8px 16px; 
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 4px;
    }
    nav.tabs button.active { 
        background: var(--brand); 
        color: white;
        box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3);
    } 

    main { padding: 16px; max-width: 1000px; margin: 0 auto; width: 100%; }
    
    h2 { font-size: 18px; margin: 0 0 16px 0; font-weight: 700; color: var(--ink); }

    /* --- INPUTS & FORMS --- */
    select, input, textarea {
        border: 1px solid var(--border); 
        border-radius: 8px; 
        padding: 12px; 
        background: white;
        color: var(--ink);
        font-size: 15px; 
        width: 100%;
        font-family: inherit;
    }
    input:focus, select:focus { border-color: var(--brand); box-shadow: 0 0 0 2px rgba(37,99,235,0.1); }
    
    /* --- BUTTONS --- */
    button { cursor: pointer; font-family: inherit; }
    
    .btn-primary {
        background: var(--brand); color: white; border: none;
        padding: 12px 20px; border-radius: 8px; font-weight: 600;
        font-size: 14px;
        width: 100%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .btn-ghost {
        background: white; color: var(--muted); border: 1px solid var(--border);
        padding: 12px; border-radius: 8px; font-size: 14px; font-weight: 600;
        width: 100%;
    }

    /* --- TABLES / CARDS --- */
    .table-container { width: 100%; }

    /* Desktop View */
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: var(--shadow); }
    th, td { padding: 12px; border-bottom: 1px solid var(--border); text-align: left; }
    th { background: #F8FAFC; font-weight: 600; font-size: 12px; text-transform: uppercase; color: var(--muted); }
    
    .text-right { text-align: right; }
    .text-center { text-align: center; }
    
    .action-btn { background: #F1F5F9; border: none; padding: 6px; border-radius: 4px; margin-left: 4px; color: var(--muted); width: auto; }
    
    #status-banner {
        padding: 8px; text-align: center; font-size: 13px; font-weight: 600;
        display: none; width: 100%;
        background: #ECFDF5; color: var(--success); border-bottom: 1px solid var(--border);
    }
    #status-banner.error { background: var(--danger); color: white; }

    .hidden { display: none !important; }
    .grid { display: grid; gap: 12px; }
    .grid.cols-3, .grid.cols-5 { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }
    .row-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }

    /* FAB */
    .add-btn-desktop {
        background: var(--brand); color: white; border: none;
        padding: 8px 16px; border-radius: 6px; font-weight: 600;
    }

    .form-panel { background: white; border: 1px solid var(--border); padding: 16px; border-radius: 12px; margin-bottom: 16px; box-shadow: var(--shadow); }
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; }
    .stat-card { background: white; border: 1px solid var(--border); padding: 16px; border-radius: 12px; text-align: center; box-shadow: var(--shadow); }
    .stat-label { font-size: 12px; color: var(--muted); text-transform: uppercase; font-weight: 600; margin-bottom: 4px; }
    .stat-val { font-size: 20px; font-weight: 700; color: var(--ink); }
    
    #login-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255,255,255,0.95); z-index: 1000;
        display: flex; align-items: center; justify-content: center;
    }

    /* --- MOBILE RESPONSIVE --- */
    @media (max-width: 768px) {
        .add-btn-desktop {
            position: fixed; bottom: 24px; right: 24px;
            width: 56px; height: 56px; border-radius: 50%;
            padding: 0; margin: 0;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cline x1='12' y1='5' x2='12' y2='19'%3E%3C/line%3E%3Cline x1='5' y1='12' x2='19' y2='12'%3E%3C/line%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: center;
            color: transparent; box-shadow: 0 4px 12px rgba(37,99,235,0.4); z-index: 999;
        }

        /* --- Toolbar Layout for Mobile (Fixed Month/Year Visibility) --- */
        .toolbar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            width: 100%;
        }
        
        /* Row 1: Action Buttons */
        #btnToggleFilter { grid-column: span 1; }
        #btnPrint { grid-column: span 1; }
        #btnImport { grid-column: span 1; }
        #btnExport { grid-column: span 1; }
        
        /* Row 2: Month, Year, Logout */
        #monthSelect { grid-column: span 1; min-width: 0; font-size: 13px; padding: 8px 4px; }
        #yearSelect { grid-column: span 1; min-width: 0; font-size: 13px; padding: 8px 4px; }
        #btnLogout { 
            grid-column: span 2; 
            background: rgba(239, 68, 68, 0.2); 
            border: 1px solid rgba(239, 68, 68, 0.4); 
            color: #fff;
        }

        nav.tabs { justify-content: center; }
        
        table, thead, tbody, tr, td { display: block; width: 100%; }
        thead { display: none; }
        tr {
            margin-bottom: 12px; border: 1px solid var(--border); border-radius: 12px;
            background: white; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        td {
            display: flex; justify-content: space-between; align-items: center;
            padding: 6px 0; border: none; text-align: right;
        }
        td:before { content: attr(data-label); font-weight: 600; color: var(--muted); font-size: 13px; text-align: left; }
        
        td[data-label="Date"] { 
            font-weight: 700; color: var(--brand); font-size: 15px;
            border-bottom: 1px solid #f1f5f9; padding-bottom: 8px; margin-bottom: 8px;
        }
        td[data-label="Actions"] { 
            border-top: 1px solid #f1f5f9; margin-top: 8px; padding-top: 12px; justify-content: flex-end;
        }
        tfoot { display: none; }
        .grid.cols-3, .grid.cols-5 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="login-overlay">
      <div class="login-box" style="width:90%; max-width:320px; text-align:center;">
          <div style="background:white; padding:24px; border-radius:16px; box-shadow:0 10px 25px rgba(0,0,0,0.1); border:1px solid #f1f5f9;">
            <h2 style="margin-top:0;">Login</h2>
            <div id="login-error" style="color:var(--danger); display:none; margin-bottom:10px; font-size:12px;">Error connecting.</div>
            <div style="display:grid; gap:12px;">
                <input type="email" id="txtEmail" placeholder="Email" />
                <input type="password" id="txtPassword" placeholder="Password" />
                <button id="btnLogin" class="btn-primary">Sign In</button>
            </div>
          </div>
      </div>
  </div>

  <div id="status-banner">Connecting...</div>
  
  <header>
    <div class="header-content">
      <div class="top-bar">
        <button id="btnSwitchApp">Go to Rashid LPG</button>
      </div>
      <h1 id="appTitle">Umar LPG</h1>
      <div class="toolbar">
        <select id="monthSelect"></select>
        <select id="yearSelect"></select>
        <button id="btnToggleFilter">Filter</button>
        <button id="btnPrint">Print</button>
        <button id="btnImport">Import</button>
        <button id="btnExport">Export</button>
        <button id="btnLogout">Logout</button>
        <input class="hidden" type="file" id="fileInput" accept="application/json" />
      </div>
    </div>
  </header>

  <nav class="tabs">
    <button data-tab="purchases" class="active">Purchases</button>
    <button data-tab="sales">Sales</button>
    <button data-tab="expenses">Expenses</button>
    <button data-tab="summary">Summary</button>
    <button data-tab="daily">Daily</button>
  </nav>

  <main>
    <!-- FILTER -->
    <section id="filter-bar" class="form-panel hidden">
      <div class="grid cols-3">
          <input type="date" id="filterDateFrom" />
          <input type="date" id="filterDateTo" />
          <input type="text" id="filterText" placeholder="Search..." />
      </div>
      <div style="margin-top:12px; display:flex; gap:10px;">
          <button id="btnApplyFilter" class="btn-primary">Apply</button>
          <button id="btnResetFilter" class="btn-ghost">Clear</button>
      </div>
    </section>

    <!-- PURCHASES -->
    <section id="tab-purchases">
      <div class="row-header">
        <h2>Purchases</h2>
        <button id="addPurchase" class="add-btn-desktop">+</button>
      </div>
      <div id="purchaseForm" class="form-panel hidden">
        <h3 style="margin:0 0 16px 0;">New Purchase</h3>
        <div class="grid cols-5">
            <input type="datetime-local" id="pDate" />
            <input type="text" id="pSupplier" placeholder="Supplier" />
            <input type="number" id="pCyl" placeholder="Cyl" />
            <input type="number" id="pUnit" placeholder="Rate" />
            <input type="number" id="pTotal" placeholder="Total" />
        </div>
        <div style="margin-top:16px; display:flex; gap:10px;">
            <button id="pSave" class="btn-primary">Save</button>
            <button id="pCancel" class="btn-ghost">Cancel</button>
        </div>
      </div>
      <div id="purchaseTable" class="table-container"></div>
    </section>

    <!-- SALES -->
    <section id="tab-sales" class="hidden">
      <div class="row-header">
        <h2>Sales</h2>
        <button id="addSale" class="add-btn-desktop">+</button>
      </div>
      <div id="saleForm" class="form-panel hidden">
        <h3 style="margin:0 0 16px 0;">New Sale</h3>
        <div class="grid cols-3">
            <input type="datetime-local" id="sDate" />
            <input type="text" id="sCustomer" placeholder="Customer" />
            <input type="number" id="sCyl" placeholder="Cyl" />
            <input type="number" id="sUnit" placeholder="Rate" />
            <input type="number" id="sTotal" placeholder="Total" />
            <input type="text" id="sNote" placeholder="Note" />
        </div>
        <div style="margin-top:16px; display:flex; gap:10px;">
            <button id="sSave" class="btn-primary">Save</button>
            <button id="sCancel" class="btn-ghost">Cancel</button>
        </div>
      </div>
      <div id="salesTable" class="table-container"></div>
    </section>

    <!-- EXPENSES -->
    <section id="tab-expenses" class="hidden">
      <div class="row-header">
        <h2>Expenses</h2>
        <button id="addExpense" class="add-btn-desktop">+</button>
      </div>
      <div id="expenseForm" class="form-panel hidden">
        <div class="grid cols-3">
            <input type="datetime-local" id="eDate" />
            <input type="text" id="eNote" placeholder="Description" />
            <input type="number" id="eAmount" placeholder="Amount" />
        </div>
        <div style="margin-top:16px; display:flex; gap:10px;">
            <button id="eSave" class="btn-primary">Save</button>
            <button id="eCancel" class="btn-ghost">Cancel</button>
        </div>
      </div>
      <div id="expensesTable" class="table-container"></div>
    </section>

    <!-- SUMMARY & DAILY -->
    <section id="tab-summary" class="hidden">
      <div id="summaryBox"></div>
    </section>
    <section id="tab-daily" class="hidden">
      <div id="dailyTable" class="table-container"></div>
    </section>
  </main>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
    // Safeguard for JS errors
    window.onerror = function(msg, url, line) {
       console.error("Error: " + msg);
    };

    const ICON_EDIT = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`;
    const ICON_TRASH = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;

    const firebaseConfig = {
      apiKey: "AIzaSyCMkXvwJ_T6-Y6d3PiyhAW80oO9k0tspBw",
      authDomain: "lpg-ledger-shah.firebaseapp.com",
      projectId: "lpg-ledger-shah",
      storageBucket: "lpg-ledger-shah.firebasestorage.app",
      messagingSenderId: "28929807086",
      appId: "1:28929807086:web:4a8a9371dee25a863dd9ff",
      measurementId: "G-JD7EL91XMB"
    };

    document.addEventListener('DOMContentLoaded', () => {
        try {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();
            
            let currentAppMode = 'umar'; 
            let ledgerDocRef = db.collection('ledger').doc('store');
            let unsubscribe = null;
            const CLIENT_ID = 'c' + Math.floor(Math.random()*1e9);
            const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
            let store = {};
            let isApplyingRemote = false;
            let currentUser = null;

            function updateStatusBanner(status, isError=false) {
                const banner = document.getElementById('status-banner');
                if(banner){
                    banner.style.display = 'block';
                    banner.innerText = status;
                    banner.className = isError ? 'error' : '';
                }
            }

            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('login-overlay').style.display = 'none';
                    setupSnapshotListener();
                } else {
                    currentUser = null;
                    document.getElementById('login-overlay').style.display = 'flex';
                    updateStatusBanner("Waiting for Login...");
                }
            });

            document.getElementById('btnLogin').onclick = async () => {
                const email = document.getElementById('txtEmail').value;
                const pass = document.getElementById('txtPassword').value;
                const errDiv = document.getElementById('login-error');
                if(!email || !pass) return;
                document.getElementById('btnLogin').innerText = "Verifying...";
                document.getElementById('btnLogin').disabled = true;
                try {
                    await auth.signInWithEmailAndPassword(email, pass);
                } catch(e) {
                    errDiv.innerText = e.message; errDiv.style.display = 'block';
                    document.getElementById('btnLogin').innerText = "Sign In";
                    document.getElementById('btnLogin').disabled = false;
                }
            };
            
            document.getElementById('btnLogout').onclick = async () => { 
                if(confirm("Log out?")) { await auth.signOut(); window.location.reload(); } 
            };

            document.getElementById('btnSwitchApp').onclick = () => {
                const header = document.querySelector('header');
                if(currentAppMode === 'umar'){
                    currentAppMode = 'rashid';
                    document.getElementById('appTitle').innerText = 'Rashid LPG';
                    document.documentElement.style.setProperty('--brand', '#10B981'); 
                    header.style.background = 'var(--rashid-bg)';
                    document.getElementById('btnSwitchApp').innerText = 'Go to Umar LPG';
                } else {
                    currentAppMode = 'umar';
                    document.getElementById('appTitle').innerText = 'Umar LPG';
                    document.documentElement.style.setProperty('--brand', '#2563EB'); 
                    header.style.background = 'var(--header-bg)';
                    document.getElementById('btnSwitchApp').innerText = 'Go to Rashid LPG';
                }
                store = {}; render(); setupSnapshotListener();
            };

            function setupSnapshotListener(){
              if(unsubscribe) { unsubscribe(); unsubscribe = null; }
              const docId = (currentAppMode === 'umar') ? 'store' : 'store_rashid';
              const storageKey = (currentAppMode === 'umar') ? 'lpg_ledger_v19' : 'lpg_ledger_rashid';
              ledgerDocRef = db.collection('ledger').doc(docId);
              
              unsubscribe = ledgerDocRef.onSnapshot(async (docSnap) => {
                updateStatusBanner("ðŸŸ¢ Sync Active", false);
                if(!docSnap.exists){
                  try { await ledgerDocRef.set({ data: getFixedInitialData(), updatedAt: firebase.firestore.FieldValue.serverTimestamp() }); } catch(e){}
                  return;
                }
                const remote = docSnap.data();
                if(!remote) return;
                const remoteData = remote.data || {};
                if(JSON.stringify(store) === JSON.stringify(remoteData)) { render(); return; }
                
                isApplyingRemote = true;
                store = remoteData;
                repairIdsInStore(store);
                localStorage.setItem(storageKey, JSON.stringify(store));
                initMonthYearOptions();
                render();
                setTimeout(()=> { isApplyingRemote = false; }, 300);
              }, (err) => { updateStatusBanner("âš ï¸ Access Denied", true); });
            }

            async function saveStore(){
              if(isApplyingRemote) return;
              if(!currentUser) return alert("Login required");
              const storageKey = (currentAppMode === 'umar') ? 'lpg_ledger_v19' : 'lpg_ledger_rashid';
              localStorage.setItem(storageKey, JSON.stringify(store));
              try {
                await ledgerDocRef.set({ data: store, updatedAt: firebase.firestore.FieldValue.serverTimestamp(), updatedBy: CLIENT_ID });
              } catch(e){ alert("Save Failed: " + e.message); }
            }

            function repairIdsInStore(data) { Object.keys(data).forEach(key => { if (data[key].transactions) { data[key].transactions.forEach(t => { if (!t.id) t.id = Date.now() + Math.floor(Math.random() * 100000); if(t.date && typeof t.date === 'string' && t.date.startsWith("2S025")) t.date = t.date.replace("2S025", "2025"); }); } }); }
            function ymd(date){ return (date ?? '').split('T')[0]; }
            function asDate(v){ return new Date(v); }
            function ensureMonth(key){ if(!store[key]) store[key] = { transactions: [] }; }
            function nextId(){ return Date.now() + Math.floor(Math.random() * 1000); }
            function findTransactionById(id){ for(const key of Object.keys(store)){ const bucket = store[key]; if(bucket && bucket.transactions){ const tx = bucket.transactions.find(t=>t.id===id); if(tx) return { transaction: tx, key }; } } return { transaction: null, key: null }; }

            function computeFIFO(cutoffDate){
              const all = [];
              Object.entries(store).forEach(([key,bucket])=>{ (bucket.transactions||[]).forEach(t=>{ if(!t.date) return; if(asDate(t.date) <= cutoffDate) all.push(t); }); });
              all.sort((a,b)=> new Date(a.date)-new Date(b.date) || (a.id??0)-(b.id??0));
              const layers=[]; const salesCOGS=new Map(); const stockLevelAfter=new Map();
              for(const t of all){
                if(t.type==='buy'){
                    const unit = (t.cylinders>0)? (t.totalPrice/t.cylinders):0;
                    layers.push({qty:t.cylinders, unitCost:unit});
                }
                else if(t.type==='sell'){
                    let need=t.cylinders, cogs=0;
                    while(need>0 && layers.length){
                        const L=layers[0]; const take=Math.min(need, L.qty);
                        cogs += take * L.unitCost; L.qty -= take; need -= take;
                        if(L.qty===0) layers.shift();
                    }
                    salesCOGS.set(t.id, Math.round(cogs));
                }
                stockLevelAfter.set(t.id, layers.reduce((s,L)=> s+L.qty, 0));
              }
              return { salesCOGS, remaining: layers.reduce((s,L)=> s+L.qty,0), remainingValue: Math.round(layers.reduce((s,L)=> s+L.qty*L.unitCost,0)), stockLevelAfter };
            }

            function summarizeForKey(key, filteredTx){
              ensureMonth(key); const bucket = store[key];
              const [year,month] = key.split('-').map(Number);
              const cutoff=new Date(year,month,0,23,59,59,999);
              const fifo = computeFIFO(cutoff);
              const tx = filteredTx ?? [...bucket.transactions];
              let tBC=0,tBV=0,tSC=0,tSR=0,tExp=0,tCOGS=0;
              for(const t of tx){
                if(t.type==='buy'){ tBC += Number(t.cylinders||0); tBV += Number(t.totalPrice||0); }
                else if(t.type==='sell'){
                    tSC += Number(t.cylinders||0); tSR += Number(t.totalPrice||0);
                    const c = fifo.salesCOGS.get(t.id); tCOGS += Number((c !== undefined) ? c : (t.cogs ?? 0));
                }
                else if(t.type==='expense'){ tExp += Number(t.totalPrice||0); }
              }
              return { totalBoughtCylinders:tBC, totalBoughtValue:tBV, totalSoldCylinders:tSC, totalSaleRevenue:tSR, totalCOGS:tCOGS, totalExpenses:tExp, grossProfit: tSR-tCOGS-tExp, remainingCylinders: fifo.remaining, remainingStockValue: fifo.remainingValue };
            }

            function generateDailyBreakdown(transactions, salesCOGSMap){
                const dailyData = {};
                for(const t of transactions){
                    const day = ymd(t.date);
                    if(!dailyData[day]) dailyData[day] = { soldCyl:0, saleRevenue:0, cogs:0, expenses:0, purchasesCyl:0, purchaseValue:0 };
                    if(t.type==='sell'){
                        dailyData[day].soldCyl += Number(t.cylinders||0);
                        dailyData[day].saleRevenue += Number(t.totalPrice||0);
                        dailyData[day].cogs += Number(salesCOGSMap.get(t.id) || 0);
                    }
                    else if(t.type==='expense'){ dailyData[day].expenses += Number(t.totalPrice||0); }
                    else if(t.type==='buy'){ dailyData[day].purchasesCyl += Number(t.cylinders||0); dailyData[day].purchaseValue += Number(t.totalPrice||0); }
                }
                return Object.keys(dailyData).sort().map(date=>{
                    const d=dailyData[date]; 
                    return { date, ...d, grossProfit: d.saleRevenue - d.cogs, netProfit: (d.saleRevenue - d.cogs) - d.expenses };
                });
            }

            const monthSelect = document.getElementById('monthSelect'); const yearSelect = document.getElementById('yearSelect');
            function initMonthYearOptions(){
                const years = new Set(); const now = new Date(); const currentYear = now.getFullYear();
                for(let y = currentYear - 2; y <= currentYear + 5; y++) years.add(y);
                Object.keys(store).forEach(k=>{ years.add(Number(k.split('-')[0])); });
                yearSelect.innerHTML = Array.from(years).sort((a,b)=>a-b).map(y=>`<option value="${y}">${y}</option>`).join('');
                monthSelect.innerHTML = MONTHS.map((m,i)=>`<option value="${i+1}">${m}</option>`).join('');
                yearSelect.value = currentYear; monthSelect.value = String(now.getMonth()+1);
                if(Object.keys(store).length===1){ const [y,m]=Object.keys(store)[0].split('-'); yearSelect.value = y; monthSelect.value = String(Number(m)); }
            }
            function activeKey(){ return `${yearSelect.value}-${String(monthSelect.value).padStart(2,'0')}`; }
            function table(headers, rowsHtml, tfootHtml=''){ return `<table><thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>${rowsHtml||''}</tbody>${tfootHtml}</table>`; }
            
            function render(){
              try {
                const key = activeKey(); ensureMonth(key); const allTxForMonth = [...store[key].transactions];
                const [y,m] = key.split('-').map(Number); const fifo = computeFIFO(new Date(y,m,0,23,59,59,999));
                
                let filtered = [...allTxForMonth];
                const dateFrom = document.getElementById('filterDateFrom').value;
                const dateTo = document.getElementById('filterDateTo').value;
                const text = document.getElementById('filterText').value.toLowerCase();
                
                if(dateFrom) filtered = filtered.filter(t=> t.date.split('T')[0] >= dateFrom);
                if(dateTo) filtered = filtered.filter(t=> t.date.split('T')[0] <= dateTo);
                if(text) {
                    filtered = filtered.filter(t=> {
                        const searchStr = [
                            t.note,
                            t.customer,
                            t.supplier,
                            t.type,
                            t.totalPrice
                        ].map(f => (f||'').toString().toLowerCase()).join(' ');
                        return searchStr.includes(text);
                    });
                }

                const purchases = filtered.filter(t=>t.type==='buy').sort((a,b)=> asDate(a.date)-asDate(b.date));
                const sales = filtered.filter(t=>t.type==='sell').sort((a,b)=> asDate(a.date)-asDate(b.date));
                const expenses = filtered.filter(t=>t.type==='expense').sort((a,b)=> asDate(a.date)-asDate(b.date));
                const fmt = (n) => Number(n||0).toLocaleString();

                let pRows = ''; let pTotalCyl=0, pTotalAmt=0;
                purchases.forEach(p=>{ 
                    const unit = (p.cylinders>0) ? Math.round((p.totalPrice||0)/p.cylinders) : 0; 
                    pTotalCyl += Number(p.cylinders||0); pTotalAmt += Number(p.totalPrice||0); 
                    pRows += `<tr><td data-label="Date">${ymd(p.date)}</td><td data-label="Supplier">${p.supplier || '-'}</td><td data-label="Cylinders" class="text-center">${p.cylinders}</td><td data-label="Unit Price" class="text-right font-mono">${fmt(unit)}</td><td data-label="Total Price" class="text-right font-mono">${fmt(p.totalPrice)}</td><td data-label="Actions" class="text-right"><button class="action-btn" onclick="window.editEntry(${p.id})">${ICON_EDIT}</button><button class="action-btn del" onclick="window.deleteEntry(${p.id})">${ICON_TRASH}</button></td></tr>`; 
                });
                document.getElementById('purchaseTable').innerHTML = table(['Date','Supplier','Cylinders','Unit Price','Total Price','Actions'], pRows, `<tfoot><tr><td colspan="2">TOTAL</td><td class="text-center">${pTotalCyl}</td><td class="text-right"></td><td class="text-right">${fmt(pTotalAmt)}</td><td></td></tr></tfoot>`);

                let sRows=''; let sTotalCyl=0, sTotalSale=0, sTotalCOGS=0, sTotalProfit=0;
                sales.forEach(s=>{
                  const computed = fifo.salesCOGS.get(s.id); const cogs = Number((computed !== undefined) ? computed : (s.cogs ?? 0));
                  const profit = Number(s.totalPrice||0) - cogs;
                  sTotalCyl += Number(s.cylinders||0); sTotalSale += Number(s.totalPrice||0); sTotalCOGS += Number(cogs||0); sTotalProfit += Number(profit||0);
                  sRows += `<tr><td data-label="Date">${ymd(s.date)}</td><td data-label="Customer">${s.customer || '-'}</td><td data-label="Cylinders" class="text-center">${s.cylinders}</td><td data-label="Sale" class="text-right font-mono">${fmt(s.totalPrice)}</td><td data-label="COGS" class="text-right font-mono" style="color:var(--muted)">${fmt(cogs)}</td><td data-label="Profit" class="text-right font-mono" style="font-weight:600;color:${profit>=0? 'var(--success)':'var(--danger)'}">${fmt(profit)}</td><td data-label="Stock" class="text-center" style="color:var(--brand);">${fifo.stockLevelAfter.get(s.id)||0}</td><td data-label="Note">${s.note||''}</td><td data-label="Actions" class="text-right"><button class="action-btn" onclick="window.editEntry(${s.id})">${ICON_EDIT}</button><button class="action-btn del" onclick="window.deleteEntry(${s.id})">${ICON_TRASH}</button></td></tr>`;
                });
                document.getElementById('salesTable').innerHTML = table(['Date','Customer','Cyl','Sale','COGS','Profit','Stock','Note','Actions'], sRows, `<tfoot><tr><td colspan="2">TOTAL</td><td class="text-center">${sTotalCyl}</td><td class="text-right">${fmt(sTotalSale)}</td><td class="text-right">${fmt(sTotalCOGS)}</td><td class="text-right">${fmt(sTotalProfit)}</td><td colspan="3"></td></tr></tfoot>`);

                let eRows=''; let eTotal=0;
                expenses.forEach(e=>{ eTotal += Number(e.totalPrice||0); eRows += `<tr><td data-label="Date">${ymd(e.date)}</td><td data-label="Description">${e.note||''}</td><td data-label="Amount" class="text-right font-mono">${fmt(e.totalPrice)}</td><td data-label="Actions" class="text-right"><button class="action-btn" onclick="window.editEntry(${e.id})">${ICON_EDIT}</button><button class="action-btn del" onclick="window.deleteEntry(${e.id})">${ICON_TRASH}</button></td></tr>`; });
                document.getElementById('expensesTable').innerHTML = table(['Date','Description','Amount','Actions'], eRows, `<tfoot><tr><td colspan="2">TOTAL</td><td class="text-right">${fmt(eTotal)}</td><td></td></tr></tfoot>`);

                const mS = summarizeForKey(key, filtered);
                document.getElementById('summaryBox').innerHTML = `<div class="summary-grid"><div class="stat-card"><div class="stat-label">Sales Revenue</div><div class="stat-val">${fmt(mS.totalSaleRevenue)}</div></div><div class="stat-card"><div class="stat-label">COGS</div><div class="stat-val">${fmt(mS.totalCOGS)}</div></div><div class="stat-card"><div class="stat-label">Expenses</div><div class="stat-val" style="color:var(--danger)">${fmt(mS.totalExpenses)}</div></div><div class="stat-card" style="border-color:var(--success); background:#F0FDF4;"><div class="stat-label">Net Profit</div><div class="stat-val green">${fmt(mS.grossProfit)}</div></div><div class="stat-card"><div class="stat-label">Stock Remaining</div><div class="stat-val" style="color:var(--brand)">${mS.remainingCylinders} cyl</div></div></div>`;
                
                const dRows = generateDailyBreakdown(allTxForMonth, fifo.salesCOGS).map(d=>{ const gc = d.grossProfit>=0? 'text-success':'text-danger'; const nc = d.netProfit>=0? 'text-success':'text-danger'; return `<tr data-day="${d.date}" style="cursor:pointer;" title="Tap"><td data-label="Date">${d.date}</td><td data-label="Sold" class="text-center">${d.soldCyl}</td><td data-label="Sale" class="text-right">${fmt(d.saleRevenue)}</td><td data-label="COGS" class="text-right">${fmt(d.cogs)}</td><td data-label="Gross" class="text-right ${gc}">${fmt(d.grossProfit)}</td><td data-label="Exp" class="text-right">${fmt(d.expenses)}</td><td data-label="Net" class="text-right ${nc}" style="font-weight:700;">${fmt(d.netProfit)}</td></tr>`; }).join('');
                document.getElementById('dailyTable').innerHTML = table(['Date','Sold','Sale','COGS','Gross','Exp','Net Profit'], dRows);

              } catch (err) { console.error(err); }
            }

            let editingId = null;
            window.editEntry = function(id){
              clearForms(); const { transaction } = findTransactionById(id); if(!transaction) return alert('Not found'); editingId = id;
              if(transaction.type==='buy'){
                  document.getElementById('pDate').value = transaction.date; document.getElementById('pCyl').value = transaction.cylinders; document.getElementById('pTotal').value = transaction.totalPrice; document.getElementById('pSupplier').value = transaction.supplier || ''; document.getElementById('pUnit').dispatchEvent(new Event('input')); toggle(document.getElementById('purchaseForm'), true);
              } else if(transaction.type==='sell'){
                  document.getElementById('sDate').value = transaction.date; document.getElementById('sCyl').value = transaction.cylinders; document.getElementById('sTotal').value = transaction.totalPrice; document.getElementById('sNote').value = transaction.note||''; document.getElementById('sCustomer').value = transaction.customer || ''; document.getElementById('sTotal').dispatchEvent(new Event('input')); toggle(document.getElementById('saleForm'), true);
              } else if(transaction.type==='expense'){
                  document.getElementById('eDate').value = transaction.date; document.getElementById('eNote').value = transaction.note||''; document.getElementById('eAmount').value = transaction.totalPrice; toggle(document.getElementById('expenseForm'), true);
              }
            };

            window.deleteEntry = async function(id) { 
                if(!confirm("Delete?")) return; 
                const { transaction, key } = findTransactionById(id); 
                if(transaction) { store[key].transactions.splice(store[key].transactions.indexOf(transaction), 1); await saveStore(); render(); } 
            };

            document.addEventListener('click', function(ev){ 
                const tr = ev.target.closest('tr[data-day]'); if(!tr) return; 
                const next = tr.nextElementSibling; if(next && next.classList.contains('expanded-row')){ next.remove(); return; } 
                document.querySelectorAll('tr.expanded-row').forEach(r=> r.remove()); 
                const day = tr.getAttribute('data-day'); 
                const entries = store[activeKey()].transactions.filter(t=> ymd(t.date) === day).sort((a,b)=> asDate(a.date)-asDate(b.date));
                if(!entries.length) return;
                const expandedTr = document.createElement('tr'); expandedTr.className = 'expanded-row'; 
                const td = document.createElement('td'); td.colSpan = 7; 
                let html = `<div style="display:grid; gap:8px; padding:10px; background:#f8fafc;">`;
                entries.forEach(e => {
                    let clr='black'; let typeLabel='?'; if(e.type==='buy') { typeLabel='PURCHASE'; clr='var(--danger)'; } else if(e.type==='sell') { typeLabel='SALE'; clr='var(--success)'; } else if(e.type==='expense') { typeLabel='EXPENSE'; clr='var(--danger)'; }
                    html += `<div style="background:white; border:1px solid #e2e8f0; padding:12px; border-radius:12px; display:flex; justify-content:space-between; align-items:center;"><div><div style="font-size:12px; font-weight:700; color:#64748b;">${typeLabel}</div><div>${e.note || e.customer || e.supplier || ''}</div></div><div style="font-weight:700; color:${clr};">${Number(e.totalPrice).toLocaleString()}</div></div>`;
                });
                html += `</div>`; td.innerHTML = html; expandedTr.appendChild(td); tr.parentNode.insertBefore(expandedTr, tr.nextSibling); 
            });

            document.querySelectorAll('nav.tabs button').forEach(btn=>{ 
                btn.addEventListener('click', ()=>{ 
                    document.querySelectorAll('nav.tabs button').forEach(b=>b.classList.remove('active')); 
                    btn.classList.add('active'); 
                    const t = btn.dataset.tab; 
                    
                    // --- UPDATE URL (New Feature) ---
                    const newUrl = new URL(window.location);
                    newUrl.searchParams.set('tab', t);
                    window.history.pushState({}, '', newUrl);

                    document.querySelectorAll('main > section').forEach(s=> s.classList.add('hidden')); 
                    document.getElementById(`tab-${t}`).classList.remove('hidden'); 
                }); 
            });
            monthSelect.addEventListener('change', render); yearSelect.addEventListener('change', render);

            function clearForms(){ ['pDate','pCyl','pUnit','pTotal','pSupplier','sDate','sCyl','sUnit','sTotal','sNote','sCustomer','eDate','eNote','eAmount'].forEach(id=> document.getElementById(id).value=''); editingId = null; }
            function toggle(el, show){ if(el) el.classList.toggle('hidden', !show); }
            function bindCalc({qtyEl, unitEl, totalEl}){
              const n=(v)=>Number(v||0); const fmt=(v)=>isFinite(v)?Math.round(v):0;
              const onChange=()=>{ const q=n(qtyEl.value), u=n(unitEl.value); if(q>0 && u>=0) totalEl.value = fmt(q*u); };
              const onTotal=()=>{ const q=n(qtyEl.value), t=n(totalEl.value); if(q>0) unitEl.value = fmt(t/q); };
              qtyEl.addEventListener('input', onChange); unitEl.addEventListener('input', onChange); totalEl.addEventListener('input', onTotal);
            }

            document.getElementById('addPurchase').onclick = ()=>{ clearForms(); toggle(document.getElementById('purchaseForm'), true); };
            document.getElementById('pCancel').onclick = ()=>{ toggle(document.getElementById('purchaseForm'), false); clearForms(); };
            document.getElementById('addSale').onclick = ()=>{ clearForms(); toggle(document.getElementById('saleForm'), true); };
            document.getElementById('sCancel').onclick = ()=>{ toggle(document.getElementById('saleForm'), false); clearForms(); };
            document.getElementById('addExpense').onclick = ()=>{ clearForms(); toggle(document.getElementById('expenseForm'), true); };
            document.getElementById('eCancel').onclick = ()=>{ toggle(document.getElementById('expenseForm'), false); clearForms(); };
            bindCalc({ qtyEl: document.getElementById('pCyl'), unitEl: document.getElementById('pUnit'), totalEl: document.getElementById('pTotal') });
            bindCalc({ qtyEl: document.getElementById('sCyl'), unitEl: document.getElementById('sUnit'), totalEl: document.getElementById('sTotal') });

            document.getElementById('btnToggleFilter').onclick = () => { toggle(document.getElementById('filter-bar'), !document.getElementById('filter-bar').classList.contains('hidden')); }; 
            
            // --- ENHANCED FILTER LISTENERS ---
            document.getElementById('btnApplyFilter').onclick = render;
            document.getElementById('btnResetFilter').onclick = () => { document.getElementById('filterDateFrom').value = ''; document.getElementById('filterDateTo').value = ''; document.getElementById('filterText').value = ''; render(); };
            // Live Search
            document.getElementById('filterText').addEventListener('input', render);
            document.getElementById('filterDateFrom').addEventListener('change', render);
            document.getElementById('filterDateTo').addEventListener('change', render);

            
            document.getElementById('pSave').onclick = async ()=>{
              const d = document.getElementById('pDate').value || new Date().toISOString(); const cyl = Number(document.getElementById('pCyl').value || 0); const total = Number(document.getElementById('pTotal').value || 0); const supplier = document.getElementById('pSupplier').value || '';
              if(!cyl || !total) return alert('Enter data');
              const key = `${new Date(d).getFullYear()}-${String(new Date(d).getMonth()+1).padStart(2,'0')}`; ensureMonth(key);
              if(editingId){ const { transaction } = findTransactionById(editingId); transaction.date = d; transaction.type='buy'; transaction.cylinders = cyl; transaction.totalPrice = total; transaction.supplier = supplier; } 
              else { store[key].transactions.push({ id: nextId(), date: d, type: 'buy', cylinders: cyl, totalPrice: total, supplier }); }
              await saveStore(); toggle(document.getElementById('purchaseForm'), false); clearForms(); render();
            };
            document.getElementById('sSave').onclick = async ()=>{
              const d = document.getElementById('sDate').value || new Date().toISOString(); const cyl = Number(document.getElementById('sCyl').value || 0); const total = Number(document.getElementById('sTotal').value || 0); const note = document.getElementById('sNote').value || ''; const customer = document.getElementById('sCustomer').value || '';
              if(!cyl || !total) return alert('Enter data');
              const key = `${new Date(d).getFullYear()}-${String(new Date(d).getMonth()+1).padStart(2,'0')}`; ensureMonth(key);
              if(editingId){ const { transaction } = findTransactionById(editingId); transaction.date = d; transaction.type='sell'; transaction.cylinders = cyl; transaction.totalPrice = total; transaction.note = note; transaction.customer = customer; } 
              else { store[key].transactions.push({ id: nextId(), date: d, type: 'sell', cylinders: cyl, totalPrice: total, note, customer }); }
              await saveStore(); toggle(document.getElementById('saleForm'), false); clearForms(); render();
            };
            document.getElementById('eSave').onclick = async ()=>{
              const d = document.getElementById('eDate').value || new Date().toISOString(); const amt = Number(document.getElementById('eAmount').value || 0); const note = document.getElementById('eNote').value || '';
              if(!amt) return alert('Enter amount');
              const key = `${new Date(d).getFullYear()}-${String(new Date(d).getMonth()+1).padStart(2,'0')}`; ensureMonth(key);
              if(editingId){ const { transaction } = findTransactionById(editingId); transaction.date = d; transaction.type='expense'; transaction.totalPrice = amt; transaction.note = note; } 
              else { store[key].transactions.push({ id: nextId(), date: d, type: 'expense', cylinders: 0, totalPrice: amt, note }); }
              await saveStore(); toggle(document.getElementById('expenseForm'), false); clearForms(); render();
            };
            
            document.getElementById('btnPrint').onclick = () => window.print();
            document.getElementById('btnExport').onclick = ()=>{ const b=new Blob([JSON.stringify(store,null,2)],{type:'application/json'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='ledger.json'; a.click(); };
            document.getElementById('btnImport').onclick = ()=> document.getElementById('fileInput').click();
            document.getElementById('fileInput').addEventListener('change', async (ev)=>{ const f=ev.target.files[0]; if(!f)return; try{ store=JSON.parse(await f.text()||'{}'); repairIdsInStore(store); await saveStore(); initMonthYearOptions(); render(); alert('Imported'); }catch(e){alert(e);} });

            function getFixedInitialData() { return { "2025-11": { "transactions": [ {"id": 11, "date": "2025-10-29", "type": "buy", "cylinders": 6, "totalPrice": 55836}, {"id": 14, "date": "2025-11-01", "type": "sell", "cylinders": 3, "totalPrice": 32400}, {"id": 16, "date": "2025-11-02", "type": "buy", "cylinders": 11, "totalPrice": 101508} ] } }; }
            
            setTimeout(()=> { if(Object.keys(store).length === 0) { initMonthYearOptions(); render(); } }, 600);

            // --- ADDED FOR APPMYSITE TAB SWITCHING ---
            // URL se ?tab=xyz check karega aur wo tab khol dega
            const urlParams = new URLSearchParams(window.location.search);
            const tabName = urlParams.get('tab'); // e.g., ?tab=sales
            if(tabName){
                const targetBtn = document.querySelector(`nav.tabs button[data-tab="${tabName}"]`);
                if(targetBtn) {
                    setTimeout(() => targetBtn.click(), 100);
                }
            }
            // ------------------------------------------

        } catch (error) {
            console.error("Critical Init Error", error);
        }
    });
  </script>
</body>
</html>
