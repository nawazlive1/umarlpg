<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…ÛŒØ±ÛŒ Ø§Ø³Ù…Ø§Ø±Ù¹ ÚˆØ§Ø¦Ø±ÛŒ Ù¾Ø±Ùˆ (Ø§Ù„Ù¹ÛŒÙ…ÛŒÙ¹)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkbg: '#0f172a',
                        darkcard: '#1e293b',
                        darkinput: '#334155',
                        brand: {
                            light: '#10b981',
                            dark: '#064e3b',
                        }
                    },
                    fontFamily: {
                        urdu: ['Noto Nastaliq Urdu', 'serif'],
                        sans: ['Noto Sans Arabic', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <!-- Urdu Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&family=Noto+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans Arabic', sans-serif; -webkit-tap-highlight-color: transparent; }
        h1, h2, h3, .urdu-text, button, input, select, option, textarea { font-family: 'Noto Nastaliq Urdu', serif; line-height: 2.0; }
        
        /* Responsive Container */
        .app-container { 
            width: 100%;
            margin: 0 auto; 
            min-height: 100vh; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
        }

        /* Desktop specific adjustments */
        @media (min-width: 768px) {
            .app-container {
                max-width: 1024px;
                background-color: #f8fafc;
                min-height: 100vh;
                box-shadow: 0 0 20px rgba(0,0,0,0.1);
            }
            .dark .app-container {
                background-color: #0f172a;
            }
        }

        .btn-press:active { transform: scale(0.97); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .calendar-dot { width: 6px; height: 6px; background-color: #10b981; border-radius: 50%; margin-top: 2px; }
        
        @keyframes slideDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-down { animation: slideDown 0.3s ease-out forwards; }
        
        /* Modern Date Style */
        .date-badge {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
        }
        .dark .date-badge {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
        }

        .reply-box {
            background-color: rgba(0,0,0,0.03);
            border-right: 3px solid #10b981;
            padding: 8px;
            margin-top: 8px;
            border-radius: 8px;
        }
        .dark .reply-box {
            background-color: rgba(255,255,255,0.05);
        }

        /* Toggle Switch Style */
        .toggle-btn.active {
            background-color: #10b981;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .toggle-btn {
            background-color: transparent;
            color: #4b5563;
        }
        .dark .toggle-btn { color: #cbd5e1; }
        
        /* Loading Overlay */
        #loadingOverlay {
            backdrop-filter: blur(5px);
        }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            html, body, .app-container, #appSection, #mainContent, #financeView, #diaryView {
                height: auto !important;
                min-height: auto !important;
                overflow: visible !important;
                position: static !important;
                display: block !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
            }
            #printableArea, #diaryScroll {
                visibility: visible !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 20px;
                background: white;
                color: black;
            }
            #printableArea *, #diaryScroll * {
                visibility: visible !important;
                color: black !important;
                box-shadow: none !important;
            }
            #transList, #taskList {
                display: block !important;
                overflow: visible !important;
                height: auto !important;
            }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="text-gray-800 bg-slate-100 dark:bg-black transition-colors duration-300">

    <div class="app-container bg-white dark:bg-darkbg shadow-2xl relative overflow-hidden">
        
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="hidden fixed inset-0 z-[100] bg-white/80 dark:bg-black/80 flex flex-col items-center justify-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600 mb-4"></div>
            <p class="text-emerald-700 dark:text-emerald-400 font-bold urdu-text text-lg" id="loadingText">Ù¾Ù„ÛŒØ² ÙˆÛŒÙ¹...</p>
        </div>

        <!-- Auth Section -->
        <div id="authSection" class="flex-1 flex flex-col justify-center p-6 bg-emerald-50 dark:bg-slate-900 z-50 absolute inset-0 h-full">
            <div class="max-w-md mx-auto w-full">
                <div class="text-center mb-10">
                    <div class="bg-white dark:bg-slate-800 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 shadow-md text-4xl">ğŸ”</div>
                    <h1 class="text-4xl font-bold text-emerald-800 dark:text-emerald-400 mb-4 leading-normal">Ù…ÛŒØ±ÛŒ ÚˆØ§Ø¦Ø±ÛŒ</h1>
                    <p class="text-sm text-emerald-600 dark:text-emerald-300 font-sans mt-2 tracking-wide">Ø§ÛŒÚˆÙ…Ù† Ø§Ù¾Ø±ÙˆÙˆÙ„ Ø³Ø³Ù¹Ù…</p>
                </div>

                <div id="loginForm" class="bg-white dark:bg-darkcard p-6 rounded-3xl shadow-xl border border-emerald-100 dark:border-slate-700">
                    <h2 class="text-xl font-bold text-center mb-6 text-slate-700 dark:text-slate-200">Ù„Ø§Ú¯ Ø§Ù† Ú©Ø±ÛŒÚº</h2>
                    <form onsubmit="event.preventDefault(); window.loginUser();" class="space-y-4">
                        <input type="email" id="loginEmail" placeholder="Ø§ÛŒ Ù…ÛŒÙ„" class="w-full p-3 bg-slate-50 dark:bg-darkinput dark:text-white border border-slate-200 dark:border-slate-600 rounded-xl outline-none font-sans" dir="ltr">
                        <input type="password" id="loginPass" placeholder="Ù¾Ø§Ø³ÙˆØ±Úˆ" class="w-full p-3 bg-slate-50 dark:bg-darkinput dark:text-white border border-slate-200 dark:border-slate-600 rounded-xl outline-none font-sans" dir="ltr">
                        <button type="submit" class="w-full mt-6 bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl btn-press shadow-lg">Ø¯Ø§Ø®Ù„ ÛÙˆÚº</button>
                    </form>
                    <div class="mt-8 pt-6 border-t border-slate-100 dark:border-slate-700 text-center">
                        <button type="button" onclick="window.showScreen('signupForm')" class="text-emerald-600 dark:text-emerald-400 font-bold hover:underline">Ù†ÛŒØ§ Ø§Ú©Ø§Ø¤Ù†Ù¹ Ø¨Ù†Ø§Ø¦ÛŒÚº</button>
                    </div>
                </div>

                <div id="signupForm" class="hidden bg-white dark:bg-darkcard p-6 rounded-3xl shadow-xl border border-emerald-100 dark:border-slate-700">
                    <h2 class="text-xl font-bold text-center mb-6 text-slate-700 dark:text-slate-200">Ø±Ø¬Ø³Ù¹Ø±ÛŒØ´Ù†</h2>
                    <form onsubmit="event.preventDefault(); window.signupUser();" class="space-y-4">
                        <label class="text-[10px] text-slate-400 block mb-1">Ø¢Ù¾ Ú©Ø§ Ù†Ø§Ù… (Ø¬Ùˆ Ø¯ÙˆØ³Ø±ÙˆÚº Ú©Ùˆ Ù†Ø¸Ø± Ø¢Ø¦Û’)</label>
                        <input type="text" id="signupName" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø§Ø¬Ù…Ù„ Ù„Ø§Ø¦Ù" class="w-full p-3 bg-slate-50 dark:bg-darkinput dark:text-white border border-slate-200 dark:border-slate-600 rounded-xl outline-none urdu-text border-emerald-500">
                        
                        <input type="email" id="signupEmail" placeholder="Ø§ÛŒ Ù…ÛŒÙ„ Ù„Ú©Ú¾ÛŒÚº" class="w-full p-3 bg-slate-50 dark:bg-darkinput dark:text-white border border-slate-200 dark:border-slate-600 rounded-xl font-sans" dir="ltr">
                        <input type="password" id="signupPass" placeholder="Ù¾Ø§Ø³ÙˆØ±Úˆ" class="w-full p-3 bg-slate-50 dark:bg-darkinput dark:text-white border border-slate-200 dark:border-slate-600 rounded-xl font-sans" dir="ltr">
                        
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-xl mt-4">
                            <p class="text-[10px] text-blue-700 dark:text-blue-400 urdu-text text-center">
                                Ù†ÙˆÙ¹: Ø§Ú©Ø§Ø¤Ù†Ù¹ Ø¨Ù†Ø§Ù†Û’ Ú©Û’ Ø¨Ø¹Ø¯ Ø¢Ù¾ Ú©Ùˆ Ø§ÛŒÚˆÙ…Ù† Ú©ÛŒ Ù…Ù†Ø¸ÙˆØ±ÛŒ Ú©Ø§ Ø§Ù†ØªØ¸Ø§Ø± Ú©Ø±Ù†Ø§ ÛÙˆÚ¯Ø§Û”
                            </p>
                        </div>
                        <button type="submit" id="signupBtn" class="w-full mt-4 bg-emerald-600 text-white font-bold py-3 rounded-xl btn-press">Ø§Ú©Ø§Ø¤Ù†Ù¹ Ø¨Ù†Ø§Ø¦ÛŒÚº</button>
                    </form>
                    <button type="button" onclick="window.showScreen('loginForm')" class="w-full mt-3 text-slate-400 py-2 text-sm font-sans">ÙˆØ§Ù¾Ø³ Ø¬Ø§Ø¦ÛŒÚº</button>
                </div>
            </div>
        </div>

        <!-- Pending Screen -->
        <div id="pendingScreen" class="hidden fixed inset-0 z-[60] bg-white dark:bg-darkbg flex flex-col items-center justify-center p-8 text-center">
            <div id="adminApprovalMsg">
                <div class="text-5xl mb-4">â³</div>
                <h2 class="text-2xl font-bold mb-2 dark:text-white">Ø§Ù†ØªØ¸Ø§Ø± ÙØ±Ù…Ø§Ø¦ÛŒÚº</h2>
                <p class="text-sm text-slate-500 mb-6">Ø¢Ù¾ Ú©Ø§ Ø§Ú©Ø§Ø¤Ù†Ù¹ Ø¨Ù† Ú¯ÛŒØ§ ÛÛ’ Ù„ÛŒÚ©Ù† Ø§Ø¨Ú¾ÛŒ Ø§ÛŒÚˆÙ…Ù† Ù†Û’ Ù…Ù†Ø¸ÙˆØ± Ù†ÛÛŒÚº Ú©ÛŒØ§Û” Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø§ÛŒÚˆÙ…Ù† Ø³Û’ Ø±Ø§Ø¨Ø·Û Ú©Ø±ÛŒÚºÛ”</p>
                <div class="bg-slate-100 dark:bg-slate-800 p-4 rounded-xl text-xs text-slate-600 dark:text-slate-300">
                    Ø§Ø³Ù¹ÛŒÙ¹Ø³: <span class="font-bold text-orange-500">Ø²ÛŒØ±Ù Ø§Ù„ØªÙˆØ§Ø¡ (Pending)</span>
                </div>
                <button onclick="location.reload()" class="mt-8 text-emerald-600 font-bold text-xs">Ø±ÛŒÙØ±ÛŒØ´ Ú©Ø±ÛŒÚº</button>
            </div>
            <button onclick="window.logoutUser()" class="mt-10 text-red-400 text-sm font-bold">Ù„Ø§Ú¯ Ø¢Ø¤Ù¹</button>
        </div>

        <!-- App Section -->
        <div id="appSection" class="hidden flex flex-col h-screen bg-slate-50 dark:bg-darkbg relative">
            
            <!-- Dynamic Header -->
            <header class="bg-emerald-600 dark:bg-emerald-900 pt-4 pb-2 text-white shadow-lg z-30 sticky top-0 transition-all duration-500">
                <div class="px-5 flex items-center justify-between h-12 max-w-4xl mx-auto w-full relative">
                    
                    <!-- Right Side: Welcome Text -->
                    <div class="flex-shrink-0 z-20 flex flex-col items-end">
                        <span id="headerSub" class="text-[10px] text-emerald-100 font-sans opacity-80 block font-bold">Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!</span>
                    </div>

                    <!-- Center: Title -->
                    <div class="absolute inset-0 flex items-center justify-center z-10 pointer-events-none">
                        <h2 class="text-xl font-bold leading-tight text-white drop-shadow-md" id="headerTitle">Ù…ÛŒØ±ÛŒ ÚˆØ§Ø¦Ø±ÛŒ</h2>
                    </div>
                    
                    <!-- Left Side: Buttons -->
                    <div class="flex items-center gap-2 flex-shrink-0 z-20">
                        <!-- Admin Button -->
                        <button id="adminPanelBtn" onclick="window.openAdminPanel()" class="hidden bg-red-500/20 p-2 rounded-xl hover:bg-red-500/50 transition border border-red-400 relative">
                            ğŸ‘®â€â™‚ï¸
                            <span id="pendingCountBadge" class="hidden absolute -top-1 -right-1 w-4 h-4 bg-red-600 text-white text-[9px] flex items-center justify-center rounded-full font-sans">0</span>
                        </button>

                        <!-- Group Settings Button -->
                        <button onclick="window.openGroupSettings()" class="bg-emerald-500/30 p-2 rounded-xl hover:bg-emerald-500/50 transition relative">
                            âš™ï¸
                            <span id="groupStatusDot" class="absolute top-1 right-1 w-2 h-2 bg-green-500 rounded-full"></span>
                        </button>

                        <!-- Calendar Button -->
                        <button onclick="window.toggleCalendar()" id="calBtn" class="bg-emerald-500/30 p-2 rounded-xl hover:bg-emerald-500/50 transition">ğŸ“…</button>
                        
                        <!-- Theme -->
                        <button onclick="window.toggleDarkMode()" class="bg-emerald-500/30 p-2 rounded-xl hover:bg-emerald-500/50 transition"><span id="darkModeIcon">ğŸŒ™</span></button>
                        
                        <!-- User Avatar -->
                        <div onclick="window.logoutUser()" id="userAvatar" class="w-9 h-9 rounded-full bg-white text-emerald-700 flex items-center justify-center font-bold text-sm cursor-pointer border-2 border-emerald-400 uppercase">U</div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="px-5 mt-4 max-w-4xl mx-auto w-full">
                    <div class="flex p-1 bg-emerald-900 dark:bg-slate-800 rounded-2xl relative shadow-inner border border-emerald-800 dark:border-slate-700">
                        <div id="tabIndicator" class="absolute top-1 bottom-1 w-[49%] bg-emerald-200 dark:bg-emerald-600 shadow-md rounded-xl transition-all duration-300 left-[50%]"></div>
                        
                        <button onclick="window.switchTab('diary')" id="btnDiary" class="flex-1 py-2 text-sm font-bold relative z-10 text-emerald-950 dark:text-white transition-colors">ÚˆØ§Ø¦Ø±ÛŒ ğŸ“–</button>
                        <button onclick="window.switchTab('finance')" id="btnFinance" class="flex-1 py-2 text-sm font-bold relative z-10 text-emerald-100/70 dark:text-slate-400 transition-colors">Ú©ÛŒØ´ Ø¨Ú© ğŸ’°</button>
                    </div>
                </div>
            </header>

            <!-- Mode Toggle Bar -->
            <div id="modeToggleBar" class="px-5 py-2 bg-slate-100 dark:bg-darkbg border-b border-slate-200 dark:border-slate-800 flex justify-center sticky top-[108px] z-20">
                <div class="flex bg-slate-200 dark:bg-slate-800 rounded-lg p-1 w-full max-w-xs shadow-inner">
                    <button onclick="window.setMode('personal')" id="btnModePersonal" class="toggle-btn active flex-1 py-1 text-xs font-bold rounded-md transition-all">ğŸ”’ Ø°Ø§ØªÛŒ ÚˆØ§Ø¦Ø±ÛŒ</button>
                    <button onclick="window.setMode('group')" id="btnModeGroup" class="toggle-btn flex-1 py-1 text-xs font-bold rounded-md transition-all">ğŸ‘¥ Ú¯Ø±ÙˆÙ¾ ÚˆØ§Ø¦Ø±ÛŒ</button>
                </div>
            </div>

            <!-- Admin Panel Modal -->
            <div id="adminModal" class="hidden fixed inset-0 z-[70] bg-black/50 backdrop-blur-sm flex items-center justify-center p-5">
                <div class="bg-white dark:bg-darkcard w-full max-w-sm p-6 rounded-3xl shadow-2xl animate-slide-down max-h-[80vh] overflow-hidden flex flex-col">
                    <h3 class="text-lg font-bold mb-4 text-center dark:text-white border-b pb-2 border-slate-100 dark:border-slate-700">Ù†Ø¦Û’ Ù…Ù…Ø¨Ø±Ø² Ú©ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒÚº</h3>
                    <div id="pendingUsersList" class="overflow-y-auto flex-1 space-y-3 min-h-[100px]">
                        <p class="text-center text-xs text-slate-400 mt-4">Ú©ÙˆØ¦ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø²ÛŒØ±Ù Ø§Ù„ØªÙˆØ§Ø¡ Ù†ÛÛŒÚº</p>
                    </div>
                    <button onclick="document.getElementById('adminModal').classList.add('hidden')" class="w-full mt-4 bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-white py-2 rounded-xl text-sm font-bold">Ø¨Ù†Ø¯ Ú©Ø±ÛŒÚº</button>
                </div>
            </div>

            <!-- Group Settings Modal -->
            <div id="groupModal" class="hidden fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm flex items-center justify-center p-5">
                <div class="bg-white dark:bg-darkcard w-full max-w-sm p-6 rounded-3xl shadow-2xl animate-slide-down">
                    <h3 class="text-lg font-bold mb-4 text-center dark:text-white">Ú¯Ø±ÙˆÙ¾ Ø¬ÙˆØ§Ø¦Ù† Ú©Ø±ÛŒÚº / Ù†ÛŒØ§ Ø¨Ù†Ø§Ø¦ÛŒÚº</h3>
                    <p class="text-xs text-slate-500 text-center mb-4">Ù†ÛŒØ§ Ú¯Ø±ÙˆÙ¾ Ø¨Ù†Ø§Ù†Û’ ÛŒØ§ Ø¬ÙˆØ§Ø¦Ù† Ú©Ø±Ù†Û’ Ú©Û’ Ù„ÛŒÛ’ Ú©ÙˆØ¦ÛŒ Ø¨Ú¾ÛŒ Ù†Ø§Ù… Ù„Ú©Ú¾ÛŒÚºÛ”<br>(ÚˆÛŒÙØ§Ù„Ù¹: DUKAAN)</p>
                    <label class="text-[10px] font-bold text-emerald-600">Ú¯Ø±ÙˆÙ¾ Ú©ÙˆÚˆ (Group ID)</label>
                    <input type="text" id="groupCodeInput" placeholder="Ù…Ø«Ù„Ø§Ù‹: OFFICE, HOME, DUKAAN" class="w-full p-3 bg-slate-100 dark:bg-darkinput dark:text-white rounded-xl mt-1 mb-4 outline-none font-sans text-center tracking-widest uppercase">
                    <button onclick="window.saveGroupSettings()" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl mb-2">Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚº</button>
                    <button onclick="document.getElementById('groupModal').classList.add('hidden')" class="w-full text-slate-400 py-2 text-sm">Ø¨Ù†Ø¯ Ú©Ø±ÛŒÚº</button>
                </div>
            </div>

            <!-- Interactive Calendar -->
            <div id="calendarView" class="hidden absolute top-[160px] left-0 right-0 max-w-md mx-auto bg-white dark:bg-darkcard shadow-2xl z-40 p-5 rounded-3xl border border-slate-200 dark:border-slate-700 mx-5 animate-slide-down">
                <div class="flex justify-between items-center mb-5">
                    <button onclick="window.changeMonth(-1)" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-full hover:bg-emerald-50 dark:text-white">â—€</button>
                    <h3 id="currentMonthYear" class="text-lg font-bold text-slate-800 dark:text-emerald-400 urdu-text"></h3>
                    <button onclick="window.changeMonth(1)" class="p-2 bg-slate-100 dark:bg-slate-800 rounded-full hover:bg-emerald-50 dark:text-white">â–¶</button>
                </div>
                <div class="grid grid-cols-7 gap-2 text-center font-sans text-[10px] text-slate-400 font-bold mb-2">
                    <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 gap-2 text-center font-sans"></div>
                <div class="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700 flex justify-between items-center">
                    <span class="text-[10px] text-slate-400 font-sans italic">* ØªØ§Ø±ÛŒØ® Ù¾Ø± Ú©Ù„Ú© Ú©Ø±ÛŒÚº</span>
                    <button onclick="window.toggleCalendar()" class="text-xs text-red-500 font-bold urdu-text">Ø¨Ù†Ø¯ Ú©Ø±ÛŒÚº</button>
                </div>
            </div>

            <!-- Content Area -->
            <div id="mainContent" class="flex-1 overflow-hidden flex flex-col max-w-4xl mx-auto w-full">
                
                <!-- DIARY VIEW -->
                <div id="diaryView" class="flex-1 flex flex-col overflow-y-auto no-scrollbar w-full p-5">
                    
                    <!-- Search Bar -->
                    <div class="mb-5 relative no-print">
                        <input type="text" id="searchInput" placeholder="Ù†ÙˆÙ¹Ø³ Ù…ÛŒÚº ØªÙ„Ø§Ø´ Ú©Ø±ÛŒÚº..." class="w-full p-3 pr-10 bg-white dark:bg-darkinput dark:text-white rounded-2xl text-sm outline-none shadow-sm urdu-text border border-slate-100 dark:border-slate-700" oninput="window.filterData()">
                        <span class="absolute right-3 top-3 opacity-40">ğŸ”</span>
                    </div>

                    <!-- Static Diary Input Form -->
                    <div class="bg-white dark:bg-darkcard p-5 rounded-3xl shadow-md border dark:border-slate-700 mb-6 no-print">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-sm font-bold urdu-text" id="taskFormTitle">Ù†ÛŒØ§ Ù†ÙˆÙ¹ Ù„Ú©Ú¾ÛŒÚº</h3>
                            <span id="inputLabel" class="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-md">ğŸ”’ Ø°Ø§ØªÛŒ Ù†ÙˆÙ¹</span>
                        </div>
                        
                        <div class="flex gap-2 mb-3">
                            <input type="datetime-local" id="taskDate" class="flex-[1.5] p-2 bg-slate-50 dark:bg-darkinput dark:text-white rounded-xl text-[10px] outline-none font-sans border border-slate-100 dark:border-slate-600">
                            <select id="taskCategory" class="flex-1 bg-slate-50 dark:bg-darkinput dark:text-white text-[10px] rounded-xl outline-none p-2 border border-slate-100 dark:border-slate-600">
                                <option value="Ø¹Ø§Ù…">ğŸ“Œ Ø¹Ø§Ù…</option><option value="Ø°Ø§ØªÛŒ">ğŸ‘¤ Ø°Ø§ØªÛŒ</option><option value="Ú©Ø§Ù…">ğŸ’¼ Ú©Ø§Ù…</option><option value="Ø¶Ø±ÙˆØ±ÛŒ">ğŸ”¥ Ø¶Ø±ÙˆØ±ÛŒ</option>
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <textarea id="taskInput" placeholder="Ø¢Ø¬ Ú©ÛŒØ§ Ù„Ú©Ú¾Ù†Ø§ ÛÛ’ØŸ..." class="w-full p-3 h-24 bg-slate-50 dark:bg-darkinput dark:text-white rounded-xl outline-none urdu-text border border-slate-100 dark:border-slate-600 resize-none"></textarea>
                        </div>

                        <input type="hidden" id="editTaskId" value="">
                        
                        <div class="flex gap-2">
                             <button onclick="window.cancelTaskEdit()" id="cancelTaskBtn" class="hidden flex-1 bg-gray-400 text-white font-bold py-3 rounded-2xl shadow-lg btn-press">Ù…Ù†Ø³ÙˆØ®</button>
                             <button onclick="window.addTask()" id="saveBtn" class="flex-[2] bg-emerald-600 text-white font-bold py-3 rounded-2xl shadow-lg btn-press flex justify-center items-center gap-2">
                                <span>Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚº</span>
                                <svg id="saveIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                             </button>
                        </div>
                    </div>

                    <!-- Diary List -->
                    <div id="diaryScroll" class="flex-1">
                        <div id="filterHeader" class="hidden bg-emerald-100 dark:bg-emerald-900/40 p-2 rounded-xl mb-4 text-center">
                            <span id="filterText" class="text-xs font-bold text-emerald-700 dark:text-emerald-300 urdu-text">ØªØ§Ø±ÛŒØ® ÙÙ„Ù¹Ø±</span>
                            <button onclick="window.clearFilter()" class="mr-2 text-red-500 text-xs font-bold">ØµØ§Ù Ú©Ø±ÛŒÚº âœ–</button>
                        </div>
                        <ul id="taskList" class="space-y-4 pb-10"></ul>
                    </div>
                </div>

                <!-- FINANCE VIEW -->
                <div id="financeView" class="hidden flex-1 flex flex-col overflow-y-auto no-scrollbar pb-32 w-full">
                    
                    <!-- Search for Finance -->
                    <div class="px-5 py-3 bg-emerald-50 dark:bg-slate-900 shadow-inner no-print">
                        <div class="relative">
                            <input type="text" id="transSearchInput" placeholder="Ù„ÛŒÙ† Ø¯ÛŒÙ† ØªÙ„Ø§Ø´ Ú©Ø±ÛŒÚº..." class="w-full p-3 pr-10 bg-white dark:bg-darkinput dark:text-white rounded-2xl text-sm outline-none shadow-sm urdu-text" oninput="window.filterData()">
                            <span class="absolute right-3 top-3 opacity-40">ğŸ”</span>
                        </div>
                    </div>

                    <div class="p-5 md:grid md:grid-cols-2 md:gap-6">
                        
                        <!-- Left Col: Summary & Tools -->
                        <div>
                            <!-- Balance Card -->
                            <div class="bg-gradient-to-br from-emerald-600 to-teal-700 rounded-3xl p-6 text-white shadow-xl mb-5">
                                <div class="flex justify-between items-center mb-6">
                                    <div>
                                        <p class="text-emerald-100 text-xs font-sans" id="balLabel">Ú©Ù„ Ø¨ÛŒÙ„Ù†Ø³</p>
                                        <h2 class="text-4xl font-bold font-sans mt-1" id="finBalance">0</h2>
                                        <p class="text-[10px] text-emerald-200 mt-1" id="finTitle">Ù…ÛŒØ±Ø§ Ø¨ÛŒÙ„Ù†Ø³</p>
                                    </div>
                                    <div class="bg-white/20 p-3 rounded-2xl text-2xl">ğŸ’°</div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-white/10 p-3 rounded-2xl backdrop-blur-sm">
                                        <p class="text-[10px] opacity-80 mb-1">Ø¢Ù…Ø¯Ù† (In)</p>
                                        <h3 class="text-xl font-bold font-sans" id="finTotalIn">0</h3>
                                    </div>
                                    <div class="bg-black/10 p-3 rounded-2xl backdrop-blur-sm">
                                        <p class="text-[10px] opacity-80 mb-1">Ø®Ø±Ú† (Out)</p>
                                        <h3 class="text-xl font-bold font-sans" id="finTotalOut">0</h3>
                                    </div>
                                </div>
                            </div>

                            <!-- Tools & Export -->
                            <div class="bg-white dark:bg-darkcard p-3 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 mb-5 flex justify-around gap-2">
                                <button onclick="window.exportData()" class="flex flex-col items-center gap-1 p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 flex-1 text-slate-700 dark:text-slate-200">
                                    <span class="text-lg">ğŸ“¥</span>
                                    <span class="text-[10px] font-bold urdu-text">Ø§ÛŒÚ©Ø³Ù¾ÙˆØ±Ù¹</span>
                                </button>
                                <label for="importFile" class="flex flex-col items-center gap-1 p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 flex-1 cursor-pointer text-slate-700 dark:text-slate-200">
                                    <span class="text-lg">ğŸ“¤</span>
                                    <span class="text-[10px] font-bold urdu-text">Ø§Ù…Ù¾ÙˆØ±Ù¹</span>
                                    <input type="file" id="importFile" class="hidden" accept=".json" onchange="window.importData(this)">
                                </label>
                                <button onclick="window.printPDF()" class="flex flex-col items-center gap-1 p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 flex-1 text-slate-700 dark:text-slate-200">
                                    <span class="text-lg">ğŸ–¨ï¸</span>
                                    <span class="text-[10px] font-bold urdu-text">PDF</span>
                                </button>
                            </div>

                            <!-- Input Form -->
                            <div class="bg-white dark:bg-darkcard p-5 rounded-3xl shadow-md border dark:border-slate-700 mb-6">
                                <h3 class="text-sm font-bold text-center mb-3 urdu-text" id="transFormTitle">Ù†ÛŒØ§ Ø§Ù†Ø¯Ø±Ø§Ø¬</h3>
                                <div class="flex gap-2 p-1 bg-slate-100 dark:bg-darkinput rounded-2xl mb-4">
                                    <button onclick="window.setTransType('in')" id="btnTypeIn" class="flex-1 py-3 text-sm font-bold rounded-xl transition bg-white text-emerald-600 shadow-sm">Ø¢Ù…Ø¯Ù† (In)</button>
                                    <button onclick="window.setTransType('out')" id="btnTypeOut" class="flex-1 py-3 text-sm font-bold rounded-xl transition text-slate-500">Ø®Ø±Ú† (Out)</button>
                                </div>
                                <div class="flex flex-col gap-3 mb-4">
                                    <input type="number" id="transAmount" placeholder="Ø±Ù‚Ù… Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº" class="w-full p-4 bg-slate-50 dark:bg-darkinput dark:text-white rounded-xl outline-none font-sans font-bold text-center text-xl border-2 border-transparent focus:border-emerald-400 transition-colors">
                                    <input type="text" id="transDesc" placeholder="ØªÙØµÛŒÙ„..." class="w-full p-3 bg-slate-50 dark:bg-darkinput dark:text-white rounded-xl outline-none urdu-text text-right border border-slate-100 dark:border-slate-600">
                                    <input type="date" id="transDateOverride" class="w-full p-2 bg-slate-50 dark:bg-darkinput dark:text-white rounded-xl text-xs font-sans text-center border border-slate-100 dark:border-slate-600">
                                </div>
                                <input type="hidden" id="editTransId" value="">
                                <div class="flex gap-2">
                                    <button onclick="window.cancelTransEdit()" id="cancelTransBtn" class="hidden flex-1 bg-gray-400 text-white font-bold py-3 rounded-2xl shadow-lg btn-press">Ù…Ù†Ø³ÙˆØ®</button>
                                    <button onclick="window.addTransaction()" id="saveTransBtn" class="flex-[2] bg-slate-800 dark:bg-emerald-700 text-white font-bold py-3 rounded-2xl shadow-lg btn-press">Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚº</button>
                                </div>
                            </div>
                        </div>

                        <!-- Right Col: List -->
                        <div id="printableArea">
                            <div id="financeFilterHeader" class="hidden bg-emerald-100 dark:bg-emerald-900/40 p-2 rounded-xl mb-4 text-center no-print">
                                <span id="finFilterText" class="text-xs font-bold text-emerald-700 dark:text-emerald-300 urdu-text">ØªØ§Ø±ÛŒØ® ÙÙ„Ù¹Ø±</span>
                                <button onclick="window.clearFilter()" class="mr-2 text-red-500 text-xs font-bold">ØµØ§Ù Ú©Ø±ÛŒÚº âœ–</button>
                            </div>
                            <h3 class="text-xs font-bold text-slate-400 mb-4 px-2 no-print">Ø­Ø§Ù„ÛŒÛ Ù„ÛŒÙ† Ø¯ÛŒÙ†</h3>
                            <ul id="transList" class="space-y-4"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-emerald-800 text-white text-[11px] px-6 py-2.5 rounded-full shadow-2xl opacity-0 transition-all duration-300 pointer-events-none z-[200] font-sans">Ù¾ÛŒØºØ§Ù…</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, query, where, onSnapshot, deleteDoc, doc, setDoc, getDoc, serverTimestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCwrfDXG8pRpkqDYht0EpRZ8h_ElRu0N_w",
            authDomain: "mysmartdiarypk.firebaseapp.com",
            projectId: "mysmartdiarypk",
            storageBucket: "mysmartdiarypk.firebasestorage.app",
            messagingSenderId: "989892082432",
            appId: "1:989892082432:web:684da193fde4a5915b51e5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- ADMIN EMAIL ---
        const ADMIN_EMAIL = "nawazlive1@gmail.com"; 

        let currentUser = null;
        let currentMode = 'personal'; 
        // DEFAULT GROUP SET TO DUKAAN
        let myGroupId = localStorage.getItem('myGroupId') || 'DUKAAN';
        let userDocUnsub = null;
        let tempSignupName = "";
        
        // Filter & Date Logic
        let allTasks = [];
        let allTrans = [];
        let filterDate = null;
        let currentMonth = new Date();
        let currentTransType = 'in';

        // Helper to show/hide loading
        const showLoading = (msg = "Ù¾Ù„ÛŒØ² ÙˆÛŒÙ¹...") => {
            const ol = document.getElementById('loadingOverlay');
            const txt = document.getElementById('loadingText');
            if(ol && txt) {
                txt.innerText = msg;
                ol.classList.remove('hidden');
            }
        };
        const hideLoading = () => {
            const ol = document.getElementById('loadingOverlay');
            if(ol) ol.classList.add('hidden');
        };

        // --- AUTH & SETUP (From Base Code) ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('authSection').classList.add('hidden');
                showLoading();
                try {
                    const isAdmin = user.email && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
                    if (isAdmin) {
                        const userRef = doc(db, "users", user.uid);
                        setupUserListener(user, true); 
                    } else {
                        setupUserListener(user, false);
                    }
                } catch (e) {
                    hideLoading();
                    showToast("System Error: " + e.message);
                }
            } else {
                currentUser = null;
                if(userDocUnsub) userDocUnsub();
                hideLoading();
                document.getElementById('authSection').classList.remove('hidden');
                document.getElementById('appSection').classList.add('hidden');
                document.getElementById('pendingScreen').classList.add('hidden');
            }
        });

        function setupUserListener(user, forceAdmin) {
            if(userDocUnsub) userDocUnsub();
            const userRef = doc(db, "users", user.uid);
            
            userDocUnsub = onSnapshot(userRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    if (forceAdmin && userData.status !== 'active') {
                        await updateDoc(userRef, { status: 'active' });
                        return;
                    }
                    if (userData.status === 'active' || forceAdmin) {
                        initializeUser(user);
                    } else {
                        hideLoading();
                        showPendingScreen();
                    }
                } else {
                    console.log("Creating missing user doc...");
                    const nameToUse = tempSignupName || user.displayName || "User";
                    try {
                          await setDoc(userRef, {
                            email: user.email,
                            displayName: nameToUse,
                            status: forceAdmin ? 'active' : 'pending',
                            createdAt: serverTimestamp()
                        }, { merge: true });
                    } catch(e) {
                        console.error("Auto-create failed", e);
                        hideLoading();
                        showToast("Error creating profile: " + e.message);
                    }
                }
            }, (error) => {
                hideLoading();
                showToast("Connection Error: " + error.message);
            });
        }

        function initializeUser(user) {
            currentUser = user;
            hideLoading();
            
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('pendingScreen').classList.add('hidden');
            document.getElementById('appSection').classList.remove('hidden');
            
            const displayName = user.displayName || "Ù†Ø§Ù…Ø¹Ù„ÙˆÙ…";
            document.getElementById('userAvatar').innerText = displayName.charAt(0).toUpperCase();
            document.getElementById('headerSub').innerText = `${displayName}`;
            
            if (user.email && user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                document.getElementById('adminPanelBtn').classList.remove('hidden');
                listenForPendingUsers();
            }

            // Ensure DUKAAN is default if not set
            if(!myGroupId) {
                myGroupId = 'DUKAAN';
                localStorage.setItem('myGroupId', 'DUKAAN');
            }

            updateGroupStatusUI();
            loadDataBasedOnMode();
            setDefaultDateTime();
            loadTheme();
        }

        // --- ADMIN PANEL LOGIC (From Base Code) ---
        function listenForPendingUsers() {
            const q = query(collection(db, "users"), where("status", "==", "pending"));
            onSnapshot(q, (snap) => {
                const pendingCount = snap.size;
                const badge = document.getElementById('pendingCountBadge');
                if(pendingCount > 0) {
                    badge.innerText = pendingCount;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
                
                const list = document.getElementById('pendingUsersList');
                list.innerHTML = "";
                if(pendingCount === 0) {
                    list.innerHTML = '<p class="text-center text-xs text-slate-400 mt-4">Ú©ÙˆØ¦ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø²ÛŒØ±Ù Ø§Ù„ØªÙˆØ§Ø¡ Ù†ÛÛŒÚº</p>';
                } else {
                    snap.forEach(docSnap => {
                        const u = docSnap.data();
                        const el = document.createElement('div');
                        el.className = "bg-slate-50 dark:bg-slate-800 p-3 rounded-xl flex justify-between items-center";
                        el.innerHTML = `
                            <div>
                                <p class="text-sm font-bold dark:text-white urdu-text">${u.displayName || 'Ù†Ø§Ù…Ø¹Ù„ÙˆÙ…'}</p>
                                <p class="text[10px] text-slate-500 font-sans">${u.email}</p>
                            </div>
                            <button onclick="window.approveUser('${docSnap.id}')" class="bg-emerald-600 text-white px-3 py-1 rounded-lg text-xs font-bold">Approve</button>
                        `;
                        list.appendChild(el);
                    });
                }
            });
        }

        window.openAdminPanel = () => document.getElementById('adminModal').classList.remove('hidden');
        window.approveUser = async (uid) => {
            if(confirm("Ø§Ø³ ØµØ§Ø±Ù Ú©Ùˆ ÚˆØ§Ø¦Ø±ÛŒ Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ú©Ø±Ù†Û’ Ú©ÛŒ Ø§Ø¬Ø§Ø²Øª Ø¯ÛŒÚºØŸ")) {
                await updateDoc(doc(db, "users", uid), { status: "active" });
                showToast("ØµØ§Ø±Ù Ù…Ù†Ø¸ÙˆØ± ÛÙˆ Ú¯ÛŒØ§ âœ…");
            }
        }
        function showPendingScreen() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('appSection').classList.add('hidden');
            document.getElementById('pendingScreen').classList.remove('hidden');
        }

        // --- MODE SWITCHING & GROUPS (From Base Code) ---
        window.setMode = (mode) => {
            currentMode = mode;
            document.getElementById('btnModePersonal').classList.toggle('active', mode === 'personal');
            document.getElementById('btnModeGroup').classList.toggle('active', mode === 'group');
            
            const label = document.getElementById('inputLabel');
            if(mode === 'personal') {
                label.innerText = "ğŸ”’ Ø°Ø§ØªÛŒ Ù†ÙˆÙ¹";
                label.className = "text-[10px] font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded-md";
                document.getElementById('headerTitle').innerText = "Ù…ÛŒØ±ÛŒ ÚˆØ§Ø¦Ø±ÛŒ";
                document.getElementById('finTitle').innerText = "Ù…ÛŒØ±Ø§ Ø¨ÛŒÙ„Ù†Ø³";
            } else {
                label.innerText = "ğŸ‘¥ Ú¯Ø±ÙˆÙ¾ Ù†ÙˆÙ¹";
                label.className = "text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-md";
                document.getElementById('headerTitle').innerText = myGroupId ? `Ú¯Ø±ÙˆÙ¾: ${myGroupId}` : "Ú¯Ø±ÙˆÙ¾ (Ú©ÙˆÚˆ Ù†ÛÛŒÚº ÛÛ’)";
                document.getElementById('finTitle').innerText = `${myGroupId} Ú©Ø§ Ø¨ÛŒÙ„Ù†Ø³`;
            }
            loadDataBasedOnMode();
        };

        window.openGroupSettings = () => {
            document.getElementById('groupModal').classList.remove('hidden');
            document.getElementById('groupCodeInput').value = myGroupId || "DUKAAN";
        }
        window.saveGroupSettings = () => {
            let code = document.getElementById('groupCodeInput').value.trim().toUpperCase();
            if(!code) code = 'DUKAAN'; // Default to Dukaan if empty

            myGroupId = code;
            localStorage.setItem('myGroupId', code);
            showToast(`Ú¯Ø±ÙˆÙ¾ ${code} Ø¬ÙˆØ§Ø¦Ù† Ú©Ø± Ù„ÛŒØ§`);
            updateGroupStatusUI();
            if(currentMode === 'group') loadDataBasedOnMode();
            
            document.getElementById('groupModal').classList.add('hidden');
        }
        function updateGroupStatusUI() {
            const dot = document.getElementById('groupStatusDot');
            if(myGroupId) dot.className = "absolute top-1 right-1 w-2 h-2 bg-green-500 rounded-full";
            else dot.className = "absolute top-1 right-1 w-2 h-2 bg-red-400 rounded-full animate-pulse";
        }

        // --- DATA LOADING & FILTERING (Merged Logic) ---
        let unsubscribeTasks = null;
        let unsubscribeTrans = null;

        function loadDataBasedOnMode() {
            if(unsubscribeTasks) unsubscribeTasks();
            if(unsubscribeTrans) unsubscribeTrans();

            let qTasks, qTrans;

            if (currentMode === 'personal') {
                qTasks = query(collection(db, "tasks"), where("uid", "==", currentUser.uid), where("visibility", "==", "private"));
                qTrans = query(collection(db, "transactions"), where("uid", "==", currentUser.uid), where("visibility", "==", "private"));
            } else {
                // FORCE DUKAAN IF NOT SET
                if(!myGroupId) myGroupId = 'DUKAAN';
                
                qTasks = query(collection(db, "tasks"), where("groupId", "==", myGroupId), where("visibility", "==", "public"));
                qTrans = query(collection(db, "transactions"), where("groupId", "==", myGroupId), where("visibility", "==", "public"));
            }

            unsubscribeTasks = onSnapshot(qTasks, (snap) => {
                allTasks = []; snap.forEach(d => allTasks.push({id: d.id, ...d.data()}));
                applyDisplay();
                renderCalendar();
            });

            unsubscribeTrans = onSnapshot(qTrans, (snap) => {
                allTrans = []; snap.forEach(d => allTrans.push({id: d.id, ...d.data()}));
                applyDisplay();
                renderCalendar();
            });
        }

        window.filterData = () => applyDisplay();
        window.clearFilter = () => {
            filterDate = null;
            document.getElementById('searchInput').value = "";
            document.getElementById('transSearchInput').value = "";
            applyDisplay();
            document.getElementById('filterHeader').classList.add('hidden');
            document.getElementById('financeFilterHeader').classList.add('hidden');
            showToast("ÙÙ„Ù¹Ø± Ø®ØªÙ… Ú©Ø± Ø¯ÛŒØ§ Ú¯ÛŒØ§");
        };

        function applyDisplay() {
            // Diary Search & Filter
            const searchInput = document.getElementById('searchInput');
            const search = searchInput ? searchInput.value.toLowerCase() : '';
            
            let filteredTasks = [...allTasks];
            if (filterDate) filteredTasks = filteredTasks.filter(t => t.dateDue && t.dateDue.startsWith(filterDate));
            if (search) filteredTasks = filteredTasks.filter(t => t.text.toLowerCase().includes(search));
            filteredTasks.sort((a,b) => new Date(b.dateDue || 0) - new Date(a.dateDue || 0));
            renderTasks(filteredTasks);

            // Finance Search & Filter
            const transSearchInput = document.getElementById('transSearchInput');
            const transSearch = transSearchInput ? transSearchInput.value.toLowerCase() : '';

            let filteredTrans = [...allTrans];
            if (filterDate) filteredTrans = filteredTrans.filter(t => t.date && t.date.startsWith(filterDate));
            if (transSearch) {
                filteredTrans = filteredTrans.filter(t => 
                    t.description.toLowerCase().includes(transSearch) || 
                    t.amount.toString().includes(transSearch)
                );
            }
            
            // Sort
            filteredTrans.sort((a,b) => {
                const dateA = new Date(a.date + 'T00:00:00');
                const dateB = new Date(b.date + 'T00:00:00');
                if (dateA - dateB !== 0) return dateA - dateB;
                const createdA = a.createdAt ? a.createdAt.seconds : 0;
                const createdB = b.createdAt ? b.createdAt.seconds : 0;
                return createdA - createdB;
            });

            // Calc Balance (Filtered)
            let runBal = 0, sumIn = 0, sumOut = 0;
            filteredTrans.forEach(t => {
                const amt = parseFloat(t.amount);
                if(t.type === 'in') { runBal += amt; sumIn += amt; } 
                else { runBal -= amt; sumOut += amt; }
                t.currentBalance = runBal;
            });

            document.getElementById('finTotalIn').innerText = sumIn.toLocaleString();
            document.getElementById('finTotalOut').innerText = sumOut.toLocaleString();
            
            if(transSearch || filterDate) {
                 document.getElementById('finBalance').innerText = (sumIn - sumOut).toLocaleString();
                 document.getElementById('balLabel').innerText = "Ù…ÙˆØ¬ÙˆØ¯Û Ù¹ÙˆÙ¹Ù„ (ÙÙ„Ù¹Ø±)";
                 document.getElementById('balLabel').classList.add('text-yellow-200');
            } else {
                 document.getElementById('finBalance').innerText = (sumIn - sumOut).toLocaleString();
                 document.getElementById('balLabel').innerText = "Ú©Ù„ Ø¨ÛŒÙ„Ù†Ø³";
                 document.getElementById('balLabel').classList.remove('text-yellow-200');
            }

            filteredTrans.reverse();
            renderTransactions(filteredTrans);

            if(filterDate) {
                document.getElementById('filterHeader').classList.remove('hidden');
                document.getElementById('financeFilterHeader').classList.remove('hidden');
                document.getElementById('filterText').innerText = `ÙÙ„Ù¹Ø±: ${filterDate}`;
                document.getElementById('finFilterText').innerText = `ÙÙ„Ù¹Ø±: ${filterDate}`;
            }
        }

        function renderTasks(tasks) {
            const ul = document.getElementById('taskList');
            ul.innerHTML = "";
            if(tasks.length === 0) {
                 ul.innerHTML = '<p class="text-center text-xs opacity-50 mt-10">Ú©ÙˆØ¦ÛŒ Ù†ÙˆÙ¹Ø³ Ù†ÛÛŒÚº</p>';
                 return;
            }
            
            tasks.forEach(task => {
                const li = document.createElement('li');
                li.className = "bg-white dark:bg-darkcard p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 transition-all active:scale-[0.98]";
                
                const formattedDate = task.dateDue ? task.dateDue.replace('T', ' ') : 'Ø¨ØºÛŒØ± ØªØ§Ø±ÛŒØ®';
                const isMine = task.uid === currentUser.uid;
                
                let repliesHtml = '';
                if(task.replies && task.replies.length > 0) {
                    task.replies.forEach(rep => {
                        repliesHtml += `
                            <div class="reply-box mt-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-[10px] font-bold text-emerald-600">${rep.author}</span>
                                    <span class="text-[9px] text-slate-400 font-sans">${rep.time}</span>
                                </div>
                                <p class="text-xs mt-1 urdu-text dark:text-slate-300">${rep.text}</p>
                            </div>`;
                    });
                }

                li.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                             <span class="date-badge font-sans">${formattedDate}</span>
                             <span class="text-[9px] font-bold ml-2 ${currentMode==='group'?'text-blue-600':'text-emerald-700'} urdu-text">
                                ${currentMode==='group' ? 'ğŸ‘¤ '+task.authorName : ''}
                                ${task.category ? 'â€¢ '+task.category : ''}
                             </span>
                        </div>
                         ${isMine ? `
                        <div class="flex gap-2">
                            <button onclick="window.editTask('${task.id}')" class="text-[11px] text-emerald-500 font-bold urdu-text">ØªØ¨Ø¯ÛŒÙ„</button>
                            <button onclick="window.deleteDocById('tasks', '${task.id}')" class="text-[11px] text-red-400 font-bold urdu-text">Ø­Ø°Ù</button>
                        </div>` : ''}
                    </div>
                    <p class="urdu-text text-lg dark:text-slate-200 text-right leading-relaxed mb-3">${task.text}</p>
                    <div class="mb-3">${repliesHtml}</div>
                    ${currentMode === 'group' ? `
                    <div class="flex gap-2 w-full items-center mt-2 pt-2 border-t border-slate-100 dark:border-slate-700">
                         <input type="text" id="replyInput_${task.id}" placeholder="Ø¬ÙˆØ§Ø¨ Ù„Ú©Ú¾ÛŒÚº..." class="flex-1 text-[11px] p-2 bg-slate-50 dark:bg-darkinput dark:text-white rounded-lg outline-none urdu-text">
                         <button onclick="window.addReply('${task.id}')" class="bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-white px-3 py-1 rounded-lg text-[10px] font-bold">Ø¨Ú¾ÛŒØ¬ÛŒÚº</button>
                    </div>` : ''}
                `;
                ul.appendChild(li);
            });
        }

        function renderTransactions(trans) {
            const ul = document.getElementById('transList');
            ul.innerHTML = "";
            let lastDate = null;

            trans.forEach(t => {
                if (t.date !== lastDate) {
                    const dateHeader = document.createElement('li');
                    dateHeader.className = "text-center my-4 relative";
                    dateHeader.innerHTML = `
                        <span class="bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-[10px] font-bold px-3 py-1 rounded-full font-sans shadow-sm border dark:border-slate-700">
                            ğŸ“… ${t.date}
                        </span>
                    `;
                    ul.appendChild(dateHeader);
                    lastDate = t.date;
                }

                const isIn = t.type === 'in';
                const isMine = t.uid === currentUser.uid;
                const balClass = t.currentBalance >= 0 ? 'text-slate-500 dark:text-slate-400' : 'text-red-500';

                // --- NEW: Handle Replies in Transactions ---
                let repliesHtml = '';
                if(t.replies && t.replies.length > 0) {
                    t.replies.forEach(rep => {
                        repliesHtml += `
                            <div class="reply-box mt-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-[10px] font-bold text-emerald-600">${rep.author}</span>
                                    <span class="text-[9px] text-slate-400 font-sans">${rep.time}</span>
                                </div>
                                <p class="text-xs mt-1 urdu-text dark:text-slate-300">${rep.text}</p>
                            </div>`;
                    });
                }

                const iconArrow = isIn 
                    ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>` 
                    : `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>`;

                const li = document.createElement('li');
                li.className = "flex flex-col gap-2 p-4 bg-white dark:bg-darkcard rounded-2xl border dark:border-slate-700 shadow-sm relative overflow-hidden group hover:border-emerald-200 dark:hover:border-emerald-800 transition-colors";
                
                li.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-3 flex-1">
                            <div class="w-10 h-10 rounded-full ${isIn?'bg-emerald-100 text-emerald-600':'bg-red-100 text-red-600'} flex-shrink-0 flex items-center justify-center shadow-sm">
                                ${iconArrow}
                            </div>
                            <div class="text-right min-w-0">
                                <p class="text-[10px] text-slate-400 font-sans mt-0.5">${currentMode==='group' ? t.authorName : t.date}</p>
                            </div>
                        </div>
                        <div class="text-left">
                            <p class="${isIn?'text-emerald-600':'text-red-500'} font-bold font-sans text-lg whitespace-nowrap">${t.amount.toLocaleString()}</p>
                        </div>
                    </div>
                    
                    <div class="w-full">
                        <p class="urdu-text text-sm dark:text-white font-bold break-words text-right leading-relaxed">${t.description}</p>
                    </div>

                    <div class="flex justify-between items-center mt-3 pt-2 border-t border-dashed border-slate-100 dark:border-slate-700/50">
                        <div class="bg-slate-50 dark:bg-slate-800/50 px-3 py-1.5 rounded-lg border border-slate-100 dark:border-slate-700">
                            <p class="font-sans font-bold whitespace-nowrap flex items-baseline gap-2">
                                <span class="text-slate-400 text-[10px] uppercase tracking-wider">Balance:</span> 
                                <span class="${balClass} text-base">${t.currentBalance.toLocaleString()}</span>
                            </p>
                        </div>

                         ${isMine ? `
                        <div class="flex gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="window.editTransaction('${t.id}')" class="text-xs text-blue-500 font-bold no-print bg-blue-50 dark:bg-blue-900/20 px-2 py-1 rounded hover:bg-blue-100 transition">âœï¸</button>
                            <button onclick="window.deleteDocById('transactions', '${t.id}')" class="text-xs text-red-400 font-bold no-print bg-red-50 dark:bg-red-900/20 px-2 py-1 rounded hover:bg-red-100 transition">ğŸ—‘ï¸</button>
                        </div>` : ''}
                    </div>

                    <!-- NEW: Replies Section for Transactions -->
                    <div class="mb-3">${repliesHtml}</div>
                    ${currentMode === 'group' ? `
                    <div class="flex gap-2 w-full items-center mt-2 pt-2 border-t border-slate-100 dark:border-slate-700">
                         <input type="text" id="transReplyInput_${t.id}" placeholder="ØªØ¨ØµØ±Û Ú©Ø±ÛŒÚº..." class="flex-1 text-[11px] p-2 bg-slate-50 dark:bg-darkinput dark:text-white rounded-lg outline-none urdu-text">
                         <button onclick="window.addTransReply('${t.id}')" class="bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-white px-3 py-1 rounded-lg text-[10px] font-bold">Ø¨Ú¾ÛŒØ¬ÛŒÚº</button>
                    </div>` : ''}
                `;
                ul.appendChild(li);
            });
        }

        // --- CRUD ACTIONS (Merged Logic) ---
        window.addTask = async () => {
            const text = document.getElementById('taskInput').value.trim();
            const editId = document.getElementById('editTaskId').value;
            const category = document.getElementById('taskCategory').value;
            const dateDue = document.getElementById('taskDate').value;
            
            if(!text) return showToast("Ú©Ú†Ú¾ Ù„Ú©Ú¾ÛŒÚº!");
            // Auto-Dukaan safeguard
            if(currentMode === 'group' && !myGroupId) myGroupId = 'DUKAAN';

            const payload = {
                text, dateDue, category,
                uid: currentUser.uid,
                authorName: currentUser.displayName,
                visibility: currentMode === 'personal' ? 'private' : 'public',
                groupId: currentMode === 'group' ? myGroupId : null,
                createdAt: serverTimestamp()
            };

            try {
                if(editId) {
                    await updateDoc(doc(db, "tasks", editId), { text, dateDue, category });
                    showToast("ØªØ¨Ø¯ÛŒÙ„ÛŒ Ù…Ø­ÙÙˆØ¸ ÛÙˆ Ú¯Ø¦ÛŒ âœ¨");
                    window.cancelTaskEdit();
                } else {
                    payload.replies = [];
                    await addDoc(collection(db, "tasks"), payload);
                    showToast(currentMode === 'personal' ? "Ù…Ø­ÙÙˆØ¸ (Ø°Ø§ØªÛŒ) ğŸ”’" : "Ø´ÛŒØ¦Ø± Ú©Ø± Ø¯ÛŒØ§ (Ú¯Ø±ÙˆÙ¾) ğŸ‘¥");
                    document.getElementById('taskInput').value = "";
                    setDefaultDateTime();
                }
            } catch(e) { showToast("Ø§ÛŒØ±Ø±: " + e.message); }
        };

        window.addTransaction = async () => {
            const amount = parseFloat(document.getElementById('transAmount').value);
            const desc = document.getElementById('transDesc').value.trim();
            const dateVal = document.getElementById('transDateOverride').value || new Date().toISOString().split('T')[0];
            const editId = document.getElementById('editTransId').value;
            
            if(!amount || !desc) return showToast("ÚˆÛŒÙ¹Ø§ Ù†Ø§Ù…Ú©Ù…Ù„ ÛÛ’");
            // Auto-Dukaan safeguard
            if(currentMode === 'group' && !myGroupId) myGroupId = 'DUKAAN';

            const payload = {
                amount, description: desc,
                type: currentTransType, date: dateVal,
                uid: currentUser.uid,
                authorName: currentUser.displayName,
                visibility: currentMode === 'personal' ? 'private' : 'public',
                groupId: currentMode === 'group' ? myGroupId : null,
                createdAt: serverTimestamp()
            };

            try {
                if(editId) {
                    await updateDoc(doc(db, "transactions", editId), {
                        amount, description: desc, type: currentTransType, date: dateVal
                    });
                    showToast("Ø§Ù¾ ÚˆÛŒÙ¹ ÛÙˆ Ú¯ÛŒØ§ âœ…");
                    window.cancelTransEdit();
                } else {
                    payload.replies = []; // Ensure replies array exists
                    await addDoc(collection(db, "transactions"), payload);
                    showToast("Ø­Ø³Ø§Ø¨ Ù…Ø­ÙÙˆØ¸ ÛÙˆ Ú¯ÛŒØ§ ğŸ’°");
                    document.getElementById('transAmount').value = "";
                    document.getElementById('transDesc').value = "";
                }
            } catch(e) { showToast("Ø§ÛŒØ±Ø± Ù¾ÛŒØ´ Ø¢ÛŒØ§"); }
        };

        window.addReply = async (taskId) => {
            const input = document.getElementById(`replyInput_${taskId}`);
            const text = input.value.trim();
            if(!text) return;
            try {
                await updateDoc(doc(db, "tasks", taskId), {
                    replies: arrayUnion({
                        text, author: currentUser.displayName,
                        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                        uid: currentUser.uid
                    })
                });
                showToast("Ø¬ÙˆØ§Ø¨ Ø¨Ú¾ÛŒØ¬ Ø¯ÛŒØ§");
            } catch(e) { console.log(e); }
        };

        // --- NEW: Add Reply for Transactions ---
        window.addTransReply = async (transId) => {
            const input = document.getElementById(`transReplyInput_${transId}`);
            const text = input.value.trim();
            if(!text) return;
            try {
                await updateDoc(doc(db, "transactions", transId), {
                    replies: arrayUnion({
                        text, author: currentUser.displayName,
                        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                        uid: currentUser.uid
                    })
                });
                showToast("ØªØ¨ØµØ±Û Ø¨Ú¾ÛŒØ¬ Ø¯ÛŒØ§");
            } catch(e) { 
                console.log(e); 
                // Fallback: If document was old and didn't have replies array
                try {
                    await setDoc(doc(db, "transactions", transId), {
                        replies: [{
                            text, author: currentUser.displayName,
                            time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                            uid: currentUser.uid
                        }]
                    }, { merge: true });
                    showToast("ØªØ¨ØµØ±Û Ø¨Ú¾ÛŒØ¬ Ø¯ÛŒØ§");
                } catch(err) { showToast("Error adding reply"); }
            }
        };

        // --- EDITING & HELPERS (From Current Code) ---
        window.editTask = (id) => {
            const task = allTasks.find(t => t.id === id);
            if(task && task.uid === currentUser.uid) {
                 document.getElementById('diaryView').scrollTop = 0;
                 document.getElementById('taskInput').value = task.text;
                 document.getElementById('taskDate').value = task.dateDue || "";
                 document.getElementById('taskCategory').value = task.category || "Ø¹Ø§Ù…";
                 document.getElementById('editTaskId').value = id;
                 document.getElementById('saveBtn').innerHTML = '<span>Ø§Ù¾ ÚˆÛŒÙ¹ Ú©Ø±ÛŒÚº</span><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>';
                 document.getElementById('taskFormTitle').innerText = "Ù†ÙˆÙ¹ ØªØ¨Ø¯ÛŒÙ„ Ú©Ø±ÛŒÚº";
                 document.getElementById('cancelTaskBtn').classList.remove('hidden');
                 document.getElementById('taskInput').focus();
                 showToast("Ø§ÛŒÚˆÙ¹ Ù…ÙˆÚˆ Ø¢Ù† ÛÛ’");
            } else { showToast("Ø¢Ù¾ ØµØ±Ù Ø§Ù¾Ù†ÛŒ Ù¾ÙˆØ³Ù¹ Ø§ÛŒÚˆÙ¹ Ú©Ø± Ø³Ú©ØªÛ’ ÛÛŒÚº"); }
        };
        window.cancelTaskEdit = () => {
            document.getElementById('editTaskId').value = "";
            document.getElementById('taskInput').value = "";
            document.getElementById('taskFormTitle').innerText = "Ù†ÛŒØ§ Ù†ÙˆÙ¹ Ù„Ú©Ú¾ÛŒÚº";
            document.getElementById('cancelTaskBtn').classList.add('hidden');
            document.getElementById('saveBtn').innerHTML = '<span>Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚº</span><svg id="saveIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>';
            setDefaultDateTime();
        };

        window.editTransaction = (id) => {
            const t = allTrans.find(tr => tr.id === id);
            if(t && t.uid === currentUser.uid) {
                document.getElementById('financeView').scrollTop = 0;
                document.getElementById('transAmount').value = t.amount;
                document.getElementById('transDesc').value = t.description;
                document.getElementById('transDateOverride').value = t.date;
                window.setTransType(t.type);
                document.getElementById('editTransId').value = id;
                document.getElementById('saveTransBtn').innerText = "Ø§Ù¾ ÚˆÛŒÙ¹ Ú©Ø±ÛŒÚº";
                document.getElementById('transFormTitle').innerText = "Ø§Ù†Ø¯Ø±Ø§Ø¬ ØªØ¨Ø¯ÛŒÙ„ Ú©Ø±ÛŒÚº";
                document.getElementById('cancelTransBtn').classList.remove('hidden');
                document.getElementById('transAmount').focus();
                showToast("Ø§ÛŒÚˆÙ¹ Ù…ÙˆÚˆ: Ú©ÛŒØ´");
            } else { showToast("Ø¢Ù¾ ØµØ±Ù Ø§Ù¾Ù†ÛŒ Ø§Ù†Ù¹Ø±ÛŒ Ø§ÛŒÚˆÙ¹ Ú©Ø± Ø³Ú©ØªÛ’ ÛÛŒÚº"); }
        };
        window.cancelTransEdit = () => {
            document.getElementById('editTransId').value = "";
            document.getElementById('transAmount').value = "";
            document.getElementById('transDesc').value = "";
            document.getElementById('transDateOverride').value = new Date().toISOString().split('T')[0];
            document.getElementById('saveTransBtn').innerText = "Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚº";
            document.getElementById('transFormTitle').innerText = "Ù†ÛŒØ§ Ø§Ù†Ø¯Ø±Ø§Ø¬";
            document.getElementById('cancelTransBtn').classList.add('hidden');
        }

        // --- AUTH & COMMON FUNCTIONS ---
        window.loginUser = async () => {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            try { await signInWithEmailAndPassword(auth, email, pass); }
            catch(e) { showToast("Ù„Ø§Ú¯ Ø§Ù† Ù†Ø§Ú©Ø§Ù…"); }
        };
        window.signupUser = async () => {
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value;
            const pass = document.getElementById('signupPass').value;
            const btn = document.getElementById('signupBtn');
            
            if(!name) return showToast("Ø¨Ø±Ø§Ø¦Û’ Ù…ÛØ±Ø¨Ø§Ù†ÛŒ Ø§Ù¾Ù†Ø§ Ù†Ø§Ù… Ù„Ú©Ú¾ÛŒÚº");
            const originalText = btn.innerText; btn.innerText = "Ú©Ø§Ù… Ø¬Ø§Ø±ÛŒ ÛÛ’..."; btn.disabled = true; btn.classList.add('opacity-50');
            tempSignupName = name;
            try { 
                await createUserWithEmailAndPassword(auth, email, pass);
                if (auth.currentUser) updateProfile(auth.currentUser, { displayName: name }).catch(e=>console.log(e));
                showToast("Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ú¾ÛŒØ¬ Ø¯ÛŒ Ú¯Ø¦ÛŒ!");
            }
            catch(e) { 
                showToast("Ù…Ø³Ø¦Ù„Û: " + e.message); 
                btn.innerText = originalText; btn.disabled = false; btn.classList.remove('opacity-50'); hideLoading();
            }
        };
        window.logoutUser = () => signOut(auth);
        window.showScreen = (id) => {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById(id).classList.remove('hidden');
        };

        // --- CALENDAR & UTILS ---
        window.toggleCalendar = () => document.getElementById('calendarView').classList.toggle('hidden');
        window.changeMonth = (val) => { currentMonth.setMonth(currentMonth.getMonth() + val); renderCalendar(); };
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthHeader = document.getElementById('currentMonthYear');
            if(!grid || !monthHeader) return;
            grid.innerHTML = "";
            const year = currentMonth.getFullYear(); const month = currentMonth.getMonth();
            monthHeader.innerText = currentMonth.toLocaleString('default', { month: 'long', year: 'numeric' });
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for(let i=0; i<firstDay; i++) grid.innerHTML += '<div></div>';
            for(let d=1; d<=daysInMonth; d++) {
                const dStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const hasTask = allTasks.some(t => t.dateDue && t.dateDue.startsWith(dStr));
                const hasTrans = allTrans.some(t => t.date === dStr);
                const isToday = new Date().toISOString().split('T')[0] === dStr;
                const dayBtn = document.createElement('button');
                dayBtn.className = `h-10 w-10 flex flex-col items-center justify-center rounded-xl relative transition-all duration-200 border border-transparent 
                                    ${isToday?'bg-emerald-600 text-white shadow-lg z-10 scale-110':'text-slate-700 dark:text-slate-100 hover:bg-emerald-50 dark:hover:bg-slate-700 hover:border-emerald-200'}`;
                dayBtn.innerHTML = `<span class="${(hasTask||hasTrans)?'font-bold':''}">${d}</span>`;
                if(hasTask || hasTrans) dayBtn.innerHTML += `<div class="calendar-dot ${isToday?'bg-white':'bg-emerald-500'}"></div>`;
                dayBtn.onclick = () => {
                    filterDate = dStr; applyDisplay(); toggleCalendar();
                    showToast("ÙÙ„Ù¹Ø±: " + dStr);
                };
                grid.appendChild(dayBtn);
            }
        }

        // --- EXPORT/IMPORT ---
        window.exportData = () => {
            if(!allTrans.length) return showToast("Ú©ÙˆØ¦ÛŒ ÚˆÛŒÙ¹Ø§ Ù†ÛÛŒÚº");
            const dataStr = JSON.stringify(allTrans);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', 'smart_diary_data.json');
            linkElement.click();
            showToast("ÚˆØ§Ø¤Ù† Ù„ÙˆÚˆ Ø´Ø±ÙˆØ¹ ÛÙˆ Ú¯ÛŒØ§");
        };
        window.importData = (input) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(Array.isArray(data) && confirm(`Ú©ÛŒØ§ Ø¢Ù¾ ${data.length} Ø§Ù†Ù¹Ø±ÛŒØ² Ø§Ù…Ù¾ÙˆØ±Ù¹ Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ`)) {
                        let count = 0;
                        for (const item of data) {
                             // SPECIAL FEATURE: IF IMPORTING IN GROUP MODE, ASSIGN TO GROUP
                             // If Importing in Personal Mode, Assign to Personal
                             const groupIdForImport = currentMode === 'group' ? myGroupId : null;
                             const visibilityForImport = currentMode === 'group' ? 'public' : 'private';

                             // Check existence to prevent duplicates
                             const exists = allTrans.some(t => t.description === item.description && t.amount === item.amount && t.date === item.date);
                             
                             if(!exists) {
                                await addDoc(collection(db, "transactions"), {
                                    amount: item.amount, description: item.description, date: item.date,
                                    type: item.type, uid: currentUser.uid, authorName: currentUser.displayName,
                                    visibility: visibilityForImport,
                                    groupId: groupIdForImport,
                                    createdAt: serverTimestamp()
                                });
                                count++;
                             }
                        }
                        showToast(`${count} Ø§Ù†Ù¹Ø±ÛŒØ² ${currentMode==='group'?'Ø¯Ú©Ø§Ù†':'Ø°Ø§ØªÛŒ'} Ù…ÛŒÚº Ø´Ø§Ù…Ù„ ÛÙˆ Ú¯Ø¦ÛŒÚº`);
                    }
                } catch(err) { showToast("ØºÙ„Ø· ÙØ§Ø¦Ù„ ÙØ§Ø±Ù…ÛŒÙ¹"); }
            };
            reader.readAsText(file);
            input.value = '';
        };
        window.printPDF = () => window.print();

        // --- SHARED ---
        window.deleteDocById = async (coll, id) => { if(confirm("Ø­Ø°Ù Ú©Ø± Ø¯ÛŒÚºØŸ")) await deleteDoc(doc(db, coll, id)); };
        window.switchTab = (tab) => {
            const isDiary = tab === 'diary';
            document.getElementById('diaryView').classList.toggle('hidden', !isDiary);
            document.getElementById('financeView').classList.toggle('hidden', isDiary);
            document.getElementById('tabIndicator').style.left = isDiary ? '50%' : '1%';
            const btnD = document.getElementById('btnDiary'); const btnF = document.getElementById('btnFinance');
            if(isDiary) {
                btnD.classList.add('text-emerald-950', 'dark:text-white'); btnD.classList.remove('text-emerald-100/70', 'dark:text-slate-400');
                btnF.classList.add('text-emerald-100/70', 'dark:text-slate-400'); btnF.classList.remove('text-emerald-950', 'dark:text-white');
            } else {
                btnF.classList.add('text-emerald-950', 'dark:text-white'); btnF.classList.remove('text-emerald-100/70', 'dark:text-slate-400');
                btnD.classList.add('text-emerald-100/70', 'dark:text-slate-400'); btnD.classList.remove('text-emerald-950', 'dark:text-white');
            }
        };
        window.setTransType = (type) => {
            currentTransType = type;
            document.getElementById('btnTypeIn').classList.toggle('bg-white', type === 'in');
            document.getElementById('btnTypeIn').classList.toggle('text-emerald-600', type === 'in');
            document.getElementById('btnTypeOut').classList.toggle('bg-white', type === 'out');
            document.getElementById('btnTypeOut').classList.toggle('text-red-600', type === 'out');
        };
        window.toggleDarkMode = () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            document.getElementById('darkModeIcon').innerText = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            renderCalendar(); 
        };
        function setDefaultDateTime() {
            const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            const dateInput = document.getElementById('taskDate'); if(dateInput) dateInput.value = now.toISOString().slice(0, 16);
            const transDate = document.getElementById('transDateOverride'); if(transDate) transDate.value = now.toISOString().slice(0, 10);
        }
        function loadTheme() {
            if(localStorage.getItem('theme') === 'dark') { document.documentElement.classList.add('dark'); document.getElementById('darkModeIcon').innerText = 'â˜€ï¸'; }
        }
        function showToast(msg) {
            const t = document.getElementById('toast'); if(!t) return;
            t.innerText = msg; t.style.opacity = '1'; setTimeout(() => t.style.opacity = '0', 3000);
        }
    </script>
</body>
</html>
