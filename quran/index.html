<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>قرآن پرو میکس - مکمل فیچرز</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&family=Amiri:wght@400;700&family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        urdu: ['"Noto Nastaliq Urdu"', 'serif'],
                        arabic: ['"Amiri"', 'serif'],
                        sans: ['"Outfit"', 'sans-serif'],
                    },
                    colors: {
                        primary: '#10B981',   // Emerald
                        secondary: '#F59E0B', // Amber
                        dark: '#0F172A',      // Slate 900
                        darker: '#020617',    // Slate 950
                    },
                    animation: {
                        'spin-slow': 'spin 15s linear infinite',
                    }
                }
            }
        }
    </script>

    <style>
        /* Modern Scrollbar */
        @media (min-width: 1024px) {
            ::-webkit-scrollbar { width: 8px; }
            ::-webkit-scrollbar-track { background: transparent; }
            ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
            .dark ::-webkit-scrollbar-thumb { background: #334155; }
        }

        /* Range Slider Styling - Universal & Big */
        input[type=range] { -webkit-appearance: none; background: transparent; cursor: pointer; height: 20px; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%;
            background: #10B981; margin-top: -7px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #cbd5e1; border-radius: 2px; }
        .dark input[type=range]::-webkit-slider-runnable-track { background: #475569; }

        /* Visualizer Bars */
        .bar { width: 5px; background: #10B981; border-radius: 3px; transition: height 0.1s ease; }
        
        /* Glass Effect */
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .dark .glass { background: rgba(15, 23, 42, 0.8); border-bottom: 1px solid rgba(255,255,255,0.05); }

        /* Active Tab Underline */
        .tab-active { color: #10B981; position: relative; }
        .tab-active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: #10B981; border-radius: 4px 4px 0 0; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-darker text-gray-800 dark:text-gray-100 font-urdu transition-colors duration-300 min-h-screen flex flex-col">

    <!-- Header -->
    <nav class="glass sticky top-0 z-50 h-16 shrink-0">
        <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-primary text-white rounded-lg flex items-center justify-center shadow-lg shadow-emerald-500/20">
                    <i class="fa-solid fa-quran text-lg"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold leading-none mt-1">قرآن پرو</h1>
                    <span class="text-[10px] text-gray-500 dark:text-gray-400 font-sans tracking-widest uppercase">Premium Audio</span>
                </div>
            </div>
            
            <div class="flex gap-3">
                 <button id="timer-btn" class="w-10 h-10 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition relative group" title="Sleep Timer">
                    <i class="fa-solid fa-stopwatch text-gray-600 dark:text-gray-300"></i>
                    <!-- Timer Tooltip -->
                    <span id="timer-display" class="absolute -bottom-2 -right-2 bg-primary text-white text-[9px] px-1 rounded hidden font-sans"></span>
                </button>
                <button id="theme-btn" class="w-10 h-10 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition">
                    <i class="fa-solid fa-moon text-gray-600 dark:text-gray-300"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="flex flex-col lg:flex-row flex-grow max-w-7xl mx-auto w-full lg:h-[calc(100vh-64px)] lg:overflow-hidden">

        <!-- LEFT PANEL: PLAYER (Fixed Width on Desktop) -->
        <div class="w-full lg:w-[450px] bg-white dark:bg-dark p-6 shadow-xl z-20 flex flex-col items-center justify-between shrink-0 lg:overflow-y-auto border-b lg:border-b-0 lg:border-l border-gray-200 dark:border-gray-800 relative">
            
            <!-- Metadata Badge -->
            <div class="absolute top-4 left-4 bg-gray-100 dark:bg-gray-800 px-3 py-1 rounded-full text-xs font-sans text-gray-500 dark:text-gray-400 border border-gray-200 dark:border-gray-700">
                <span id="meta-type">Makkah</span> • <span id="meta-ayahs">7 Ayahs</span>
            </div>

            <!-- Favorite Button -->
            <button id="fav-btn" class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition text-xl">
                <i class="fa-regular fa-heart"></i>
            </button>

            <!-- Album Art -->
            <div class="relative w-64 h-64 mt-8 mb-6 group">
                <div class="absolute inset-0 bg-gradient-to-tr from-primary to-blue-600 rounded-full blur-2xl opacity-30 group-hover:opacity-50 transition duration-700"></div>
                <div class="relative w-full h-full bg-gray-50 dark:bg-gray-900 rounded-full border-8 border-white dark:border-gray-800 shadow-2xl flex items-center justify-center overflow-hidden">
                    <div id="spinner" class="absolute inset-2 border-2 border-dashed border-primary/40 rounded-full animate-spin-slow paused"></div>
                    <div class="text-center z-10 px-6">
                        <h2 id="track-title" class="font-arabic text-3xl font-bold mb-1 text-gray-800 dark:text-white drop-shadow-sm">سورة الفاتحة</h2>
                        <p id="qari-title" class="text-xs text-gray-500 dark:text-gray-400 font-sans tracking-wide uppercase">Mishary Al-Afasy</p>
                    </div>
                </div>
            </div>

            <!-- Visualizer -->
            <div id="visualizer" class="flex gap-1 h-10 items-center justify-center mb-6 w-full px-12 opacity-80">
                <!-- JS Generated -->
            </div>

            <!-- Main Controls Section -->
            <div class="w-full space-y-6">
                
                <!-- Seek Bar -->
                <div>
                    <input type="range" id="seek-bar" value="0" class="w-full mb-1">
                    <div class="flex justify-between text-xs font-sans font-medium text-gray-400">
                        <span id="curr-time">00:00</span>
                        <span id="dur-time">00:00</span>
                    </div>
                </div>

                <!-- Playback Buttons -->
                <div class="flex items-center justify-center gap-6">
                    <button id="shuffle-btn" class="text-gray-400 hover:text-primary transition" title="Shuffle"><i class="fa-solid fa-shuffle"></i></button>
                    
                    <button id="prev-btn" class="text-2xl text-gray-600 dark:text-gray-300 hover:text-primary transition"><i class="fa-solid fa-backward-step"></i></button>
                    
                    <button id="play-btn" class="w-16 h-16 rounded-full bg-primary hover:bg-emerald-600 text-white shadow-xl shadow-emerald-500/30 flex items-center justify-center text-2xl transition transform hover:scale-105 active:scale-95">
                        <i class="fa-solid fa-play ml-1"></i>
                    </button>
                    
                    <button id="next-btn" class="text-2xl text-gray-600 dark:text-gray-300 hover:text-primary transition"><i class="fa-solid fa-forward-step"></i></button>
                    
                    <button id="loop-btn" class="text-gray-400 hover:text-primary transition" title="Loop"><i class="fa-solid fa-repeat"></i></button>
                </div>

                <!-- Advanced Tools (Volume Fix included) -->
                <div class="bg-gray-50 dark:bg-gray-800/60 rounded-xl p-4 space-y-4">
                    
                    <!-- Volume Row (Fixed Width Issue) -->
                    <div class="flex items-center gap-3">
                        <button id="mute-btn" class="text-gray-500 dark:text-gray-400 hover:text-primary w-6"><i class="fa-solid fa-volume-high"></i></button>
                        <input type="range" id="vol-bar" max="1" step="0.05" value="1" class="flex-grow h-2">
                        <span id="vol-text" class="text-xs font-sans text-gray-400 w-8 text-left">100%</span>
                    </div>

                    <div class="flex justify-between items-center pt-2 border-t border-gray-200 dark:border-gray-700">
                        <button id="speed-btn" class="text-xs font-bold font-sans px-3 py-1 bg-gray-200 dark:bg-gray-700 rounded hover:bg-primary hover:text-white transition">1.0x</button>
                        
                        <div class="flex gap-4">
                            <button id="share-btn" class="text-gray-500 hover:text-primary transition" title="Copy Info"><i class="fa-solid fa-share-nodes"></i></button>
                            <a id="dl-btn" href="#" target="_blank" class="text-gray-500 hover:text-primary transition" title="Download"><i class="fa-solid fa-download"></i></a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loader Overlay -->
            <div id="loader" class="absolute inset-0 bg-white/80 dark:bg-dark/80 z-50 flex flex-col items-center justify-center hidden backdrop-blur-sm">
                <i class="fa-solid fa-circle-notch animate-spin text-4xl text-primary mb-3"></i>
                <span class="text-sm font-sans text-gray-600 dark:text-gray-300 animate-pulse">Loading High Quality Audio...</span>
            </div>
        </div>

        <!-- RIGHT PANEL: LISTS -->
        <div class="flex-grow flex flex-col bg-gray-50 dark:bg-darker min-h-[500px]">
            
            <!-- Tabs -->
            <div class="flex bg-white dark:bg-dark border-b border-gray-200 dark:border-gray-800 sticky top-0 z-30 shadow-sm">
                <button onclick="setTab('surah')" id="tab-surah" class="flex-1 py-4 font-bold text-gray-500 hover:bg-gray-50 dark:hover:bg-gray-800 transition tab-active">سورتیں</button>
                <button onclick="setTab('qari')" id="tab-qari" class="flex-1 py-4 font-bold text-gray-500 hover:bg-gray-50 dark:hover:bg-gray-800 transition">قاری</button>
                <button onclick="setTab('fav')" id="tab-fav" class="flex-1 py-4 font-bold text-gray-500 hover:bg-gray-50 dark:hover:bg-gray-800 transition"><i class="fa-solid fa-heart text-xs ml-1"></i> محفوظ</button>
            </div>

            <!-- Search -->
            <div class="p-3 bg-white/60 dark:bg-dark/60 backdrop-blur sticky top-[58px] z-20">
                <div class="relative group">
                    <input type="text" id="search" placeholder="تلاش کریں (سورت / قاری)..." class="w-full py-3 px-10 rounded-xl bg-gray-200 dark:bg-gray-800 border-2 border-transparent focus:border-primary focus:bg-white dark:focus:bg-dark outline-none transition text-sm">
                    <i class="fa-solid fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-primary transition"></i>
                </div>
            </div>

            <!-- List Content -->
            <div id="list-box" class="flex-grow overflow-y-auto p-3 space-y-2 pb-20 lg:pb-6 custom-scroll">
                <!-- Javascript will populate this -->
            </div>
        </div>
    </div>

    <!-- Timer Modal (Hidden) -->
    <div id="timer-modal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl w-80 transform scale-100 transition">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-moon text-primary"></i> سلیپ ٹائمر</h3>
            <div class="grid grid-cols-3 gap-2 mb-4">
                <button onclick="setSleep(15)" class="p-2 bg-gray-100 dark:bg-gray-700 rounded hover:bg-primary hover:text-white transition text-sm">15 Min</button>
                <button onclick="setSleep(30)" class="p-2 bg-gray-100 dark:bg-gray-700 rounded hover:bg-primary hover:text-white transition text-sm">30 Min</button>
                <button onclick="setSleep(60)" class="p-2 bg-gray-100 dark:bg-gray-700 rounded hover:bg-primary hover:text-white transition text-sm">60 Min</button>
            </div>
            <button onclick="setSleep(0)" class="w-full py-2 border border-red-500 text-red-500 rounded hover:bg-red-500 hover:text-white transition mb-2">ٹائمر بند کریں</button>
            <button onclick="toggleModal('timer-modal')" class="w-full text-gray-500 text-sm">کینسل</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg z-[70] translate-y-20 opacity-0 transition duration-300 flex items-center gap-2">
        <i class="fa-solid fa-check-circle text-primary"></i>
        <span id="toast-msg">Notification</span>
    </div>

    <script>
        // --- Data ---
        const qaris = [
            { name: "مشاری راشد العفاسی", url: "https://server8.mp3quran.net/afs/" },
            { name: "عبدالرحمن السدیس", url: "https://server11.mp3quran.net/sds/" },
            { name: "عبدالباسط (مجود)", url: "https://server7.mp3quran.net/basit/Mujawwad/" },
            { name: "ماہر المعیقلی", url: "https://server12.mp3quran.net/maher/" },
            { name: "سعد الغامدی", url: "https://server7.mp3quran.net/s_gmd/" },
            { name: "سعود الشریم", url: "https://server7.mp3quran.net/shur/" },
            { name: "احمد العجمی", url: "https://server10.mp3quran.net/ajm/" },
            { name: "ناصر القطامی", url: "https://server6.mp3quran.net/qtm/" },
            { name: "یاسر الدوسری", url: "https://server11.mp3quran.net/yasser/" },
            { name: "محمد صدیق المنشاوی", url: "https://server10.mp3quran.net/minsh/" },
            { name: "ابو بکر الشاطری", url: "https://server11.mp3quran.net/shatri/" },
            { name: "عبداللہ عواد الجہنی", url: "https://server13.mp3quran.net/juhany/" }
        ];

        // Extended Surah Data
        const surahData = [
            {name:"الفاتحة", type:"Makki", ayahs:7}, {name:"البقرة", type:"Madani", ayahs:286}, {name:"آل عمران", type:"Madani", ayahs:200},
            {name:"النساء", type:"Madani", ayahs:176}, {name:"المائدة", type:"Madani", ayahs:120}, {name:"الأنعام", type:"Makki", ayahs:165},
            {name:"الأعراف", type:"Makki", ayahs:206}, {name:"الأنفال", type:"Madani", ayahs:75}, {name:"التوبة", type:"Madani", ayahs:129},
            {name:"يونس", type:"Makki", ayahs:109}, {name:"هود", type:"Makki", ayahs:123}, {name:"يوسف", type:"Makki", ayahs:111},
            {name:"الرعد", type:"Madani", ayahs:43}, {name:"إبراهيم", type:"Makki", ayahs:52}, {name:"الحجر", type:"Makki", ayahs:99},
            {name:"النحل", type:"Makki", ayahs:128}, {name:"الإسراء", type:"Makki", ayahs:111}, {name:"الكهف", type:"Makki", ayahs:110},
            {name:"مريم", type:"Makki", ayahs:98}, {name:"طه", type:"Makki", ayahs:135}, {name:"الأنبياء", type:"Makki", ayahs:112},
            {name:"الحج", type:"Madani", ayahs:78}, {name:"المؤمنون", type:"Makki", ayahs:118}, {name:"النور", type:"Madani", ayahs:64},
            {name:"الفرقان", type:"Makki", ayahs:77}, {name:"الشعراء", type:"Makki", ayahs:227}, {name:"النمل", type:"Makki", ayahs:93},
            {name:"القصص", type:"Makki", ayahs:88}, {name:"العنكبوت", type:"Makki", ayahs:69}, {name:"الروم", type:"Makki", ayahs:60},
            {name:"لقمان", type:"Makki", ayahs:34}, {name:"السجدة", type:"Makki", ayahs:30}, {name:"الأحزاب", type:"Madani", ayahs:73},
            {name:"سبأ", type:"Makki", ayahs:54}, {name:"فاطر", type:"Makki", ayahs:45}, {name:"يس", type:"Makki", ayahs:83},
            {name:"الصافات", type:"Makki", ayahs:182}, {name:"ص", type:"Makki", ayahs:88}, {name:"الزمر", type:"Makki", ayahs:75},
            {name:"غافر", type:"Makki", ayahs:85}, {name:"فصلت", type:"Makki", ayahs:54}, {name:"الشورى", type:"Makki", ayahs:53},
            {name:"الزخرف", type:"Makki", ayahs:89}, {name:"الدخان", type:"Makki", ayahs:59}, {name:"الجاثية", type:"Makki", ayahs:37},
            {name:"الأحقاف", type:"Makki", ayahs:35}, {name:"محمد", type:"Madani", ayahs:38}, {name:"الفتح", type:"Madani", ayahs:29},
            {name:"الحجرات", type:"Madani", ayahs:18}, {name:"ق", type:"Makki", ayahs:45}, {name:"الذاريات", type:"Makki", ayahs:60},
            {name:"الطور", type:"Makki", ayahs:49}, {name:"النجم", type:"Makki", ayahs:62}, {name:"القمر", type:"Makki", ayahs:55},
            {name:"الرحمن", type:"Madani", ayahs:78}, {name:"الواقعة", type:"Makki", ayahs:96}, {name:"الحديد", type:"Madani", ayahs:29},
            {name:"المجادلة", type:"Madani", ayahs:22}, {name:"الحشر", type:"Madani", ayahs:24}, {name:"الممتحنة", type:"Madani", ayahs:13},
            {name:"الصف", type:"Madani", ayahs:14}, {name:"الجمعة", type:"Madani", ayahs:11}, {name:"المنافقون", type:"Madani", ayahs:11},
            {name:"التغابن", type:"Madani", ayahs:18}, {name:"الطلاق", type:"Madani", ayahs:12}, {name:"التحريم", type:"Madani", ayahs:12},
            {name:"الملك", type:"Makki", ayahs:30}, {name:"القلم", type:"Makki", ayahs:52}, {name:"الحاقة", type:"Makki", ayahs:52},
            {name:"المعارج", type:"Makki", ayahs:44}, {name:"نوح", type:"Makki", ayahs:28}, {name:"الجن", type:"Makki", ayahs:28},
            {name:"المزمل", type:"Makki", ayahs:20}, {name:"المدثر", type:"Makki", ayahs:56}, {name:"القيامة", type:"Makki", ayahs:40},
            {name:"الإنسان", type:"Madani", ayahs:31}, {name:"المرسلات", type:"Makki", ayahs:50}, {name:"النبأ", type:"Makki", ayahs:40},
            {name:"النازعات", type:"Makki", ayahs:46}, {name:"عبس", type:"Makki", ayahs:42}, {name:"التكوير", type:"Makki", ayahs:29},
            {name:"الإنفطار", type:"Makki", ayahs:19}, {name:"المطففين", type:"Makki", ayahs:36}, {name:"الإنشقاق", type:"Makki", ayahs:25},
            {name:"البروج", type:"Makki", ayahs:22}, {name:"الطارق", type:"Makki", ayahs:17}, {name:"الأعلى", type:"Makki", ayahs:19},
            {name:"الغاشية", type:"Makki", ayahs:26}, {name:"الفجر", type:"Makki", ayahs:30}, {name:"البلد", type:"Makki", ayahs:20},
            {name:"الشمس", type:"Makki", ayahs:15}, {name:"الليل", type:"Makki", ayahs:21}, {name:"الضحى", type:"Makki", ayahs:11},
            {name:"الشرح", type:"Makki", ayahs:8}, {name:"التين", type:"Makki", ayahs:8}, {name:"العلق", type:"Makki", ayahs:19},
            {name:"القدر", type:"Makki", ayahs:5}, {name:"البينة", type:"Madani", ayahs:8}, {name:"الزلزلة", type:"Madani", ayahs:8},
            {name:"العاديات", type:"Makki", ayahs:11}, {name:"القارعة", type:"Makki", ayahs:11}, {name:"التكاثر", type:"Makki", ayahs:8},
            {name:"العصر", type:"Makki", ayahs:3}, {name:"الهمزة", type:"Makki", ayahs:9}, {name:"الفيل", type:"Makki", ayahs:5},
            {name:"قريش", type:"Makki", ayahs:4}, {name:"الماعون", type:"Makki", ayahs:7}, {name:"الكوثر", type:"Makki", ayahs:3},
            {name:"الكافرون", type:"Makki", ayahs:6}, {name:"النصر", type:"Madani", ayahs:3}, {name:"المسد", type:"Makki", ayahs:5},
            {name:"الإخلاص", type:"Makki", ayahs:4}, {name:"الفلق", type:"Makki", ayahs:5}, {name:"الناس", type:"Makki", ayahs:6}
        ];

        // --- State ---
        let st = {
            q: 0, s: 0, play: false, tab: 'surah', spd: 1.0, 
            favs: JSON.parse(localStorage.getItem('favs') || '[]'),
            shuffle: false, loop: false, timer: null
        };
        const audio = new Audio();
        const speeds = [1.0, 1.25, 1.5, 2.0, 0.75];
        let spdIdx = 0;

        // Elements
        const el = id => document.getElementById(id);
        const visualizer = el('visualizer');

        // --- Init ---
        function init() {
            if(localStorage.theme === 'dark' || (!localStorage.theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
            
            // Build Visualizer
            visualizer.innerHTML = '';
            for(let i=0; i<16; i++) {
                let d = document.createElement('div');
                d.className = 'bar h-3';
                visualizer.appendChild(d);
            }

            // Events
            el('play-btn').onclick = togglePlay;
            el('prev-btn').onclick = () => changeTrack(-1);
            el('next-btn').onclick = () => changeTrack(1);
            el('shuffle-btn').onclick = toggleShuffle;
            el('loop-btn').onclick = toggleLoop;
            el('fav-btn').onclick = toggleFav;
            el('speed-btn').onclick = toggleSpeed;
            el('timer-btn').onclick = () => toggleModal('timer-modal');
            el('search').oninput = (e) => render(e.target.value);
            el('theme-btn').onclick = toggleTheme;
            el('share-btn').onclick = shareTrack;
            el('mute-btn').onclick = toggleMute;

            // Audio Events
            audio.ontimeupdate = updateProgress;
            audio.onended = handleEnd;
            audio.onwaiting = () => el('loader').classList.remove('hidden');
            audio.onplaying = () => el('loader').classList.add('hidden');
            audio.onerror = () => showToast('آڈیو لوڈ کرنے میں مسئلہ ہے');

            // Sliders
            el('seek-bar').oninput = (e) => { if(audio.duration) audio.currentTime = (e.target.value/100)*audio.duration; };
            el('vol-bar').oninput = (e) => { audio.volume = e.target.value; updateVolIcon(); };

            // Keyboard
            document.addEventListener('keydown', (e) => {
                if(e.code === 'Space') { e.preventDefault(); togglePlay(); }
                if(e.code === 'ArrowRight') audio.currentTime += 5;
                if(e.code === 'ArrowLeft') audio.currentTime -= 5;
            });

            render();
            updateInfo();
        }

        // --- Core Logic ---
        function getUrl(q, s) { return qaris[q].url + (s+1).toString().padStart(3,'0') + ".mp3"; }

        function togglePlay() {
            if(st.play) { audio.pause(); st.play = false; }
            else playAudio();
            updateUI();
        }

        function playAudio() {
            const link = getUrl(st.q, st.s);
            if(audio.src !== link) {
                audio.src = link;
                audio.playbackRate = st.spd;
                el('loader').classList.remove('hidden');
            }
            audio.play().then(() => {
                st.play = true;
                updateUI();
            }).catch(e => console.error(e));
            updateInfo();
        }

        function changeTrack(dir) {
            if(st.shuffle) {
                st.s = Math.floor(Math.random() * 114);
            } else {
                st.s = (st.s + dir + 114) % 114;
            }
            playAudio();
        }

        function updateUI() {
            const btn = el('play-btn');
            const icon = btn.querySelector('i');
            const spin = el('spinner');
            
            if(st.play) {
                icon.className = "fa-solid fa-pause";
                btn.classList.add('bg-emerald-700');
                spin.classList.remove('paused');
                startVisualizer();
            } else {
                icon.className = "fa-solid fa-play ml-1";
                btn.classList.remove('bg-emerald-700');
                spin.classList.add('paused');
                stopVisualizer();
            }
            // Update Fav Icon State
            const isFav = st.favs.some(f => f.q === st.q && f.s === st.s);
            const favIcon = el('fav-btn').querySelector('i');
            favIcon.className = isFav ? "fa-solid fa-heart text-red-500" : "fa-regular fa-heart";
            
            render(el('search').value);
        }

        function updateInfo() {
            const surah = surahData[st.s];
            el('track-title').innerText = "سورة " + surah.name;
            el('qari-title').innerText = qaris[st.q].name;
            el('meta-type').innerText = surah.type;
            el('meta-ayahs').innerText = surah.ayahs + " آیات";
            el('dl-btn').href = getUrl(st.q, st.s);
            
            updateUI();
        }

        function updateProgress() {
            if(audio.duration) {
                el('seek-bar').value = (audio.currentTime / audio.duration) * 100;
                el('curr-time').innerText = fmt(audio.currentTime);
                el('dur-time').innerText = fmt(audio.duration);
            }
        }

        function handleEnd() {
            if(st.loop) { audio.currentTime = 0; audio.play(); }
            else changeTrack(1);
        }

        // --- Features ---
        function toggleFav() {
            const idx = st.favs.findIndex(f => f.q === st.q && f.s === st.s);
            if(idx > -1) {
                st.favs.splice(idx, 1);
                showToast('محفوظ شدہ فہرست سے ہٹا دیا گیا');
            } else {
                st.favs.push({q: st.q, s: st.s});
                showToast('محفوظ کر لیا گیا ❤️');
            }
            localStorage.setItem('favs', JSON.stringify(st.favs));
            updateUI();
        }

        function toggleShuffle() {
            st.shuffle = !st.shuffle;
            el('shuffle-btn').classList.toggle('text-primary');
            showToast(st.shuffle ? 'شفل آن' : 'شفل آف');
        }

        function toggleLoop() {
            st.loop = !st.loop;
            el('loop-btn').classList.toggle('text-primary');
            showToast(st.loop ? 'لوپ آن' : 'لوپ آف');
        }

        function setSleep(min) {
            clearTimeout(st.timer);
            el('timer-display').classList.add('hidden');
            if(min > 0) {
                st.timer = setTimeout(() => {
                    audio.pause();
                    st.play = false;
                    updateUI();
                    showToast('ٹائمر مکمل، تلاوت بند');
                }, min * 60000);
                showToast(`ٹائمر سیٹ: ${min} منٹ`);
                el('timer-display').innerText = min + "m";
                el('timer-display').classList.remove('hidden');
            } else {
                showToast('ٹائمر ختم کر دیا گیا');
            }
            toggleModal('timer-modal');
        }

        function toggleSpeed() {
            spdIdx = (spdIdx + 1) % speeds.length;
            st.spd = speeds[spdIdx];
            audio.playbackRate = st.spd;
            el('speed-btn').innerText = st.spd + "x";
        }
        
        function updateVolIcon() {
            const v = audio.volume;
            el('vol-text').innerText = Math.round(v * 100) + "%";
            const icon = el('mute-btn').querySelector('i');
            if(v === 0) icon.className = "fa-solid fa-volume-xmark";
            else if(v < 0.5) icon.className = "fa-solid fa-volume-low";
            else icon.className = "fa-solid fa-volume-high";
        }
        
        function toggleMute() {
            if(audio.volume > 0) {
                audio.oldVol = audio.volume;
                audio.volume = 0;
                el('vol-bar').value = 0;
            } else {
                audio.volume = audio.oldVol || 1;
                el('vol-bar').value = audio.volume;
            }
            updateVolIcon();
        }

        function shareTrack() {
            const text = `سنیں: سورة ${surahData[st.s].name} - قاری ${qaris[st.q].name}\nLink: ${getUrl(st.q, st.s)}`;
            navigator.clipboard.writeText(text);
            showToast('لنک کاپی ہو گیا!');
        }

        // --- Visualizer Simulation ---
        let visInterval;
        function startVisualizer() {
            clearInterval(visInterval);
            visInterval = setInterval(() => {
                Array.from(visualizer.children).forEach(b => {
                    b.style.height = (Math.random() * 20 + 4) + 'px';
                });
            }, 100);
        }
        function stopVisualizer() {
            clearInterval(visInterval);
            Array.from(visualizer.children).forEach(b => b.style.height = '4px');
        }

        // --- List Rendering ---
        function setTab(t) {
            st.tab = t;
            el('search').value = '';
            
            // Classes
            ['surah', 'qari', 'fav'].forEach(k => {
                const b = el(`tab-${k}`);
                if(k === t) b.classList.add('tab-active');
                else b.classList.remove('tab-active');
            });
            render();
        }

        function render(q = '') {
            const box = el('list-box');
            box.innerHTML = '';
            const term = q.toLowerCase();

            if(st.tab === 'fav') {
                if(st.favs.length === 0) {
                    box.innerHTML = `<div class="text-center text-gray-400 mt-10"><i class="fa-regular fa-heart text-4xl mb-2"></i><br>کوئی پسندیدہ تلاوت موجود نہیں</div>`;
                    return;
                }
                st.favs.forEach((f) => {
                    const div = createListItem(f.q, f.s, true);
                    box.appendChild(div);
                });
            } else if(st.tab === 'surah') {
                surahData.forEach((s, i) => {
                    if(s.name.includes(term) || (i+1).toString().includes(term)) {
                        const div = document.createElement('div');
                        const active = i === st.s;
                        div.className = `flex items-center justify-between p-3 rounded-xl cursor-pointer transition border border-transparent ${active ? 'bg-emerald-50 dark:bg-emerald-900/20 border-primary' : 'bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700'}`;
                        div.onclick = () => { st.s = i; playAudio(); };
                        div.innerHTML = `
                            <div class="flex items-center gap-4">
                                <div class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-xs font-sans text-gray-500">${i+1}</div>
                                <div>
                                    <h3 class="font-bold ${active ? 'text-primary' : ''}">${s.name}</h3>
                                    <p class="text-[10px] text-gray-400 font-sans">${s.type} • ${s.ayahs} Ayahs</p>
                                </div>
                            </div>
                            ${active && st.play ? '<i class="fa-solid fa-chart-simple text-primary animate-pulse"></i>' : ''}
                        `;
                        box.appendChild(div);
                    }
                });
            } else { // Qari
                qaris.forEach((qar, i) => {
                    if(qar.name.includes(term)) {
                        const div = document.createElement('div');
                        const active = i === st.q;
                        div.className = `flex items-center gap-3 p-3 rounded-xl cursor-pointer transition border border-transparent ${active ? 'bg-emerald-50 dark:bg-emerald-900/20 border-primary' : 'bg-white dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700'}`;
                        div.onclick = () => { st.q = i; updateInfo(); if(st.play) playAudio(); render(el('search').value); };
                        div.innerHTML = `
                             <div class="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-gray-500 overflow-hidden">
                                <i class="fa-solid fa-user"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-sm ${active ? 'text-primary' : ''}">${qar.name}</h3>
                                <span class="text-[10px] text-primary bg-primary/10 px-1 rounded">HQ Audio</span>
                            </div>
                        `;
                        box.appendChild(div);
                    }
                });
            }
        }

        function createListItem(qIdx, sIdx, isFavList) {
            const div = document.createElement('div');
            const isActive = st.q === qIdx && st.s === sIdx;
            div.className = `flex items-center justify-between p-3 rounded-xl cursor-pointer transition bg-white dark:bg-gray-800 mb-2 border border-transparent hover:border-primary`;
            
            div.onclick = () => { 
                st.q = qIdx; st.s = sIdx; 
                playAudio(); 
                if(!isFavList) render(); // re-render to update active state
            };

            div.innerHTML = `
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-play-circle text-2xl text-gray-300 ${isActive ? 'text-primary' : ''}"></i>
                    <div>
                        <h3 class="font-bold text-sm">سورة ${surahData[sIdx].name}</h3>
                        <p class="text-xs text-gray-500">${qaris[qIdx].name}</p>
                    </div>
                </div>
                ${isFavList ? '<i class="fa-solid fa-heart text-red-500 text-sm"></i>' : ''}
            `;
            return div;
        }

        // --- Utils ---
        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        }

        function toggleModal(id) {
            const m = el(id);
            if(m.classList.contains('hidden')) {
                m.classList.remove('hidden');
                setTimeout(() => m.firstElementChild.classList.remove('scale-90', 'opacity-0'), 10);
            } else {
                m.firstElementChild.classList.add('scale-90', 'opacity-0');
                setTimeout(() => m.classList.add('hidden'), 200);
            }
        }

        function showToast(msg) {
            const t = el('toast');
            el('toast-msg').innerText = msg;
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        function fmt(s) {
            if(isNaN(s)) return "00:00";
            let m = Math.floor(s/60);
            let sc = Math.floor(s%60);
            return `${m}:${sc < 10 ? '0'+sc : sc}`;
        }

        init();
    </script>
</body>
</html>
