<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Rashid LPG (Secure Login)</title>
  
  <!-- LATEST FONT: Outfit (Modern, Clean, Professional) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root { 
        /* LPG THEME: Blue Flame Colors */
        --bg:#f8fafc; /* Very light cool gray */
        --card:#ffffff; 
        --ink:#0f172a; /* Deep dark blue text */
        --muted:#64748b; 
        
        /* Main Brand Colors - Gas Blue */
        --brand:#0284c7; /* Bright Gas Blue */
        --brand-2:#0369a1; /* Darker Blue for hover */
        --accent:#38bdf8; /* Light Cyan for highlights */
        
        --danger:#ef4444; 
        --warning:#f59e0b; 
        --ok:#10b981; 
        --line:#e2e8f0; 
    }
    
    *{box-sizing:border-box}
    
    body {
        font-family: 'Outfit', sans-serif; /* Applied latest font */
        margin:0;
        background:var(--bg);
        color:var(--ink);
        -webkit-font-smoothing: antialiased;
    }
    
    /* --- HEADER STYLES (LPG Gas Flame Theme) --- */
    header { 
        /* Gradient representing the blue gas flame */
        background: linear-gradient(135deg, #0f172a 0%, #075985 50%, #0284c7 100%);
        color: #fff; 
        padding: 30px 20px; 
        box-shadow: 0 4px 20px rgba(2, 132, 199, 0.25);
        border-bottom: 1px solid #0369a1;
        position: relative;
    }
    
    .header-content { 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        gap: 16px; 
        max-width: 1100px; 
        margin: 0 auto; 
    }
    
    header h1 { 
        margin: 0; 
        font-size: 42px; 
        font-weight: 700; 
        text-align: center; 
        letter-spacing: -0.5px; 
        text-transform: uppercase; 
        background: -webkit-linear-gradient(#fff, #e0f2fe);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .toolbar { display: flex; gap: 10px; align-items: center; justify-content: center; flex-wrap: wrap; width: 100%; }
    
    /* Status Banner */
    #status-banner {
        background: var(--warning); color: #000; padding: 8px; text-align: center; font-weight: 600; font-size: 14px;
        display: none; width: 100%;
    }
    #status-banner.error { background: var(--danger); color: white; }
    #status-banner.online { background: var(--ok); color: white; }

    /* LOGIN OVERLAY */
    #login-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(248, 250, 252, 0.95); backdrop-filter: blur(5px);
        z-index: 1000; display: flex; align-items: center; justify-content: center;
    }
    .login-box {
        background: white; padding: 40px; border-radius: 20px; 
        box-shadow: 0 20px 40px rgba(0,0,0,0.08); border: 1px solid var(--line);
        width: 100%; max-width: 400px; text-align: center;
    }
    .login-box h2 { margin-top: 0; color: var(--brand); font-weight: 700; }
    .login-box input { width: 100%; margin-bottom: 15px; padding: 14px; font-size: 16px; border-radius: 12px; border: 1px solid var(--line); background: #f8fafc; }
    .login-box input:focus { border-color: var(--brand); outline: none; background: #fff; }
    .login-box button { width: 100%; padding: 14px; font-size: 16px; background: var(--brand); border-radius: 12px; margin-top: 10px; }
    .login-error { color: var(--danger); font-size: 14px; margin-bottom: 10px; display: none; }

    header .toolbar label.muted{color:rgba(255,255,255,0.8);font-weight:500}
    
    /* Modern Inputs */
    select,input[type="date"],input[type="number"],input[type="text"],button, textarea{
        border:1px solid var(--line);
        border-radius:12px;
        padding:10px 14px;
        background:var(--card);
        color:var(--ink);
        font-size:14px;
        font-family: 'Outfit', sans-serif;
        transition: all 0.2s;
    }
    input:focus, select:focus { border-color: var(--brand); outline: none; box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.1); }
    
    /* Modern Buttons */
    button{
        cursor:pointer;border:0;
        background:var(--brand);
        color:#fff;
        font-weight:600;
        letter-spacing: 0.5px;
        transition:all .2s ease;
        box-shadow: 0 4px 6px -1px rgba(2, 132, 199, 0.2);
    }
    button:hover{ background:var(--brand-2); transform: translateY(-1px); box-shadow: 0 6px 8px -1px rgba(2, 132, 199, 0.3); }
    button:active{ transform: translateY(0); }
    
    button.ghost{
        background:rgba(255,255,255,0.1);
        color:#fff;
        border:1px solid rgba(255,255,255,0.2);
        box-shadow: none;
    }
    button.ghost:hover{ background:rgba(255,255,255,0.2); }
    
    /* Different style for ghost buttons inside cards (light bg) */
    .card button.ghost {
        background: #f1f5f9; color: var(--muted); border: 1px solid transparent;
    }
    .card button.ghost:hover { background: #e2e8f0; color: var(--ink); }

    button.small{padding:6px 12px;font-size:12px;border-radius:8px}

    /* Tabs */
    nav.tabs{
        display:flex; gap:8px; padding:12px; 
        background:var(--card); border-bottom:1px solid var(--line);
        position:sticky; top:0; z-index:10; overflow-x:auto; justify-content: center;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02);
    }
    nav.tabs button{
        background:transparent; color:var(--muted); border:0; border-radius: 8px;
        font-weight:600; flex-shrink:0; box-shadow: none; padding: 8px 16px;
    }
    nav.tabs button:hover{ background: #f0f9ff; color: var(--brand); }
    nav.tabs button.active{ background:#e0f2fe; color:var(--brand); } /* Light blue active state */

    main{padding:24px 16px;max-width:1100px;margin:0 auto}
    
    /* Cards */
    .card{
        background:var(--card);
        border:1px solid var(--line);
        border-radius:16px;
        padding:24px;
        box-shadow:0 4px 6px -1px rgba(0,0,0,0.05);
        margin-bottom: 20px;
    }
    
    .stack{display:grid;gap:20px}
    
    /* Tables */
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:14px;text-align:center; border-bottom: 1px solid var(--line);}
    thead th{
        background:#f8fafc; color:var(--muted);
        font-weight:600; font-size:12px; text-transform:uppercase; letter-spacing: 1px;
        border-top: 1px solid var(--line);
    }
    thead th:first-child { border-top-left-radius: 12px; border-left: 1px solid var(--line); }
    thead th:last-child { border-top-right-radius: 12px; border-right: 1px solid var(--line); }
    
    tbody tr:last-child td { border-bottom: 0; }
    tbody tr:hover{background:#f0f9ff;cursor:pointer} /* Very light blue hover */
    
    tfoot tr{background: #f8fafc; font-weight:700; color: var(--brand);}
    tfoot td { border-top: 2px solid var(--brand); }

    .grid{display:grid;gap:16px}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .grid.cols-5{grid-template-columns:repeat(5,minmax(0,1fr))}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap; margin-bottom: 16px;}
    .spacer{flex:1}
    .hidden{display:none!important}
    .note{font-size:13px;color:var(--muted)}
    
    /* Summary Styling */
    .summary-list{display:grid;gap:8px}
    .summary-item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;font-size:15px; border-radius: 8px;}
    .summary-item:hover { background: #f8fafc; }
    .summary-item span{color:var(--muted)}
    .summary-item strong{color:var(--ink);font-weight:600}
    .summary-item.final-profit { background: #f0fdf4; border: 1px solid #dcfce7; }
    .summary-item.final-profit span{font-weight:600;color:#166534}
    .summary-item.final-profit strong{font-size:18px;font-weight:700; color:#166534}
    
    .expanded-row td{background:#f1f5f9!important;padding:16px;text-align:left; box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);}
    .details-table th { background: #e2e8f0; color: var(--ink); border: 1px solid #cbd5e1; }
    .details-table td { border: 1px solid #cbd5e1; background: white; }

    .daily-positive{background:linear-gradient(90deg,#f0fdf4,transparent)}
    .daily-negative{background:linear-gradient(90deg,#fef2f2,transparent)}

    /* Responsive adjustments */
    @media (max-width:768px){
      .grid.cols-3,.grid.cols-4,.grid.cols-5{grid-template-columns:1fr}
      #filter-bar{flex-direction:column;align-items:stretch}
      .card{overflow-x:auto; padding: 16px;}
      header h1 { font-size: 28px; }
      table{min-width:600px}
    }
    
    @media print{
        body{background:#fff;color:#000}
        header,nav.tabs,#filter-bar,main>section .row,main>section div[id$="Form"],button,details,.note{display:none!important}
        main,.card,section{display:block;box-shadow:none;border:none;padding:0;margin:0}
        main>section{page-break-after:always}
        main>section#tab-summary{page-break-after:avoid}
        .hidden{display:block!important}
        table{width:100%;border:1px solid #000}
        th,td{border:1px solid #000;padding:6px}
        thead th{background:#eee}
        .summary-list{border:1px solid #000;padding:10px}
    }
  </style>
</head>
<body>

  <!-- LOGIN OVERLAY -->
  <div id="login-overlay">
      <div class="login-box">
          <h2>üîê Secure Login</h2>
          <p class="muted">Enter your email and password to access the ledger.</p>
          <div id="login-error" class="login-error">Incorrect email or password.</div>
          <input type="email" id="txtEmail" placeholder="Email Address" />
          <input type="password" id="txtPassword" placeholder="Password" />
          <button id="btnLogin">Log In</button>
      </div>
  </div>

  <div id="status-banner">Connecting...</div>
  <header>
    <div class="header-content">
      <h1>Rashid LPG</h1>
      <div class="toolbar">
        <select id="monthSelect"></select>
        <select id="yearSelect"></select>
        <button class="ghost" id="btnToggleFilter">Filters</button>
        <button class="ghost" id="btnPrint">Print</button>
        <button class="ghost" id="btnImport">Import</button>
        <button class="ghost" id="btnExport">Export</button>
        <button class="ghost" id="btnLogout" style="border-color: rgba(255,255,255,0.3);">Log Out</button>
        <input class="hidden" type="file" id="fileInput" accept="application/json" />
      </div>
    </div>
  </header>

  <nav class="tabs">
    <button data-tab="purchases" class="active">üõí Purchases</button>
    <button data-tab="sales">üí∞ Sales</button>
    <button data-tab="expenses">üí∏ Expenses</button>
    <button data-tab="summary">üìã Summary</button>
    <button data-tab="daily">üìÖ Daily View</button>
  </nav>

  <section id="filter-bar" class="card hidden" style="max-width: 1100px; margin: 16px auto 0 auto;">
    <label>From</label>
    <input type="date" id="filterDateFrom" />
    <label>To</label>
    <input type="date" id="filterDateTo" />
    <input type="text" id="filterText" placeholder="Search notes/descriptions..." style="flex: 1;" />
    <button id="btnApplyFilter">Apply</button>
    <button class="ghost" id="btnResetFilter">Reset</button>
  </section>

  <main class="stack">
    
    <!-- PURCHASES TAB -->
    <section id="tab-purchases" class="card">
      <div class="row">
        <h2>Purchases</h2>
        <span class="spacer"></span>
        <button id="addPurchase">+ Add Purchase</button>
      </div>
      <!-- Added Supplier Field -->
      <div id="purchaseForm" class="grid cols-5 hidden">
        <input type="datetime-local" id="pDate" />
        <input type="text" id="pSupplier" placeholder="Supplier Name" />
        <input type="number" id="pCyl" placeholder="Cylinders" min="1" />
        <input type="number" id="pUnit" placeholder="Unit price" min="0" step="1" />
        <input type="number" id="pTotal" placeholder="Total price" min="0" step="1" />
        <button id="pSave" style="grid-column: span 5;">Save Purchase</button>
        <button class="ghost" id="pCancel" style="grid-column: span 5;">Cancel</button>
        <span class="note" style="grid-column: 1 / -1;">Enter unit OR total ‚Äî both stay in sync automatically.</span>
      </div>
      <div id="purchaseTable"></div>
    </section>

    <!-- SALES TAB -->
    <section id="tab-sales" class="card hidden">
      <div class="row">
        <h2>Sales</h2>
        <span class="spacer"></span>
        <button id="addSale">+ Add Sale</button>
      </div>
      <!-- Added Customer Field, Changed Layout -->
      <div id="saleForm" class="grid cols-3 hidden">
        <input type="datetime-local" id="sDate" />
        <input type="text" id="sCustomer" placeholder="Customer Name (e.g. Rashid)" />
        <input type="number" id="sCyl" placeholder="Cylinders" min="1" />
        <input type="number" id="sUnit" placeholder="Unit price" min="0" step="1" />
        <input type="number" id="sTotal" placeholder="Total sale" min="0" step="1" />
        <input type="text" id="sNote" placeholder="Note (optional)" />
        <button id="sSave" style="grid-column: span 3;">Save Sale</button>
        <button class="ghost" id="sCancel" style="grid-column: span 3;">Cancel</button>
        <span class="note" style="grid-column: 1 / -1;">Enter unit OR total ‚Äî both stay in sync automatically.</span>
      </div>
      <div id="salesTable"></div>
    </section>

    <!-- EXPENSES TAB -->
    <section id="tab-expenses" class="card hidden">
      <div class="row">
        <h2>Expenses</h2>
        <span class="spacer"></span>
        <button id="addExpense">+ Add Expense</button>
      </div>
      <div id="expenseForm" class="grid cols-4 hidden">
        <input type="datetime-local" id="eDate" />
        <input type="text" id="eNote" placeholder="Description" />
        <input type="number" id="eAmount" placeholder="Amount" min="0" step="1" />
        <span></span>
        <button id="eSave">Save Expense</button>
        <button class="ghost" id="eCancel">Cancel</button>
      </div>
      <div id="expensesTable"></div>
    </section>

    <!-- SUMMARY TAB -->
    <section id="tab-summary" class="card hidden">
      <h2>Summary</h2>
      <div id="summaryBox"></div>
      <p class="note">Summary uses FIFO to compute cost of goods sold. Remaining stock and value are as of the end of the selected month (or filtered selection).</p>
    </section>

    <!-- DAILY TAB -->
    <section id="tab-daily" class="card hidden">
      <h2>Daily Breakdown</h2>
      <p class="note">A day-by-day breakdown of sales, costs, and expenses for the selected month. Click any row to expand details for that day.</p>
      <div id="dailyTable"></div>
    </section>
  </main>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCMkXvwJ_T6-Y6d3PiyhAW80oO9k0tspBw",
      authDomain: "lpg-ledger-shah.firebaseapp.com",
      projectId: "lpg-ledger-shah",
      storageBucket: "lpg-ledger-shah.firebasestorage.app",
      messagingSenderId: "28929807086",
      appId: "1:28929807086:web:4a8a9371dee25a863dd9ff",
      measurementId: "G-JD7EL91XMB"
    };

    try {
      firebase.initializeApp(firebaseConfig);
    } catch(e) {
      console.error("Firebase Init Error:", e);
    }
    
    const db = firebase.firestore();
    const auth = firebase.auth();
    const ledgerDocRef = db.collection('ledger').doc('store');
    const CLIENT_ID = 'c' + Math.floor(Math.random()*1e9);

    const MONTHS = ["January","February","March","April","May","June","July","August","September","October","November","December"];

    let store = emptyStore();
    let isApplyingRemote = false;
    let currentUser = null;

    initAuthMonitor();

    function emptyStore(){ return {}; }

    function updateStatusBanner(status, isError=false) {
        const banner = document.getElementById('status-banner');
        banner.style.display = 'block';
        banner.innerText = status;
        banner.className = isError ? 'error' : (status.includes('Connected') ? 'online' : '');
    }

    function initAuthMonitor() {
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-overlay').style.display = 'none';
                setupSnapshotListener();
            } else {
                currentUser = null;
                document.getElementById('login-overlay').style.display = 'flex';
                updateStatusBanner("Waiting for Login...");
            }
        });
    }

    document.getElementById('btnLogin').onclick = async () => {
        const email = document.getElementById('txtEmail').value;
        const pass = document.getElementById('txtPassword').value;
        const errDiv = document.getElementById('login-error');
        
        if(!email || !pass) {
            errDiv.innerText = "Please enter email and password";
            errDiv.style.display = 'block';
            return;
        }

        errDiv.style.display = 'none';
        document.getElementById('btnLogin').innerText = "Logging in...";
        document.getElementById('btnLogin').disabled = true;

        try {
            await auth.signInWithEmailAndPassword(email, pass);
        } catch(e) {
            console.error(e);
            errDiv.innerText = "Login Failed: " + e.message;
            errDiv.style.display = 'block';
            document.getElementById('btnLogin').innerText = "Log In";
            document.getElementById('btnLogin').disabled = false;
        }
    };

    document.getElementById('btnLogout').onclick = async () => {
        if(confirm("Are you sure you want to log out?")) {
            await auth.signOut();
            window.location.reload();
        }
    };

    document.getElementById('txtPassword').addEventListener("keyup", function(event) {
        if (event.keyCode === 13) {
            document.getElementById('btnLogin').click();
        }
    });

    function setupSnapshotListener(){
      ledgerDocRef.onSnapshot(async (docSnap) => {
        updateStatusBanner("üü¢ Cloud Connected (Secure)", false);
        
        if(!docSnap.exists){
          const fixedData = getFixedInitialData();
          try {
            await ledgerDocRef.set({ data: fixedData, updatedAt: firebase.firestore.FieldValue.serverTimestamp(), updatedBy: CLIENT_ID });
          } catch(e) {
            console.error('Error creating initial ledger doc:', e);
            if(e.code === 'permission-denied') {
               alert("Permission Denied: You are logged in, but Firestore Rules might still be blocking writes. Check Rules.");
            }
          }
          return;
        }

        const remote = docSnap.data();
        if(!remote) return;
        const remoteData = remote.data || {};

        try {
          const localJson = JSON.stringify(store || {});
          const remoteJson = JSON.stringify(remoteData || {});
          if(localJson === remoteJson) {
            render();
            return;
          }
        } catch(e){ /* ignore */ }

        isApplyingRemote = true;
        store = remoteData;
        repairIdsInStore(store);
        
        localStorage.setItem('lpg_ledger_v19', JSON.stringify(store));
        
        initMonthYearOptions();
        render();
        setTimeout(()=> { isApplyingRemote = false; }, 300);

      }, (err) => {
        console.error('Realtime listener error:', err);
        if(err.code === 'permission-denied') {
            updateStatusBanner("‚ö†Ô∏è Access Denied", true);
        }
      });
    }

    let saveLock = false;
    async function saveStore(){
      if(isApplyingRemote) return;
      if(saveLock) return;

      if(!currentUser) {
          alert("You must be logged in to save.");
          return;
      }

      localStorage.setItem('lpg_ledger_v19', JSON.stringify(store));
      
      saveLock = true;
      try {
        await ledgerDocRef.set({
          data: store,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedBy: CLIENT_ID
        });
      } catch(e){
        console.error('Failed to save to Firestore:', e);
        alert("Save Failed: " + e.message);
      } finally {
        setTimeout(()=> { saveLock = false; }, 400);
      }
    }

    function repairIdsInStore(data) {
        const allIds = new Set();
        Object.keys(data).forEach(key => {
            if (data[key].transactions) {
                data[key].transactions.forEach(t => {
                    if (!t.id || allIds.has(t.id)) {
                        t.id = Date.now() + Math.floor(Math.random() * 100000);
                    }
                    allIds.add(t.id);
                    if(t.date && typeof t.date === 'string' && t.date.startsWith("2S025")){
                        t.date = t.date.replace("2S025", "2025");
                    }
                });
            }
        });
    }

    function ymd(date){ return (date ?? '').split('T')[0]; }
    function ym(date){ const d = new Date(date); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
    function asDate(v){ return new Date(v); }
    function ensureMonth(key){ if(!store[key]) store[key] = { transactions: [] }; if(!store[key].transactions) store[key].transactions = []; }
    function nextId(){ return Date.now() + Math.floor(Math.random() * 1000); }

    function findTransactionById(id){ for(const key of Object.keys(store)){ const bucket = store[key]; if(bucket && bucket.transactions){ const tx = bucket.transactions.find(t=>t.id===id); if(tx) return { transaction: tx, key }; } } return { transaction: null, key: null }; }

    function bindCalc({qtyEl, unitEl, totalEl}){
      function n(v){ return Number(v ?? 0); }
      function fmt(v){ return isFinite(v) ? Math.round(v) : 0; }
      function onQtyOrUnit(){ const q=n(qtyEl.value), u=n(unitEl.value); if(q>0 && u>=0) totalEl.value = fmt(q*u); }
      function onTotal(){ const q=n(qtyEl.value), t=n(totalEl.value); if(q>0) unitEl.value = fmt(t/q); }
      qtyEl.addEventListener('input', onQtyOrUnit); unitEl.addEventListener('input', onQtyOrUnit); totalEl.addEventListener('input', onTotal);
    }

    function computeFIFO(cutoffDate){
      const all = [];
      Object.entries(store).forEach(([key,bucket])=>{ (bucket.transactions||[]).forEach(t=>{ if(!t.date) return; if(asDate(t.date) <= cutoffDate) all.push(t); }); });

      all.sort((a,b)=> {
          const dateA = new Date(a.date);
          const dateB = new Date(b.date);
          const dayA = ymd(a.date);
          const dayB = ymd(b.date);

          if(dayA !== dayB) {
              return dateA - dateB;
          }
          if(a.type === 'buy' && b.type !== 'buy') return -1;
          if(a.type !== 'buy' && b.type === 'buy') return 1;
          return dateA - dateB || (a.id??0)-(b.id??0);
      });

      const layers=[];
      const salesCOGS=new Map();
      const stockLevelAfter=new Map();

      for(const t of all){
        if(t.type==='buy'){
            const unit = (t.cylinders>0)? (t.totalPrice/t.cylinders):0;
            layers.push({qty:t.cylinders, unitCost:unit, meta:{id:t.id,date:t.date}});
        }
        else if(t.type==='sell'){
            let need=t.cylinders, cogs=0;
            while(need>0 && layers.length){
                const L=layers[0]; const take=Math.min(need, L.qty);
                cogs += take * L.unitCost; L.qty -= take; need -= take;
                if(L.qty===0) layers.shift();
            }
            salesCOGS.set(t.id, Math.round(cogs));
        }
        const currentStock = layers.reduce((s,L)=> s+L.qty, 0);
        stockLevelAfter.set(t.id, currentStock);
      }
      const remaining = layers.reduce((s,L)=> s+L.qty,0);
      const remainingValue = Math.round(layers.reduce((s,L)=> s+L.qty*L.unitCost,0));
      return { salesCOGS, remaining, remainingValue, stockLevelAfter };
    }

    function summarizeForKey(key, filteredTx){
      ensureMonth(key); const bucket = store[key];
      const [year,month] = key.split('-').map(Number);
      const cutoff=new Date(year,month,0,23,59,59,999);
      const fifo = computeFIFO(cutoff);
      const tx = filteredTx ?? [...bucket.transactions];

      let totalBoughtCylinders=0,totalBoughtValue=0,totalSoldCylinders=0,totalSaleRevenue=0,totalExpenses=0,totalCOGS=0;

      for(const t of tx){
        if(t.type==='buy'){ totalBoughtCylinders += Number(t.cylinders||0); totalBoughtValue += Number(t.totalPrice||0); }
        else if(t.type==='sell'){
            totalSoldCylinders += Number(t.cylinders||0);
            totalSaleRevenue += Number(t.totalPrice||0);
            const computed = fifo.salesCOGS.get(t.id);
            const c = (computed !== undefined) ? computed : Number(t.cogs ?? 0);
            totalCOGS += Number(c||0);
        }
        else if(t.type==='expense'){ totalExpenses += Number(t.totalPrice||0); }
      }
      const grossProfit = totalSaleRevenue - totalCOGS - totalExpenses;
      return { totalBoughtCylinders, totalBoughtValue, totalSoldCylinders, totalSaleRevenue, totalCOGS, totalExpenses, grossProfit, remainingCylinders: fifo.remaining, remainingStockValue: fifo.remainingValue };
    }

    function generateDailyBreakdown(transactions, salesCOGSMap){
        const dailyData = {};
        for(const t of transactions){
            const day = ymd(t.date);
            if(!dailyData[day]) dailyData[day] = { soldCyl:0, saleRevenue:0, cogs:0, expenses:0, purchasesCyl:0, purchaseValue:0 };
            if(t.type==='sell'){
                dailyData[day].soldCyl += Number(t.cylinders||0);
                dailyData[day].saleRevenue += Number(t.totalPrice||0);
                dailyData[day].cogs += Number(salesCOGSMap.get(t.id) || 0);
            }
            else if(t.type==='expense'){ dailyData[day].expenses += Number(t.totalPrice||0); }
            else if(t.type==='buy'){ dailyData[day].purchasesCyl += Number(t.cylinders||0); dailyData[day].purchaseValue += Number(t.totalPrice||0); }
        }
        const sorted = Object.keys(dailyData).sort();
        return sorted.map(date=>{
            const d=dailyData[date]; const grossProfit = d.saleRevenue - d.cogs; const netProfit = grossProfit - d.expenses;
            return { date, ...d, grossProfit, netProfit };
        });
    }

    const monthSelect = document.getElementById('monthSelect'); const yearSelect = document.getElementById('yearSelect');

    function initMonthYearOptions(){
        const years = new Set(); const now = new Date(); years.add(now.getFullYear());
        for(let y=2024; y<=2030; y++) {
            years.add(y);
        }
        Object.keys(store).forEach(k=>{ years.add(Number(k.split('-')[0])); });
        const ys = Array.from(years).sort((a,b)=>a-b);
        yearSelect.innerHTML = ys.map(y=>`<option value="${y}">${y}</option>`).join('');
        monthSelect.innerHTML = MONTHS.map((m,i)=>`<option value="${i+1}">${m}</option>`).join('');
        const curY = now.getFullYear(); const curM = now.getMonth()+1; yearSelect.value = curY; monthSelect.value = String(curM);
        const keys = Object.keys(store); if(keys.length===1){ const [y,m]=keys[0].split('-'); yearSelect.value = y; monthSelect.value = String(Number(m)); }
    }

    function activeKey(){ return `${yearSelect.value}-${String(monthSelect.value).padStart(2,'0')}`; }
    function table(headers, rowsHtml, tfootHtml=''){ return `<table><thead><tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead><tbody>${rowsHtml||''}</tbody>${tfootHtml}</table>`; }
    function isFilterActive(){ return !!(document.getElementById('filterDateFrom').value || document.getElementById('filterDateTo').value || document.getElementById('filterText').value); }

    function applyFilters(transactions){
        const dateFrom = document.getElementById('filterDateFrom').value;
        const dateTo = document.getElementById('filterDateTo').value;
        const text = document.getElementById('filterText').value.toLowerCase();
        let filtered = [...transactions];
        if(dateFrom) filtered = filtered.filter(t=> t.date.split('T')[0] >= dateFrom);
        if(dateTo) filtered = filtered.filter(t=> t.date.split('T')[0] <= dateTo);
        // Updated search filter to check Customer and Supplier names
        if(text) filtered = filtered.filter(t=> ((t.note||'') + (t.customer||'') + (t.supplier||'') + (t.type==='buy' ? '' : '')).toLowerCase().includes(text));
        return filtered;
    }

    function render(){
      try {
        const key = activeKey(); ensureMonth(key); const allTxForMonth = [...store[key].transactions];
        const [y,m] = key.split('-').map(Number); const fifo = computeFIFO(new Date(y,m,0,23,59,59,999));

        const filteredTx = applyFilters(allTxForMonth);

        const purchases = filteredTx.filter(t=>t.type==='buy').sort((a,b)=> asDate(a.date)-asDate(b.date));
        const sales = filteredTx.filter(t=>t.type==='sell').sort((a,b)=> asDate(a.date)-asDate(b.date));
        const expenses = filteredTx.filter(t=>t.type==='expense').sort((a,b)=> asDate(a.date)-asDate(b.date));
        
        // --- Purchases table ---
        let pRows = ''; let pTotalCyl=0, pTotalAmt=0;
        purchases.forEach(p=>{ 
            const unit = (p.cylinders>0) ? Math.round((p.totalPrice||0)/p.cylinders) : 0; 
            pTotalCyl += Number(p.cylinders||0); pTotalAmt += Number(p.totalPrice||0); 
            // Added Supplier Column
            pRows += `<tr><td>${ymd(p.date)}</td><td>${p.supplier || '-'}</td><td>${p.cylinders}</td><td class="right">${unit.toLocaleString()}</td><td class="right">${Number(p.totalPrice||0).toLocaleString()}</td>
            <td>
              <button class="ghost small" onclick="editEntry(${p.id})">Edit</button>
              <button class="ghost small" style="color:var(--danger); border-color:var(--danger); margin-left:4px;" onclick="deleteEntry(${p.id})">Delete</button>
            </td></tr>`; 
        });
        // Added extra empty cell in footer for supplier column
        const pFoot = `<tfoot><tr><td>Total</td><td></td><td>${pTotalCyl}</td><td class="right">Avg: ${ (pTotalCyl>0 ? Math.round(pTotalAmt/pTotalCyl).toLocaleString() : '0') }</td><td class="right">${pTotalAmt.toLocaleString()}</td><td></td></tr></tfoot>`;
        document.getElementById('purchaseTable').innerHTML = table(['Date','Supplier','Cylinders','Unit Price','Total Price','Actions'], pRows, pFoot);

        // --- Sales table (Modified with Stock Rem) ---
        let sRows=''; let sTotalCyl=0, sTotalSale=0, sTotalCOGS=0, sTotalProfit=0;
        sales.forEach(s=>{
          const computed = fifo.salesCOGS.get(s.id);
          const cogs = Number((computed !== undefined) ? computed : (s.cogs ?? 0));
          const profit = Number(s.totalPrice||0) - cogs;
          sTotalCyl += Number(s.cylinders||0);
          sTotalSale += Number(s.totalPrice||0);
          sTotalCOGS += Number(cogs||0);
          sTotalProfit += Number(profit||0);
          const stockRem = fifo.stockLevelAfter.get(s.id) || 0;
          // Added Customer Column
          sRows += `<tr><td>${ymd(s.date)}</td><td>${s.customer || '-'}</td><td>${s.cylinders}</td><td class="right">${Number(s.totalPrice||0).toLocaleString()}</td><td class="right">${Number(cogs).toLocaleString()}</td><td class="right" style="font-weight:600;color:${profit>=0? 'var(--ok)':'var(--danger)'}">${profit.toLocaleString()}</td><td style="font-weight:bold; color:var(--brand);">${stockRem}</td><td>${s.note||''}</td>
          <td>
              <button class="ghost small" onclick="editEntry(${s.id})">Edit</button>
              <button class="ghost small" style="color:var(--danger); border-color:var(--danger); margin-left:4px;" onclick="deleteEntry(${s.id})">Delete</button>
          </td></tr>`;
        });
        // Added extra empty cell in footer for customer column
        const sFoot = `<tfoot><tr><td>Total</td><td></td><td>${sTotalCyl}</td><td class="right">${sTotalSale.toLocaleString()}</td><td class="right">${sTotalCOGS.toLocaleString()}</td><td class="right">${sTotalProfit.toLocaleString()}</td><td></td><td></td><td></td></tr></tfoot>`;
        document.getElementById('salesTable').innerHTML = table(['Date','Customer','Cylinders','Sale','COGS','Profit','Stock Rem.','Note','Actions'], sRows, sFoot);

        // --- Expenses table ---
        let eRows=''; let eTotal=0;
        expenses.forEach(e=>{ 
            eTotal += Number(e.totalPrice||0); 
            eRows += `<tr><td>${ymd(e.date)}</td><td>${e.note||''}</td><td class="right">${Number(e.totalPrice||0).toLocaleString()}</td>
            <td>
              <button class="ghost small" onclick="editEntry(${e.id})">Edit</button>
              <button class="ghost small" style="color:var(--danger); border-color:var(--danger); margin-left:4px;" onclick="deleteEntry(${e.id})">Delete</button>
            </td></tr>`; 
        });
        const eFoot = `<tfoot><tr><td>Total</td><td></td><td class="right">${eTotal.toLocaleString()}</td><td></td></tr></tfoot>`;
        document.getElementById('expensesTable').innerHTML = table(['Date','Description','Amount','Actions'], eRows, eFoot);

        // --- Summary box ---
        const monthSummaryAll = summarizeForKey(key, null);
        const monthSummaryFiltered = summarizeForKey(key, filteredTx);
        let summaryHtml = `<div class="summary-list">`;
        if(isFilterActive()){
          summaryHtml += `<div style="padding:6px;border-radius:8px;background:#fff;">
            <div class="summary-item"><span>Filtered - Sales Revenue</span><strong class="right">${monthSummaryFiltered.totalSaleRevenue.toLocaleString()}</strong></div>
            <div class="summary-item"><span>Filtered - COGS</span><strong class="right">${monthSummaryFiltered.totalCOGS.toLocaleString()}</strong></div>
            <div class="summary-item"><span>Filtered - Expenses</span><strong class="right">${monthSummaryFiltered.totalExpenses.toLocaleString()}</strong></div>
            <div class="summary-item final-profit"><span>Filtered - Gross Profit</span><strong style="color:${monthSummaryFiltered.grossProfit>=0? 'var(--ok)':'var(--danger)'}">${monthSummaryFiltered.grossProfit.toLocaleString()}</strong></div>
          </div><hr>`;
        }
        summaryHtml += `<div style="padding:6px;border-radius:8px;background:#fff;">
            <div class="summary-item"><span>Month - Sales Revenue</span><strong class="right">${monthSummaryAll.totalSaleRevenue.toLocaleString()}</strong></div>
            <div class="summary-item"><span>Month - COGS (FIFO)</span><strong class="right">${monthSummaryAll.totalCOGS.toLocaleString()}</strong></div>
            <hr>
            <div class="summary-item"><span>Month - Expenses</span><strong class="right">${monthSummaryAll.totalExpenses.toLocaleString()}</strong></div>
            <div class="summary-item final-profit"><span>Month - Gross Profit</span><strong style="color:${monthSummaryAll.grossProfit>=0? 'var(--ok)':'var(--danger)'}">${monthSummaryAll.grossProfit.toLocaleString()}</strong></div>
            <hr>
            <div class="summary-item"><span>üì¶ Remaining Cylinders</span><strong>${monthSummaryAll.remainingCylinders}</strong></div>
            <div class="summary-item"><span>üì¶ Stock Value (FIFO)</span><strong class="right">${monthSummaryAll.remainingStockValue.toLocaleString()}</strong></div>
          </div>`;
        summaryHtml += `</div>`;
        document.getElementById('summaryBox').innerHTML = summaryHtml;

        // --- Daily view ---
        const dailyBreakdown = generateDailyBreakdown(allTxForMonth, fifo.salesCOGS);
        const totals = { soldCyl:0, saleRevenue:0, cogs:0, grossProfit:0, expenses:0, netProfit:0 };
        const dailyRowsHtml = dailyBreakdown.map(day=>{ totals.soldCyl += day.soldCyl; totals.saleRevenue += day.saleRevenue; totals.cogs += day.cogs; totals.grossProfit += day.grossProfit; totals.expenses += day.expenses; totals.netProfit += day.netProfit; const grossColor = day.grossProfit>=0? 'var(--ok)': 'var(--danger)'; const netColor = day.netProfit>=0? 'var(--ok)':'var(--danger)'; const rowClass = day.netProfit>=0? 'daily-positive' : 'daily-negative'; return `<tr data-day="${day.date}" class="${rowClass}" title="Click to view details for ${day.date}"><td>${day.date}</td><td>${day.soldCyl}</td><td class="right">${day.saleRevenue.toLocaleString()}</td><td class="right">${day.cogs.toLocaleString()}</td><td class="right" style="color:${grossColor};">${day.grossProfit.toLocaleString()}</td><td class="right">${day.expenses.toLocaleString()}</td><td class="right" style="font-weight:bold;color:${netColor};">${day.netProfit.toLocaleString()}</td></tr>`; }).join('');
        const totalNetColor = totals.netProfit>=0? 'var(--ok)': 'var(--danger)';
        const totalRowHtml = `<tfoot><tr><td>Total</td><td>${totals.soldCyl}</td><td class="right">${totals.saleRevenue.toLocaleString()}</td><td class="right">${totals.cogs.toLocaleString()}</td><td class="right">${totals.grossProfit.toLocaleString()}</td><td class="right">${totals.expenses.toLocaleString()}</td><td class="right" style="color:${totalNetColor};">${totals.netProfit.toLocaleString()}</td></tr></tfoot>`;
        document.getElementById('dailyTable').innerHTML = table(['Date','Cyl. Sold','Total Sale','Total COGS','Gross Profit','Expenses','Net Profit'], dailyRowsHtml, totalRowHtml);
      } catch (err) {
        console.error("Render error handled:", err);
      }
    }

    function getEntriesForDate(dayString){ const key = activeKey(); ensureMonth(key); const allTxForMonth = [...store[key].transactions]; const list = allTxForMonth.filter(t=> ymd(t.date) === dayString).sort((a,b)=> asDate(a.date)-asDate(b.date) || (a.id??0)-(b.id??0)); return list; }

    function renderDetailsHtmlForDay(dayString){ const entries = getEntriesForDate(dayString); if(entries.length===0) return `<div class="note">No entries for ${dayString}</div>`;
      const [year, month] = activeKey().split('-').map(Number); const cutoff = new Date(`${dayString}T23:59:59`); const fifo = computeFIFO(cutoff);
      let rows = entries.map(e=>{
          const timePart = e.date.includes('T')? e.date.split('T')[1] : '';
          let cogs = '';
          if(e.type==='sell'){
              const val = fifo.salesCOGS.get(e.id);
              cogs = (val !== undefined) ? val : (e.cogs ?? 0);
          }
          let typeLabel = '';
          if(e.type==='buy') typeLabel='Purchase';
          else if(e.type==='sell') typeLabel='Sale';
          else if(e.type==='expense') typeLabel='Expense';

          let extraInfo = '';
          if(e.type==='sell' && e.customer) extraInfo = ` | Cust: ${e.customer}`;
          if(e.type==='buy' && e.supplier) extraInfo = ` | Sup: ${e.supplier}`;

          return `<tr><td style="width:130px">${ymd(e.date)} ${timePart}</td><td style="width:110px">${typeLabel}</td><td style="width:80px">${e.cylinders||'-'}</td><td style="width:110px;text-align:right">${Number(e.totalPrice||0).toLocaleString()}</td><td style="width:110px;text-align:right">${cogs!==''? Number(cogs).toLocaleString():''}</td><td>${(e.note||'')}${extraInfo}</td></tr>`;
      }).join('');
      return `<table class="details-table"><thead><tr><th>Date / Time</th><th>Type</th><th>Qty</th><th>Total</th><th>COGS</th><th>Note</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    document.addEventListener('click', function(ev){ const tr = ev.target.closest && ev.target.closest('tr[data-day]'); if(!tr) return; const tbody = tr.parentElement; if(!tbody) return; const next = tr.nextElementSibling; if(next && next.classList && next.classList.contains('expanded-row')){ next.remove(); return; } const existing = tbody.querySelectorAll('tr.expanded-row'); existing.forEach(r=> r.remove()); const day = tr.getAttribute('data-day'); const detailsHtml = renderDetailsHtmlForDay(day); const expandedTr = document.createElement('tr'); expandedTr.className = 'expanded-row'; const td = document.createElement('td'); td.colSpan = 7; td.innerHTML = detailsHtml; expandedTr.appendChild(td); tr.parentNode.insertBefore(expandedTr, tr.nextSibling); expandedTr.scrollIntoView({ behavior:'smooth', block:'nearest' }); });

    document.querySelectorAll('nav.tabs button').forEach(btn=>{ btn.addEventListener('click', ()=>{ document.querySelectorAll('nav.tabs button').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); const t = btn.dataset.tab; document.querySelectorAll('main > section').forEach(s=> s.classList.add('hidden')); document.getElementById(`tab-${t}`).classList.remove('hidden'); }); });

    monthSelect.addEventListener('change', render); yearSelect.addEventListener('change', render);

    function clearForms(){
        document.getElementById('pDate').value=''; document.getElementById('pCyl').value=''; document.getElementById('pUnit').value=''; document.getElementById('pTotal').value=''; document.getElementById('pSupplier').value='';
        document.getElementById('sDate').value=''; document.getElementById('sCyl').value=''; document.getElementById('sUnit').value=''; document.getElementById('sTotal').value=''; document.getElementById('sNote').value=''; document.getElementById('sCustomer').value='';
        document.getElementById('eDate').value=''; document.getElementById('eNote').value=''; document.getElementById('eAmount').value='';
        editingId = null;
    }
    function toggle(el, show){ el.classList.toggle('hidden', !show); }

    document.getElementById('addPurchase').onclick = ()=>{ clearForms(); toggle(document.getElementById('purchaseForm'), true); };
    document.getElementById('pCancel').onclick = ()=>{ toggle(document.getElementById('purchaseForm'), false); clearForms(); };
    document.getElementById('addSale').onclick = ()=>{ clearForms(); toggle(document.getElementById('saleForm'), true); };
    document.getElementById('sCancel').onclick = ()=>{ toggle(document.getElementById('saleForm'), false); clearForms(); };
    document.getElementById('addExpense').onclick = ()=>{ clearForms(); toggle(document.getElementById('expenseForm'), true); };
    document.getElementById('eCancel').onclick = ()=>{ toggle(document.getElementById('expenseForm'), false); clearForms(); };

    bindCalc({ qtyEl: document.getElementById('pCyl'), unitEl: document.getElementById('pUnit'), totalEl: document.getElementById('pTotal') });
    bindCalc({ qtyEl: document.getElementById('sCyl'), unitEl: document.getElementById('sUnit'), totalEl: document.getElementById('sTotal') });

    let editingId = null;
    function editEntry(id){
      clearForms(); const { transaction, key } = findTransactionById(id); if(!transaction) return alert('Error: Entry not found.'); editingId = id;
      if(transaction.type==='buy'){
          document.getElementById('pDate').value = transaction.date; document.getElementById('pCyl').value = transaction.cylinders; document.getElementById('pTotal').value = transaction.totalPrice; 
          document.getElementById('pSupplier').value = transaction.supplier || ''; 
          document.getElementById('pUnit').dispatchEvent(new Event('input')); toggle(document.getElementById('purchaseForm'), true);
      } else if(transaction.type==='sell'){
          document.getElementById('sDate').value = transaction.date; document.getElementById('sCyl').value = transaction.cylinders; document.getElementById('sTotal').value = transaction.totalPrice; document.getElementById('sNote').value = transaction.note||''; 
          document.getElementById('sCustomer').value = transaction.customer || '';
          document.getElementById('sTotal').dispatchEvent(new Event('input')); toggle(document.getElementById('saleForm'), true);
      } else if(transaction.type==='expense'){
          document.getElementById('eDate').value = transaction.date; document.getElementById('eNote').value = transaction.note||''; document.getElementById('eAmount').value = transaction.totalPrice; toggle(document.getElementById('expenseForm'), true);
      }
    }

    async function deleteEntry(id) {
        if(!confirm("Are you sure you want to delete this entry?")) return;
        const { transaction, key } = findTransactionById(id);
        if(transaction && key) {
            const bucket = store[key];
            const idx = bucket.transactions.indexOf(transaction);
            if(idx > -1) {
                bucket.transactions.splice(idx, 1);
                await saveStore();
                render();
            }
        }
    }

    document.getElementById('btnToggleFilter').onclick = () => {
        const el = document.getElementById('filter-bar');
        el.classList.toggle('hidden');
    };
    
    document.getElementById('btnApplyFilter').onclick = render;
    
    document.getElementById('btnResetFilter').onclick = () => {
        document.getElementById('filterDateFrom').value = '';
        document.getElementById('filterDateTo').value = '';
        document.getElementById('filterText').value = '';
        render();
    };

    document.getElementById('btnPrint').onclick = () => {
        window.print();
    };


    document.getElementById('pSave').onclick = async ()=>{
      const d = document.getElementById('pDate').value || new Date().toISOString();
      const cyl = Number(document.getElementById('pCyl').value || 0);
      const total = Number(document.getElementById('pTotal').value || 0);
      const supplier = document.getElementById('pSupplier').value || '';

      if(!cyl || !total){ alert('Enter cylinders and total.'); return; }
      const key = `${new Date(d).getFullYear()}-${String(new Date(d).getMonth()+1).padStart(2,'0')}`;
      ensureMonth(key);
      if(editingId){
        const { transaction } = findTransactionById(editingId);
        transaction.date = d; transaction.type='buy'; transaction.cylinders = cyl; transaction.totalPrice = total; transaction.supplier = supplier;
      } else {
        const id = nextId();
        store[key].transactions.push({ id, date: d, type: 'buy', cylinders: cyl, totalPrice: total, supplier });
      }
      saveStore(); toggle(document.getElementById('purchaseForm'), false); clearForms();
    };

    document.getElementById('sSave').onclick = async ()=>{
      const d = document.getElementById('sDate').value || new Date().toISOString();
      const cyl = Number(document.getElementById('sCyl').value || 0);
      const total = Number(document.getElementById('sTotal').value || 0);
      const note = document.getElementById('sNote').value || '';
      const customer = document.getElementById('sCustomer').value || '';

      if(!cyl || !total){ alert('Enter cylinders and total.'); return; }
      const key = `${new Date(d).getFullYear()}-${String(new Date(d).getMonth()+1).padStart(2,'0')}`;
      ensureMonth(key);
      if(editingId){
        const { transaction } = findTransactionById(editingId);
        transaction.date = d; transaction.type='sell'; transaction.cylinders = cyl; transaction.totalPrice = total; transaction.note = note; transaction.customer = customer;
      } else {
        const id = nextId();
        store[key].transactions.push({ id, date: d, type: 'sell', cylinders: cyl, totalPrice: total, note, customer });
      }
      saveStore(); toggle(document.getElementById('saleForm'), false); clearForms();
    };

    document.getElementById('eSave').onclick = async ()=>{
      const d = document.getElementById('eDate').value || new Date().toISOString();
      const amt = Number(document.getElementById('eAmount').value || 0);
      const note = document.getElementById('eNote').value || '';
      if(!amt){ alert('Enter amount.'); return; }
      const key = `${new Date(d).getFullYear()}-${String(new Date(d).getMonth()+1).padStart(2,'0')}`;
      ensureMonth(key);
      if(editingId){
        const { transaction } = findTransactionById(editingId);
        transaction.date = d; transaction.type='expense'; transaction.totalPrice = amt; transaction.note = note;
      } else {
        const id = nextId();
        store[key].transactions.push({ id, date: d, type: 'expense', cylinders: 0, totalPrice: amt, note });
      }
      saveStore(); toggle(document.getElementById('expenseForm'), false); clearForms();
    };
    
    document.getElementById('btnExport').onclick = ()=>{
      const dataStr = JSON.stringify(store, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'ledger-export.json'; a.click(); URL.revokeObjectURL(url);
    };

    document.getElementById('btnImport').onclick = ()=> document.getElementById('fileInput').click();
    document.getElementById('fileInput').addEventListener('change', async (ev)=>{
      const f = ev.target.files[0]; if(!f) return;
      try {
        const txt = await f.text(); const imported = JSON.parse(txt || '{}');
        if(typeof imported !== 'object'){ alert('Invalid import file'); return; }
        store = imported;
        repairIdsInStore(store);
        await saveStore();
        initMonthYearOptions();
        render();
        alert('Imported and saved to cloud.');
      } catch(e){ alert('Import failed: ' + e.message); }
    });

    // Initial fixed data
    function getFixedInitialData() {
        return {
          "2025-11": {
            "transactions": [
              {"id": 11, "date": "2025-10-29", "type": "buy", "cylinders": 6, "totalPrice": 55836},
              {"id": 14, "date": "2025-11-01", "type": "sell", "cylinders": 3, "totalPrice": 32400, "cogs": 27918},
              {"id": 23, "date": "2025-11-01T15:27", "type": "expense", "cylinders": 0, "totalPrice": 120, "note": "Faqeer"},
              {"id": 13, "date": "2025-11-01T21:36", "type": "sell", "cylinders": 2, "totalPrice": 18612, "cogs": 18612, "note": "Rashid Ko Diye", "customer": "Rashid"},
              {"id": 16, "date": "2025-11-02", "type": "buy", "cylinders": 11, "totalPrice": 101508},
              {"id": 18, "date": "2025-11-02", "type": "sell", "cylinders": 3, "totalPrice": 32400, "cogs": 27762}
            ]
          }
        };
    }
    
    // Fallback load
    setTimeout(()=> {
      if(Object.keys(store).length === 0) {
        initMonthYearOptions();
        render();
      }
    }, 600);
  </script>
</body>
</html>